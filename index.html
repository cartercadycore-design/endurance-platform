<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coreformance</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=DM+Mono:wght@400;500&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════
   DESIGN TOKENS
═══════════════════════════════════════ */
:root {
  --bg:#f7f6f3; --bg2:#f0ede8;
  --sur:#ffffff; --sur2:#faf9f7; --sur3:#f4f2ee;
  --bd:#e8e4dd; --bd2:#d4cfc7;
  --t1:#1a1814; --t2:#6b6557; --t3:#a39d93; --t4:#c8c2b8;
  --g:#1a9e6e; --g1:#edf7f3; --g2:rgba(26,158,110,0.12); --g3:rgba(26,158,110,0.22);
  --a:#d97706; --a1:#fef8ee; --a2:rgba(217,119,6,0.12);
  --r:#dc3545; --r1:#fff0f1; --r2:rgba(220,53,69,0.10);
  --b:#2563eb; --b1:#eff4ff; --b2:rgba(37,99,235,0.10);
  --gold:#b8860b; --gold1:#fdf8ec;
  --topbar:52px; --sidebar:220px;
  --rad:14px; --rad-s:8px; --rad-xs:6px;
  --sh:0 1px 3px rgba(26,24,20,0.06),0 4px 16px rgba(26,24,20,0.04);
  --sh-md:0 2px 8px rgba(26,24,20,0.08),0 8px 32px rgba(26,24,20,0.06);
  --sh-lg:0 4px 16px rgba(26,24,20,0.10),0 16px 48px rgba(26,24,20,0.08);
  /* Mode transition */
  --mode-dur:0.28s;
}
/* Coach mode — environment inverts */
body.coach-mode {
  --bg:#f2f4f9; --bg2:#eaecf4;
  --sur:#ffffff; --sur2:#f6f7fb; --sur3:#eef0f7;
  --bd:#dde2ef; --bd2:#c8d0e4;
}

html { scroll-behavior:smooth; }
*, *::before, *::after { box-sizing:border-box; }
body {
  background:var(--bg);
  color:var(--t1);
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:14px;
  line-height:1.55;
  -webkit-font-smoothing:antialiased;
  transition:background var(--mode-dur), color var(--mode-dur);
  margin:0;
}

/* ── TYPOGRAPHY ── */
.serif { font-family:'DM Serif Display',serif; }
.mono  { font-family:'DM Mono',monospace; }

/* ── SCROLLBAR ── */
::-webkit-scrollbar { width:5px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--bd2); border-radius:3px; }

/* ═══════════════════════════════════════
   TOPBAR
═══════════════════════════════════════ */
.topbar {
  position:fixed; top:0; left:0; right:0; z-index:500;
  height:var(--topbar);
  background:rgba(247,246,243,0.94);
  backdrop-filter:blur(12px);
  border-bottom:1px solid var(--bd);
  display:none;
  align-items:center;
  padding:0 20px 0 0;
  gap:0;
  transition:background var(--mode-dur);
}
body.coach-mode .topbar { background:rgba(242,244,249,0.94); }
.tb-logo {
  width:var(--sidebar);
  display:flex; align-items:center;
  padding:0 20px;
  flex-shrink:0;
  gap:8px;
}
.tb-logo-mark {
  width:28px; height:28px;
  background:var(--t1);
  border-radius:8px;
  display:flex; align-items:center; justify-content:center;
  flex-shrink:0;
  transition:background var(--mode-dur);
}
body.coach-mode .tb-logo-mark { background:var(--b); }
.tb-logo-mark svg { width:16px; height:16px; fill:white; }
.tb-logo-name { font-weight:800; font-size:15px; letter-spacing:-.3px; color:var(--t1); }
.tb-logo-dot { color:var(--g); transition:color var(--mode-dur); }
body.coach-mode .tb-logo-dot { color:var(--b); }
.tb-center { flex:1; display:flex; align-items:center; gap:8px; padding:0 16px; }
.tb-ws { display:flex; flex-direction:column; gap:1px; }
.tb-ws-name { font-weight:700; font-size:13px; color:var(--t1); line-height:1.2; }
.tb-ws-sub  { font-size:11px; color:var(--t3); font-family:'DM Mono',monospace; line-height:1.2; }
.tb-right { display:flex; align-items:center; gap:10px; margin-left:auto; }
/* Readiness pill in topbar */
.tb-readiness {
  display:flex; align-items:center; gap:6px;
  background:var(--sur); border:1px solid var(--bd);
  border-radius:20px; padding:4px 12px 4px 8px;
  font-size:11px; font-weight:600;
  cursor:default;
}
.tb-ready-dot {
  width:7px; height:7px; border-radius:50%;
  background:var(--g);
  box-shadow:0 0 0 2px var(--g2);
}
.tb-ready-dot.moderate { background:var(--a); box-shadow:0 0 0 2px var(--a2); }
.tb-ready-dot.fatigued { background:var(--r); box-shadow:0 0 0 2px var(--r2); }
.tb-ready-label { color:var(--t2); }
.uavi {
  width:30px; height:30px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:12px; font-weight:700;
  cursor:pointer;
  flex-shrink:0;
}
.uavi.a { background:var(--g2); color:var(--g); }
.uavi.c { background:var(--b2); color:var(--b); }

/* ═══════════════════════════════════════
   SIDEBAR
═══════════════════════════════════════ */
.sidebar {
  position:fixed; top:var(--topbar); left:0; bottom:0;
  width:var(--sidebar);
  background:var(--sur);
  border-right:1px solid var(--bd);
  z-index:300;
  display:none; flex-direction:column;
  overflow-y:auto; overflow-x:hidden;
  transition:background var(--mode-dur), border-color var(--mode-dur);
}
.sidebar.visible { display:flex; }

/* Mode switcher */
.sb-mode-switch {
  padding:12px 12px 8px;
  border-bottom:1px solid var(--bd);
  flex-shrink:0;
}
.sb-mode-row { display:flex; background:var(--bg2); border-radius:var(--rad-s); padding:3px; gap:2px; }
.sb-mode-btn {
  flex:1; padding:5px 8px;
  border:none; border-radius:6px;
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:11px; font-weight:600;
  cursor:pointer;
  background:transparent; color:var(--t3);
  transition:all .18s;
  white-space:nowrap;
}
.sb-mode-btn.active { background:var(--sur); color:var(--t1); box-shadow:0 1px 3px rgba(0,0,0,0.08); }
.sb-mode-context {
  font-size:9px; color:var(--t4); font-family:'DM Mono',monospace;
  text-align:center; margin-top:6px; letter-spacing:.03em;
}
body.coach-mode .sb-mode-row { background:var(--bg2); }

/* Nav */
.sb-nav { flex:1; padding:8px 8px 0; overflow-y:auto; }
.sb-group { margin-bottom:4px; }
.sb-group-lbl {
  font-size:9px; font-weight:700; text-transform:uppercase;
  letter-spacing:.12em; color:var(--t4);
  padding:10px 8px 4px; display:block;
}
.sb-item {
  width:100%; display:flex; align-items:center; gap:9px;
  padding:7px 10px; border-radius:var(--rad-s);
  border:none; background:transparent;
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:13px; font-weight:500; color:var(--t2);
  cursor:pointer; text-align:left;
  transition:background .12s, color .12s;
  position:relative;
}
.sb-item:hover { background:var(--sur3); color:var(--t1); }
.sb-item.active { background:var(--bg2); color:var(--t1); font-weight:700; }
.sb-item .sb-icon { font-size:15px; flex-shrink:0; width:20px; text-align:center; }
.sb-item .sb-chevron { margin-left:auto; font-size:11px; color:var(--t4); transition:transform .15s; }
.sb-group.open .sb-chevron { transform:rotate(90deg); }
.sb-sub-items { display:none; padding:2px 0 4px 38px; }
.sb-group.open .sb-sub-items { display:block; }
.sb-sub-item {
  width:100%; display:block; padding:5px 10px;
  border:none; background:transparent;
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:12px; color:var(--t3);
  cursor:pointer; text-align:left; border-radius:6px;
  transition:color .12s, background .12s;
}
.sb-sub-item:hover { color:var(--t1); background:var(--sur3); }
.sb-sub-item.active { color:var(--t1); font-weight:600; }

/* Strain card (post-workout, dismissible) */
.strain-overlay {
  position:fixed; inset:0; background:rgba(26,24,20,0.45);
  backdrop-filter:blur(4px); z-index:3000;
  display:none; align-items:center; justify-content:center; padding:20px;
}
.strain-overlay.open { display:flex; }
.strain-card {
  background:var(--sur); border-radius:var(--rad);
  padding:28px 32px; max-width:380px; width:100%;
  box-shadow:var(--sh-lg); animation:fadeUp .2s ease both; text-align:center;
}
.sc-sport { font-size:40px; margin-bottom:12px; }
.sc-label { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.12em; color:var(--t4); font-family:'DM Mono',monospace; margin-bottom:6px; }
.sc-strain { font-size:28px; font-weight:800; margin-bottom:6px; }
.sc-strain.high { color:var(--r); }
.sc-strain.moderate { color:var(--a); }
.sc-strain.easy { color:var(--g); }
.sc-interp { font-size:13px; color:var(--t2); line-height:1.55; margin-bottom:18px; padding:10px 14px; background:var(--sur3); border-radius:8px; }
.sc-meta { font-size:11px; color:var(--t4); font-family:'DM Mono',monospace; margin-bottom:20px; }
.sc-dismiss { width:100%; padding:10px; border-radius:var(--rad-s); background:var(--t1); color:#fff; border:none; font-size:14px; font-weight:700; cursor:pointer; font-family:'Plus Jakarta Sans',sans-serif; }
.sc-dismiss:hover { background:#2d2a25; }

/* Athlete preview modal (coach reads athlete's Today, read-only) */
.preview-overlay { position:fixed; inset:0; background:rgba(26,24,20,0.5); backdrop-filter:blur(4px); z-index:2500; display:none; align-items:center; justify-content:center; padding:20px; }
.preview-overlay.open { display:flex; }
.preview-box { background:var(--bg); border-radius:var(--rad); width:100%; max-width:680px; max-height:82vh; overflow-y:auto; box-shadow:var(--sh-lg); animation:fadeUp .2s ease both; position:relative; }
.preview-header { position:sticky; top:0; background:var(--sur); border-bottom:1px solid var(--bd); padding:14px 20px; display:flex; align-items:center; gap:12px; z-index:10; }
.preview-header-info { flex:1; }
.preview-header-name { font-weight:700; font-size:15px; }
.preview-header-sub { font-size:11px; color:var(--t3); font-family:'DM Mono',monospace; }
.preview-ro { font-size:10px; font-weight:700; color:var(--t4); background:var(--sur3); border:1px solid var(--bd); padding:3px 9px; border-radius:20px; font-family:'DM Mono',monospace; text-transform:uppercase; letter-spacing:.06em; }
.preview-close { background:none; border:none; cursor:pointer; color:var(--t4); font-size:20px; padding:4px; border-radius:6px; }
.preview-close:hover { background:var(--sur3); color:var(--t1); }
.preview-body { padding:24px; }
.preview-readiness { display:flex; align-items:center; gap:10px; background:var(--sur); border:1px solid var(--bd); border-radius:var(--rad-s); padding:10px 16px; margin-bottom:16px; }

/* Coach sidebar label (dedicated coaches — no toggle) */
.sb-coach-label { padding:14px 16px 10px; border-bottom:1px solid var(--bd); flex-shrink:0; display:none; }
.sb-coach-label-name { font-size:12px; font-weight:700; color:var(--t1); }
.sb-coach-label-role { font-size:9px; color:var(--b); font-family:'DM Mono',monospace; text-transform:uppercase; letter-spacing:.08em; margin-top:2px; }

/* Change coach link in sidebar footer (activated athletes) */
.sb-change-coach { display:none; font-size:11px; color:var(--t4); text-decoration:underline; text-underline-offset:2px; background:none; border:none; cursor:pointer; font-family:'Plus Jakarta Sans',sans-serif; padding:4px 0; margin-top:6px; }
.sb-change-coach:hover { color:var(--t2); }

/* Sidebar bottom */
.sb-bottom {
  border-top:1px solid var(--bd);
  padding:10px 12px 12px;
  flex-shrink:0;
}
.sb-user-row { display:flex; align-items:center; gap:8px; padding:4px 0; }
.sb-user-av {
  width:28px; height:28px; border-radius:50%;
  background:var(--g2); color:var(--g);
  display:flex; align-items:center; justify-content:center;
  font-size:11px; font-weight:700; flex-shrink:0;
}
body.coach-mode .sb-user-av { background:var(--b2); color:var(--b); }
.sb-user-name { font-weight:600; font-size:12px; color:var(--t1); }
.sb-user-role { font-size:10px; color:var(--t3); font-family:'DM Mono',monospace; }

/* ═══════════════════════════════════════
   MAIN APP CONTAINER
═══════════════════════════════════════ */
.app {
  margin-top:var(--topbar);
  margin-left:var(--sidebar);
  min-height:calc(100vh - var(--topbar));
  overflow-x:hidden;
}

/* ═══════════════════════════════════════
   SCREENS
═══════════════════════════════════════ */
.screen { display:none; padding:36px 44px; max-width:1100px; box-sizing:border-box; }
.screen.active { display:block; }
.screen.active > * { animation:fadeUp .24s cubic-bezier(.4,0,.2,1) both; }
.screen.active > *:nth-child(2) { animation-delay:.05s; }
.screen.active > *:nth-child(3) { animation-delay:.08s; }
.screen.active > *:nth-child(4) { animation-delay:.11s; }
@keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

/* ── PAGE HEADER ── */
.ph { margin-bottom:24px; }
.ph-row { display:flex; align-items:center; justify-content:space-between; gap:16px; }
.ph-t { font-size:22px; font-weight:800; color:var(--t1); letter-spacing:-.4px; margin-bottom:3px; }
.ph-s { font-size:13px; color:var(--t3); }
.ph-actions { display:flex; gap:8px; align-items:center; flex-shrink:0; }

/* ═══════════════════════════════════════
   BUTTONS
═══════════════════════════════════════ */
.btn {
  display:inline-flex; align-items:center; gap:6px;
  padding:7px 14px; border-radius:var(--rad-s);
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:13px; font-weight:600;
  border:none; cursor:pointer; transition:all .15s;
}
.btn-ghost { background:transparent; border:1.5px solid var(--bd); color:var(--t2); }
.btn-ghost:hover { border-color:var(--bd2); color:var(--t1); background:var(--sur3); }
.btn-b { background:var(--b); color:#fff; }
.btn-b:hover { background:#1d4ed8; }
.btn-g { background:var(--g); color:#fff; }
.btn-g:hover { background:#158a5d; }
.btn-dark { background:var(--t1); color:#fff; }
.btn-dark:hover { background:#2d2a25; }
.btn-sm { padding:5px 11px; font-size:12px; }
.btn-icon { padding:6px; border-radius:8px; }

/* ═══════════════════════════════════════
   CARDS & LAYOUT
═══════════════════════════════════════ */
.card { background:var(--sur); border:1px solid var(--bd); border-radius:var(--rad); box-shadow:var(--sh); padding:20px; }
.card-p { border:1.5px solid var(--bd2); }
.g2 { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
.g3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; }
.chip {
  display:inline-flex; align-items:center;
  padding:2px 8px; border-radius:20px;
  font-size:10px; font-weight:700;
  font-family:'DM Mono',monospace;
  letter-spacing:.02em;
}
.ca { background:var(--a1); color:var(--a); }
.cb { background:var(--b1); color:var(--b); }
.cg { background:var(--g1); color:var(--g); }
.cn { background:var(--sur3); color:var(--t3); }
.cr { background:var(--r1); color:var(--r); }

/* ═══════════════════════════════════════
   TOAST
═══════════════════════════════════════ */
.toast {
  position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(12px);
  background:var(--t1); color:#fff;
  padding:9px 20px; border-radius:20px;
  font-size:13px; font-weight:500;
  z-index:9000; opacity:0; pointer-events:none;
  transition:all .22s cubic-bezier(.4,0,.2,1);
  white-space:nowrap;
}
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* ═══════════════════════════════════════
   ── TODAY SCREEN ──
═══════════════════════════════════════ */
/* Readiness ambient strip */
.readiness-strip {
  display:flex; align-items:center; gap:10px;
  background:var(--sur); border:1px solid var(--bd);
  border-radius:var(--rad-s); padding:10px 16px;
  margin-bottom:20px;
}
.rs-dot {
  width:8px; height:8px; border-radius:50%;
  background:var(--g); box-shadow:0 0 0 3px var(--g2);
  flex-shrink:0;
}
.rs-dot.moderate { background:var(--a); box-shadow:0 0 0 3px var(--a2); }
.rs-dot.fatigued  { background:var(--r); box-shadow:0 0 0 3px var(--r2); }
.rs-status { font-weight:700; font-size:13px; color:var(--t1); }
.rs-detail { font-size:12px; color:var(--t3); margin-left:4px; }
.rs-source { margin-left:auto; font-size:10px; color:var(--t4); font-family:'DM Mono',monospace; letter-spacing:.04em; }
.rs-whoop { color:var(--t3); font-size:10px; }

/* Today hero layout */
.today-hero { display:grid; grid-template-columns:1fr 340px; gap:20px; margin-bottom:20px; }
@media (max-width:900px) { .today-hero { grid-template-columns:1fr; } }

/* Execution score card */
.exec-score-card {
  background:var(--sur); border:1px solid var(--bd);
  border-radius:var(--rad); box-shadow:var(--sh);
  padding:20px 24px;
  display:flex; flex-direction:column; justify-content:space-between;
}
.esc-label { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--t4); margin-bottom:8px; font-family:'DM Mono',monospace; }
.esc-number {
  font-size:64px; font-weight:800; color:var(--t1);
  letter-spacing:-3px; line-height:1; margin-bottom:6px;
}
.esc-number span { font-size:24px; color:var(--t3); letter-spacing:-1px; }
.esc-trend { font-size:12px; color:var(--g); font-weight:600; margin-bottom:16px; }
.esc-bars { display:flex; align-items:flex-end; gap:3px; height:32px; }
.esc-bar { flex:1; border-radius:2px; background:var(--g2); min-width:6px; }
.esc-bar.active { background:var(--g); }
.esc-meta { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:16px; }
.esc-m { background:var(--sur3); border-radius:8px; padding:8px 10px; }
.esc-m-v { font-size:16px; font-weight:800; color:var(--t1); }
.esc-m-l { font-size:10px; color:var(--t3); margin-top:1px; }

/* ═══════════════════════════════════════
   WORKOUT SESSION CARDS (PSC)
═══════════════════════════════════════ */
.psc {
  background:var(--sur); border:1.5px solid var(--bd);
  border-radius:var(--rad); box-shadow:var(--sh);
  overflow:hidden; cursor:pointer;
  transition:box-shadow .15s, transform .15s, border-color .15s;
}
.psc:hover { box-shadow:var(--sh-md); transform:translateY(-1px); border-color:var(--bd2); }
.psc.open { box-shadow:var(--sh-lg); transform:translateY(-1px); border-color:var(--bd2); }
.psc.key-l { border-left:4px solid var(--a); }
.psc.done-l { border-left:4px solid var(--g); }

.psc-top { display:flex; align-items:center; gap:10px; padding:13px 16px; }
.psc-day { font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--t4); font-family:'DM Mono',monospace; min-width:26px; }
.psc-dot { width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:16px; flex-shrink:0; }
.dot-b { background:#eff6ff; }
.dot-r { background:#fff1f2; }
.dot-s { background:#f0f9ff; }
.dot-tri { background:#f5f3ff; }
.psc-body { flex:1; }
.psc-name { font-size:14px; font-weight:700; color:var(--t1); margin-bottom:3px; }
.psc-meta { display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
.psc-dur { font-size:11px; color:var(--t3); font-family:'DM Mono',monospace; }
.psc-expand-hint { 
  margin-left:auto; 
  font-size:10px; color:var(--t4); 
  font-family:'DM Mono',monospace;
  opacity:0; transition:opacity .2s;
}
.psc:not(.open):hover .psc-expand-hint { opacity:1; }
.psc-chev { color:var(--t3); font-size:16px; transition:transform .2s; flex-shrink:0; line-height:1; }
.psc.open .psc-chev { transform:rotate(180deg); }

/* Detail panel */
.psc-detail { display:none; border-top:1px solid var(--bd); background:var(--sur2); }
.psc.open .psc-detail { display:block; animation:slideDown .16s ease both; }
@keyframes slideDown { from{opacity:0;transform:translateY(-4px)} to{opacity:1;transform:translateY(0)} }
.psc-detail-inner { padding:16px 20px; }

.intent-summary { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:14px; gap:12px; }
.is-label { font-weight:700; font-size:14px; color:var(--t1); margin-bottom:2px; }
.is-sub { font-size:12px; color:var(--t3); }

.struct-toggle {
  font-size:11px; color:var(--b); font-weight:600;
  background:none; border:none; cursor:pointer; padding:0; flex-shrink:0;
  font-family:'Plus Jakarta Sans',sans-serif;
}
.struct-toggle:hover { text-decoration:underline; }

/* Workout structure visualization */
.struct-view { display:none; }
.struct-view.show { display:block; }
.struct-canvas {
  background:#0f1012; border-radius:10px;
  padding:14px 16px; margin-bottom:12px; overflow:hidden;
}
.struct-bars { display:flex; align-items:flex-end; gap:4px; height:80px; }
.struct-blk {
  border-radius:3px 3px 0 0; display:flex; align-items:flex-end;
  justify-content:center; padding-bottom:3px;
  font-size:8px; font-weight:700; color:rgba(255,255,255,0.7);
  font-family:'DM Mono',monospace;
  transition:opacity .2s;
}
.sb-wu  { background:#4ade80; }
.sb-cd  { background:#6b7280; }
.sb-z2  { background:#60a5fa; }
.sb-z3  { background:#a78bfa; }
.sb-z4  { background:#f87171; }
.sb-z5  { background:#f97316; }
.sb-rest{ background:#374151; }

.struct-targets { margin-bottom:12px; }
.st-row { display:flex; align-items:center; gap:8px; padding:4px 0; border-bottom:1px solid var(--bd); }
.st-row:last-child { border:none; }
.st-swatch { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
.st-row span:nth-child(2) { flex:1; font-size:12px; color:var(--t2); }
.st-val { font-size:12px; font-weight:600; color:var(--t1); font-family:'DM Mono',monospace; }

.struct-adj { display:flex; gap:8px; flex-wrap:wrap; margin-top:4px; }
.struct-adj-btn {
  padding:5px 12px; border-radius:20px;
  border:1.5px solid var(--bd); background:transparent;
  font-size:11px; font-weight:600; color:var(--t2);
  cursor:pointer; font-family:'Plus Jakarta Sans',sans-serif;
  transition:all .15s;
}
.struct-adj-btn:hover { border-color:var(--r); color:var(--r); background:var(--r1); }

/* Workout blocks (swim/run breakdown) */
.g-block { padding:10px 12px; border-radius:8px; margin-bottom:6px; }
.g-wu   { background:#f0fdf4; border-left:3px solid #4ade80; }
.g-main { background:#eff6ff; border-left:3px solid #60a5fa; }
.g-cd   { background:#fafafa; border-left:3px solid #9ca3af; }
.gb-lbl { font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--t4); font-family:'DM Mono',monospace; margin-bottom:3px; }
.gb-text { font-size:12px; color:var(--t2); }
.gb-dur { font-size:10px; color:var(--t4); font-family:'DM Mono',monospace; margin-top:2px; }

/* Footer actions */
.psc-footer { padding:12px 20px; border-top:1px solid var(--bd); display:flex; gap:8px; background:var(--sur); }
.btn-done {
  padding:8px 18px; border-radius:var(--rad-s);
  background:var(--g); color:#fff;
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:13px; font-weight:700;
  border:none; cursor:pointer; transition:background .15s;
}
.btn-done:hover { background:#158a5d; }
.btn-skip-sess {
  padding:8px 14px; border-radius:var(--rad-s);
  background:transparent; border:1.5px solid var(--bd);
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:13px; font-weight:600; color:var(--t2);
  cursor:pointer; transition:all .15s;
}
.btn-skip-sess:hover { border-color:var(--bd2); color:var(--t1); }

/* Rest day */
.rest-day-card {
  display:flex; align-items:center; gap:10px;
  padding:13px 16px; background:var(--sur3);
  border:1px dashed var(--bd2); border-radius:var(--rad);
}
.rdc-day { font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--t4); font-family:'DM Mono',monospace; min-width:26px; }
.rdc-dot { width:36px; height:36px; display:flex; align-items:center; justify-content:center; font-size:20px; color:var(--t4); flex-shrink:0; }
.rdc-lbl { font-size:13px; font-weight:600; color:var(--t3); }
.rdc-sub { font-size:11px; color:var(--t4); }

/* Plan sessions container */
.plan-sessions { display:flex; flex-direction:column; gap:8px; }

/* Coach intel strip on workout card */
.intel-strip {
  background:var(--b1); border:1px solid rgba(37,99,235,0.15);
  border-radius:8px; padding:9px 12px;
  display:flex; align-items:flex-start; gap:8px;
  margin-bottom:12px;
}
.intel-strip-icon { font-size:14px; flex-shrink:0; margin-top:1px; }
.intel-strip-text { font-size:12px; color:var(--b); line-height:1.45; }
.intel-strip-text strong { font-weight:700; }

/* ═══════════════════════════════════════
   ── WEEK SCREEN ──
═══════════════════════════════════════ */
/* Execution score banner for week */
.week-exec-banner {
  display:flex; align-items:center;
  background:var(--sur); border:1px solid var(--bd);
  border-radius:var(--rad); padding:16px 20px;
  margin-bottom:20px; gap:24px;
}
.web-score { display:flex; align-items:baseline; gap:4px; }
.web-score-num { font-size:42px; font-weight:800; color:var(--t1); letter-spacing:-2px; line-height:1; }
.web-score-of  { font-size:16px; color:var(--t4); }
.web-label { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--t4); font-family:'DM Mono',monospace; margin-bottom:4px; }
.web-trend { font-size:13px; font-weight:700; color:var(--g); }
.web-div  { width:1px; height:40px; background:var(--bd); }
.web-stat { text-align:center; }
.web-stat-v { font-size:20px; font-weight:800; color:var(--t1); }
.web-stat-l { font-size:10px; color:var(--t3); font-family:'DM Mono',monospace; }
.web-intent { flex:1; }
.web-intent-lbl { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--t4); font-family:'DM Mono',monospace; margin-bottom:4px; }
.web-intent-val { font-size:13px; font-weight:600; color:var(--t1); }
.web-intent-sub { font-size:11px; color:var(--t3); }

/* Day dots strip */
.week-dots-strip {
  display:flex; align-items:center; gap:4px;
  background:var(--sur3); border-radius:8px;
  padding:4px; margin-bottom:4px;
}
.wd-dot {
  flex:1; padding:6px 4px; border-radius:6px;
  text-align:center; cursor:pointer;
  border:1.5px solid transparent;
  transition:all .15s;
}
.wd-dot:hover { background:var(--sur); border-color:var(--bd); }
.wd-dot.selected { background:var(--sur); border-color:var(--b); }
.wd-dot.today-dot .wd-d { color:var(--b); }
.wd-d { font-size:9px; font-weight:700; text-transform:uppercase; color:var(--t4); font-family:'DM Mono',monospace; margin-bottom:3px; }
.wd-ind { width:8px; height:8px; border-radius:50%; margin:0 auto; }
.wd-done { background:var(--g); }
.wd-today { background:var(--b); }
.wd-key { background:var(--a); }
.wd-miss { background:var(--r2); border:1.5px solid var(--r); }
.wd-empty { background:var(--bd); }
.wd-rest { background:var(--sur3); border:1px solid var(--bd); }
/* Key label under dot */
.wd-key-lbl {
  font-size:7px; font-weight:700; color:var(--a);
  font-family:'DM Mono',monospace; text-align:center;
  margin-top:2px; text-transform:uppercase; letter-spacing:.04em;
}

/* Rolling signal */
.rolling-signal {
  display:flex; align-items:center; gap:12px;
  background:var(--b1); border:1px solid rgba(37,99,235,0.18);
  border-radius:var(--rad-s); padding:10px 14px;
  margin-bottom:16px;
}
.rs-icon-lg { font-size:18px; }
.rs-headline { font-size:13px; font-weight:700; color:var(--t1); }
.rs-detail-txt { font-size:11px; color:var(--t3); }
.rs-cta-btn {
  margin-left:auto; font-size:11px; font-weight:700; color:var(--b);
  background:none; border:none; cursor:pointer; padding:0;
  font-family:'Plus Jakarta Sans',sans-serif; flex-shrink:0;
}
.rs-cta-btn:hover { text-decoration:underline; }

/* ═══════════════════════════════════════
   ── PROGRESS SCREEN ──
═══════════════════════════════════════ */
.exec-score-hero {
  background:var(--t1); color:#fff;
  border-radius:var(--rad); padding:28px 32px;
  display:flex; align-items:center; gap:32px;
  margin-bottom:20px; overflow:hidden; position:relative;
}
.exec-score-hero::before {
  content:'';
  position:absolute; top:-40px; right:-40px;
  width:200px; height:200px;
  border-radius:50%;
  background:rgba(255,255,255,0.04);
}
.esh-number {
  font-size:80px; font-weight:800;
  letter-spacing:-4px; line-height:1;
  flex-shrink:0;
}
.esh-label { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.12em; opacity:.5; margin-bottom:8px; font-family:'DM Mono',monospace; }
.esh-verdict { font-size:22px; font-weight:700; margin-bottom:6px; font-family:'DM Serif Display',serif; }
.esh-sub { font-size:13px; opacity:.6; }
.esh-div { width:1px; height:60px; background:rgba(255,255,255,0.15); margin:0 8px; }
.esh-stat { text-align:center; }
.esh-stat-v { font-size:28px; font-weight:800; }
.esh-stat-l { font-size:10px; opacity:.5; font-family:'DM Mono',monospace; text-transform:uppercase; letter-spacing:.08em; }
.esh-trend-val { font-size:13px; font-weight:600; color:#4ade80; margin-top:4px; }

/* Execution metric cards */
.exec-metrics { display:grid; grid-template-columns:repeat(3,1fr); gap:14px; margin-bottom:20px; }
.em-card {
  background:var(--sur); border:1px solid var(--bd);
  border-radius:var(--rad); padding:18px 20px;
  box-shadow:var(--sh);
}
.em-label { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--t4); font-family:'DM Mono',monospace; margin-bottom:10px; }
.em-value { font-size:32px; font-weight:800; color:var(--t1); letter-spacing:-1px; margin-bottom:4px; }
.em-value .em-unit { font-size:16px; color:var(--t3); }
.em-sub { font-size:12px; color:var(--t3); }
.em-bar-wrap { background:var(--bg2); border-radius:4px; height:6px; margin-top:12px; overflow:hidden; }
.em-bar { height:6px; border-radius:4px; background:var(--g); }
.em-trend-up   { color:var(--g); }
.em-trend-down { color:var(--r); }
.em-trend-flat { color:var(--t3); }

/* Execution history table */
.exec-history { background:var(--sur); border:1px solid var(--bd); border-radius:var(--rad); overflow:hidden; box-shadow:var(--sh); }
.eh-header { padding:14px 20px; border-bottom:1px solid var(--bd); display:flex; align-items:center; justify-content:space-between; }
.eh-title { font-weight:700; font-size:14px; }
.eh-row { display:flex; align-items:center; padding:11px 20px; border-bottom:1px solid var(--bd); gap:12px; }
.eh-row:last-child { border:none; }
.eh-week { font-size:11px; color:var(--t3); font-family:'DM Mono',monospace; min-width:90px; }
.eh-score-pill {
  min-width:40px; text-align:center;
  padding:3px 10px; border-radius:20px;
  font-size:11px; font-weight:700; font-family:'DM Mono',monospace;
}
.pill-hi { background:var(--g1); color:var(--g); }
.pill-md { background:var(--a1); color:var(--a); }
.pill-lo { background:var(--r1); color:var(--r); }
.eh-bars { flex:1; display:flex; gap:3px; align-items:flex-end; height:20px; }
.eh-b { flex:1; border-radius:2px; }
.eh-b.done { background:var(--g); }
.eh-b.key  { background:var(--a); }
.eh-b.miss { background:var(--bd2); }
.eh-b.rest { background:var(--sur3); }
.eh-detail { font-size:11px; color:var(--t3); min-width:100px; text-align:right; }

/* ═══════════════════════════════════════
   ── DISCOVER (v9 Cady Core) ──
═══════════════════════════════════════ */
.cady-hero { background:linear-gradient(135deg,var(--gold1) 0%,#fef9f0 100%); border:1px solid var(--gold2); border-radius:20px; padding:36px 40px; margin-bottom:18px; box-shadow:var(--sh-md); display:grid; grid-template-columns:1fr auto; gap:32px; align-items:center; }
.ch-badge { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
.cady-badge { display:inline-flex; align-items:center; gap:7px; background:var(--gold); color:#fff; padding:6px 14px; border-radius:20px; font-size:12px; font-weight:700; letter-spacing:.02em; }
.cady-badge-icon { font-size:14px; }
.ch-title { font-size:28px; font-weight:800; letter-spacing:-.03em; margin-bottom:6px; }
.ch-sub { font-size:14px; color:var(--t2); line-height:1.6; max-width:500px; }
.ch-stats { display:flex; gap:24px; }
.ch-stat { text-align:center; }
.ch-stat-val { font-size:22px; font-weight:800; color:var(--gold); }
.ch-stat-lbl { font-size:11px; color:var(--t3); }
.discover-filters { display:flex; gap:8px; margin-bottom:18px; flex-wrap:wrap; align-items:center; }
.df-lbl { font-size:12px; color:var(--t3); font-weight:500; margin-right:4px; }
.fbtn { padding:5px 14px; border-radius:20px; font-size:12px; font-weight:500; border:1px solid var(--bd); background:var(--sur); color:var(--t2); cursor:pointer; font-family:'Plus Jakarta Sans',sans-serif; transition:all .1s; }
.fbtn:hover { background:var(--sur3); color:var(--t1); }
.fbtn.active { background:var(--t1); color:#fff; border-color:var(--t1); }
.coach-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:14px; }
.coach-card { background:var(--sur); border:1px solid var(--bd); border-radius:var(--rad); padding:22px 24px; box-shadow:var(--sh); cursor:pointer; transition:all .15s; }
.coach-card:hover { transform:translateY(-2px); box-shadow:var(--sh-md); border-color:var(--bd2); }
.coach-card-top { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:14px; }
.coach-avi-lg { width:52px; height:52px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:700; border:3px solid transparent; }
.cady-verified { display:inline-flex; align-items:center; gap:5px; background:var(--gold1); color:var(--gold); border:1px solid var(--gold2); padding:3px 10px; border-radius:12px; font-size:10px; font-weight:700; }
.coach-name { font-size:16px; font-weight:800; margin-bottom:2px; }
.coach-spec { font-size:12px; color:var(--t3); margin-bottom:10px; }
.coach-bio { font-size:13px; color:var(--t2); line-height:1.6; margin-bottom:14px; }
.coach-stats { display:flex; gap:14px; margin-bottom:14px; }
.cst-val { font-size:16px; font-weight:800; letter-spacing:-.02em; }
.cst-lbl { font-size:10px; color:var(--t3); font-family:'DM Mono',monospace; }
.prog-pill { display:inline-flex; align-items:center; background:var(--sur3); border:1px solid var(--bd); border-radius:8px; padding:4px 10px; font-size:11px; color:var(--t2); margin:2px; }
/* Coach profile screen */
.sdiv { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.12em; color:var(--t4); display:flex; align-items:center; gap:10px; margin:24px 0 12px; }
.sdiv::after { content:''; flex:1; height:1px; background:var(--bd); }
.kpi { background:var(--sur); border:1px solid var(--bd); border-radius:var(--rad); padding:16px 18px; box-shadow:var(--sh); }
.kpi-l { font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:.1em; color:var(--t4); margin-bottom:8px; }
.kpi-v { font-size:24px; font-weight:800; line-height:1; letter-spacing:-.02em; margin-bottom:4px; }
.kpi-d { font-family:'DM Mono',monospace; font-size:11px; color:var(--t3); }
.verified-profile { background:var(--sur); border:1px solid var(--bd); border-radius:20px; overflow:hidden; box-shadow:var(--sh-md); margin-bottom:14px; }
.vp-banner { height:100px; background:linear-gradient(135deg,#1a1814 0%,#2a2620 100%); position:relative; display:flex; align-items:flex-end; padding:16px 28px; }
.vp-avi { width:72px; height:72px; border-radius:50%; border:3px solid #fff; background:var(--g1); color:var(--g); display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:700; position:absolute; bottom:-36px; left:28px; }
.vp-body { padding:52px 28px 28px; }
.vp-name { font-size:24px; font-weight:800; letter-spacing:-.02em; margin-bottom:4px; }
.vp-creds { display:flex; align-items:center; gap:10px; margin-bottom:10px; flex-wrap:wrap; }
.vp-bio { font-size:14px; color:var(--t2); line-height:1.7; margin-bottom:16px; max-width:600px; }
.prog-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:14px; }
.prog-card { background:var(--sur); border:1px solid var(--bd); border-radius:var(--rad); padding:20px 22px; box-shadow:var(--sh); cursor:pointer; transition:all .15s; }
.prog-card:hover { transform:translateY(-1px); box-shadow:var(--sh-md); }
.prog-card-top { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:12px; }
.prog-icon { width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:20px; }
.prog-name { font-size:16px; font-weight:700; margin-bottom:3px; }
.prog-meta { font-size:11px; color:var(--t3); font-family:'DM Mono',monospace; margin-bottom:8px; }
.prog-desc { font-size:13px; color:var(--t2); line-height:1.6; margin-bottom:12px; }
.prog-stats { display:flex; gap:14px; }
.pst-val { font-size:16px; font-weight:800; }
.pst-lbl { font-size:10px; color:var(--t4); }

/* Key activation modal */
.modal-overlay {
  position:fixed; inset:0; background:rgba(26,24,20,0.5);
  backdrop-filter:blur(4px); z-index:1000;
  display:none; align-items:center; justify-content:center;
  padding:20px;
}
.modal-overlay.open { display:flex; }
.modal-box {
  background:var(--sur); border-radius:var(--rad);
  padding:28px 32px; max-width:420px; width:100%;
  box-shadow:var(--sh-lg);
  animation:fadeUp .2s ease both;
}
.modal-title { font-family:'DM Serif Display',serif; font-size:22px; margin-bottom:6px; }
.modal-sub { font-size:13px; color:var(--t3); margin-bottom:20px; }
.key-input-wrap { display:flex; gap:8px; margin-bottom:16px; }
.key-input {
  flex:1; padding:10px 14px; border-radius:var(--rad-s);
  border:1.5px solid var(--bd); background:var(--sur3);
  font-family:'DM Mono',monospace; font-size:16px;
  letter-spacing:.1em; color:var(--t1);
  transition:border-color .15s;
}
.key-input:focus { outline:none; border-color:var(--b); }
.modal-close {
  position:absolute; top:16px; right:16px;
  background:none; border:none; cursor:pointer;
  color:var(--t4); font-size:20px; line-height:1;
  padding:4px; border-radius:6px;
}
.modal-close:hover { background:var(--sur3); color:var(--t1); }

/* ═══════════════════════════════════════
   ── COACH: ROSTER ──
═══════════════════════════════════════ */
.roster-summary-strip {
  display:grid; grid-template-columns:repeat(4,1fr); gap:12px;
  margin-bottom:24px;
}
.rss-card {
  background:var(--sur); border:1px solid var(--bd);
  border-radius:var(--rad-s); padding:14px 16px;
  box-shadow:var(--sh);
}
.rss-v { font-size:28px; font-weight:800; color:var(--t1); letter-spacing:-1px; }
.rss-l { font-size:10px; color:var(--t3); font-family:'DM Mono',monospace; text-transform:uppercase; letter-spacing:.08em; margin-top:2px; }

/* Flags */
.flag-section { margin-bottom:20px; }
.flag-section-title { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--t4); font-family:'DM Mono',monospace; margin-bottom:10px; }
.flag-card {
  background:var(--sur); border:1px solid var(--bd);
  border-left:4px solid var(--r);
  border-radius:var(--rad-s); padding:12px 16px;
  display:flex; align-items:center; gap:12px;
  margin-bottom:6px; box-shadow:var(--sh);
}
.flag-card.flag-amber { border-left-color:var(--a); }
.flag-card.flag-info  { border-left-color:var(--b); }
.flag-av { width:32px; height:32px; border-radius:50%; background:var(--bg2); display:flex; align-items:center; justify-content:center; font-size:14px; flex-shrink:0; }
.flag-name { font-weight:700; font-size:13px; color:var(--t1); }
.flag-detail { font-size:11px; color:var(--t3); }
.flag-action {
  margin-left:auto; font-size:11px; font-weight:700; color:var(--b);
  background:none; border:none; cursor:pointer; padding:4px 8px;
  border-radius:6px; font-family:'Plus Jakarta Sans',sans-serif;
}
.flag-action:hover { background:var(--b1); }

/* Athlete roster grid */
.athlete-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:14px; }
.ath-card {
  background:var(--sur); border:1px solid var(--bd);
  border-radius:var(--rad); padding:16px;
  box-shadow:var(--sh); cursor:pointer;
  transition:all .15s;
}
.ath-card:hover { box-shadow:var(--sh-md); transform:translateY(-1px); }
.ath-top { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
.ath-av { width:38px; height:38px; border-radius:50%; background:var(--bg2); display:flex; align-items:center; justify-content:center; font-size:16px; flex-shrink:0; }
.ath-name { font-weight:700; font-size:14px; }
.ath-sport { font-size:10px; color:var(--t3); font-family:'DM Mono',monospace; }
.ath-exec {
  display:flex; align-items:center; justify-content:space-between;
  padding-top:10px; border-top:1px solid var(--bd);
}
.ath-exec-score { font-size:22px; font-weight:800; color:var(--t1); }
.ath-exec-label { font-size:9px; color:var(--t4); font-family:'DM Mono',monospace; margin-top:1px; }
.ath-dots { display:flex; gap:3px; }
.ath-dot { width:8px; height:8px; border-radius:2px; }
.ad-done { background:var(--g); }
.ad-miss { background:var(--r2); border:1px solid var(--r); }
.ad-key  { background:var(--a); }
.ad-rest { background:var(--bd); }

/* ═══════════════════════════════════════
   ── COACH: SCHEDULE ──
═══════════════════════════════════════ */
.sched-layout { display:grid; grid-template-columns:240px 1fr; gap:20px; }
.sched-sidebar-panel { }
.sched-ath-list { }
.saf-pill {
  display:flex; align-items:center; gap:8px; padding:7px 10px;
  border-radius:8px; cursor:pointer; transition:background .12s;
}
.saf-pill:hover { background:var(--sur3); }
.saf-pill.active { background:var(--bg2); }
.saf-av { width:28px; height:28px; border-radius:50%; background:var(--bg2); display:flex; align-items:center; justify-content:center; font-size:12px; flex-shrink:0; }
.saf-name { font-size:12px; font-weight:600; color:var(--t1); }
.saf-score { margin-left:auto; font-size:11px; font-weight:700; font-family:'DM Mono',monospace; }

/* Calendar */
.cal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
.cal-month { font-size:16px; font-weight:700; color:var(--t1); }
.cal-nav { background:none; border:none; cursor:pointer; color:var(--t3); font-size:18px; padding:4px 8px; border-radius:6px; transition:all .12s; }
.cal-nav:hover { background:var(--sur3); color:var(--t1); }
.cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }
.cal-day-hdr { text-align:center; font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:.08em; color:var(--t4); font-family:'DM Mono',monospace; padding:4px; }
.cal-day {
  aspect-ratio:1; display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
  padding:5px 3px; border-radius:8px; cursor:pointer; border:1.5px solid transparent;
  transition:all .12s; background:var(--sur);
  font-size:12px; color:var(--t2);
}
.cal-day:hover { background:var(--sur3); border-color:var(--bd); }
.cal-day.cal-today { background:var(--b1); border-color:rgba(37,99,235,0.3); color:var(--b); font-weight:700; }
.cal-day.cal-selected { background:var(--b); border-color:var(--b); color:#fff; }
.cal-day.cal-other { color:var(--t4); background:transparent; }
.cal-dot-row { display:flex; gap:2px; margin-top:2px; }
.cd-dot { width:4px; height:4px; border-radius:50%; }

/* ═══════════════════════════════════════
   ── COACH: PROGRAMS ──
═══════════════════════════════════════ */
.prog-tabs { display:flex; gap:2px; background:var(--bg2); border-radius:var(--rad-s); padding:3px; margin-bottom:20px; width:fit-content; }
.prog-tab {
  padding:6px 16px; border-radius:6px; border:none;
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:13px; font-weight:600;
  cursor:pointer; background:transparent; color:var(--t3);
  transition:all .15s;
}
.prog-tab.active { background:var(--sur); color:var(--t1); box-shadow:0 1px 3px rgba(0,0,0,0.08); }

.program-card {
  background:var(--sur); border:1px solid var(--bd);
  border-radius:var(--rad); padding:18px 20px;
  box-shadow:var(--sh); cursor:pointer;
  transition:all .15s;
}
.program-card:hover { box-shadow:var(--sh-md); transform:translateY(-1px); }
.pc-top { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:10px; }
.pc-name { font-weight:700; font-size:15px; color:var(--t1); margin-bottom:3px; }
.pc-meta { font-size:11px; color:var(--t3); font-family:'DM Mono',monospace; }
.pc-sport-badge { padding:3px 9px; border-radius:20px; font-size:10px; font-weight:700; font-family:'DM Mono',monospace; }
.sport-cyc { background:#eff6ff; color:#2563eb; }
.sport-run { background:#fff1f2; color:#e11d48; }
.sport-swim{ background:#f0f9ff; color:#0284c7; }
.sport-tri { background:#f5f3ff; color:#7c3aed; }
.pc-desc { font-size:12px; color:var(--t2); line-height:1.5; margin-bottom:12px; }
.pc-footer { display:flex; align-items:center; gap:8px; padding-top:12px; border-top:1px solid var(--bd); }
.pc-stat { font-size:11px; color:var(--t3); font-family:'DM Mono',monospace; }
.pc-stat::before { content:'·'; margin-right:8px; color:var(--t4); }
.pc-stat:first-child::before { content:''; margin:0; }
.pc-assign-btn {
  margin-left:auto; padding:5px 14px; border-radius:20px;
  background:var(--b); color:#fff; border:none;
  font-size:11px; font-weight:700; cursor:pointer;
  font-family:'Plus Jakarta Sans',sans-serif;
  transition:background .15s;
}
.pc-assign-btn:hover { background:#1d4ed8; }

/* Workout library card */
.wo-card {
  background:var(--sur); border:1px solid var(--bd);
  border-radius:var(--rad); box-shadow:var(--sh);
  margin-bottom:8px; user-select:none;
}
/* Sidebar drag cards — padding so content doesn't clip at rounded corners */
.lib-body .wo-card {
  padding:10px 12px; cursor:grab; transition:box-shadow .15s, opacity .15s;
}
.lib-body .wo-card:hover { box-shadow:var(--sh-md); border-color:var(--bd2); }
.lib-body .wo-card:active { cursor:grabbing; }
.lib-body .wo-card.dragging { opacity:0.45; box-shadow:none; }
.wo-top { display:flex; align-items:center; gap:12px; padding:13px 16px; cursor:pointer; }
.wo-sport { width:32px; height:32px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:15px; flex-shrink:0; }
.wo-name { flex:1; font-weight:700; font-size:13px; color:var(--t1); }
.wo-meta { font-size:10px; color:var(--t3); font-family:'DM Mono',monospace; margin-top:2px; }
.wo-actions { display:flex; gap:6px; align-items:center; }
.wo-btn {
  padding:4px 10px; border-radius:6px; border:1.5px solid var(--bd);
  background:transparent; font-size:11px; font-weight:600; color:var(--t2);
  cursor:pointer; font-family:'Plus Jakarta Sans',sans-serif; transition:all .15s;
}
.wo-btn:hover { border-color:var(--b); color:var(--b); background:var(--b1); }
.wo-btn.primary { background:var(--b); color:#fff; border-color:var(--b); }
.wo-btn.primary:hover { background:#1d4ed8; }

/* ═══════════════════════════════════════
   ── COACH: SETTINGS ──
═══════════════════════════════════════ */
.settings-section { margin-bottom:28px; }
.ss-title { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.12em; color:var(--t4); font-family:'DM Mono',monospace; margin-bottom:12px; }
.settings-row {
  display:flex; align-items:center; justify-content:space-between;
  padding:14px 0; border-bottom:1px solid var(--bd);
  gap:16px;
}
.settings-row:last-child { border:none; }
.sr-label { font-weight:600; font-size:14px; color:var(--t1); }
.sr-sub { font-size:12px; color:var(--t3); margin-top:2px; }

/* ═══════════════════════════════════════
   ── DIVERGENCE MODAL ──
═══════════════════════════════════════ */
.div-modal {
  position:fixed; inset:0; background:rgba(26,24,20,0.5);
  backdrop-filter:blur(4px); z-index:2000;
  display:none; align-items:center; justify-content:center;
  padding:20px;
}
.div-modal.open { display:flex; }
.div-box {
  background:var(--sur); border-radius:var(--rad);
  padding:28px 32px; max-width:460px; width:100%;
  box-shadow:var(--sh-lg);
  animation:fadeUp .2s ease both;
  position:relative;
}
.div-title { font-family:'DM Serif Display',serif; font-size:22px; margin-bottom:4px; }
.div-sub { font-size:13px; color:var(--t3); margin-bottom:20px; }
.div-types { display:flex; flex-direction:column; gap:6px; margin-bottom:16px; }
.div-type {
  padding:11px 14px; border-radius:var(--rad-s);
  border:1.5px solid var(--bd); cursor:pointer;
  transition:all .15s;
}
.div-type:hover { border-color:var(--b); background:var(--b1); }
.div-type.selected { border-color:var(--b); background:var(--b1); }
.dt-name { font-weight:700; font-size:13px; color:var(--t1); margin-bottom:2px; }
.dt-desc { font-size:11px; color:var(--t3); }
.div-adapt-box {
  background:var(--g1); border:1px solid var(--g2);
  border-radius:8px; padding:10px 14px;
  font-size:12px; color:var(--t2); line-height:1.5;
  display:none; margin-bottom:12px;
}
.div-adapt-box.show { display:block; }
.div-footer { display:flex; gap:8px; }
.div-cancel {
  padding:8px 16px; border-radius:var(--rad-s);
  border:1.5px solid var(--bd); background:transparent;
  font-size:13px; font-weight:600; color:var(--t2);
  cursor:pointer; font-family:'Plus Jakarta Sans',sans-serif;
  transition:all .15s;
}
.div-cancel:hover { border-color:var(--bd2); color:var(--t1); }
.div-apply {
  flex:1; padding:8px 16px; border-radius:var(--rad-s);
  background:var(--b); color:#fff; border:none;
  font-size:13px; font-weight:700; cursor:pointer;
  font-family:'Plus Jakarta Sans',sans-serif;
  transition:background .15s;
}
.div-apply:hover { background:#1d4ed8; }

/* ═══════════════════════════════════════
   ── PLAN GENERATOR MODAL ──
═══════════════════════════════════════ */
.gen-modal {
  position:fixed; inset:0; background:rgba(26,24,20,0.55);
  backdrop-filter:blur(6px); z-index:2000;
  display:none; align-items:center; justify-content:center;
  padding:20px;
}
.gen-modal.open { display:flex; }
.gen-box {
  background:var(--sur); border-radius:var(--rad);
  width:100%; max-width:540px;
  box-shadow:var(--sh-lg);
  animation:fadeUp .22s ease both;
  overflow:hidden;
}
.gen-header { padding:24px 28px 20px; border-bottom:1px solid var(--bd); }
.gen-title { font-family:'DM Serif Display',serif; font-size:22px; margin-bottom:3px; }
.gen-sub { font-size:13px; color:var(--t3); }
.gen-body { padding:24px 28px; }
.gen-progress-bar { height:3px; background:var(--bg2); border-radius:2px; margin-bottom:20px; }
.gen-progress-fill { height:3px; background:var(--b); border-radius:2px; transition:width .3s; }
.gen-step-label { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--t4); font-family:'DM Mono',monospace; margin-bottom:8px; }
.gen-q { font-size:17px; font-weight:700; color:var(--t1); margin-bottom:16px; }
.gen-options { display:flex; flex-direction:column; gap:8px; }
.gen-opt {
  padding:12px 16px; border-radius:var(--rad-s);
  border:1.5px solid var(--bd); cursor:pointer;
  transition:all .15s; display:flex; align-items:center; gap:10px;
}
.gen-opt:hover { border-color:var(--b); background:var(--b1); }
.gen-opt.selected { border-color:var(--b); background:var(--b1); }
.gen-opt-icon { font-size:18px; }
.gen-opt-label { font-weight:700; font-size:13px; color:var(--t1); }
.gen-opt-sub { font-size:11px; color:var(--t3); margin-top:1px; }
.gen-input {
  width:100%; padding:10px 14px; border-radius:var(--rad-s);
  border:1.5px solid var(--bd); background:var(--sur3);
  font-family:'Plus Jakarta Sans',sans-serif; font-size:14px;
  color:var(--t1); margin-bottom:10px;
}
.gen-input:focus { outline:none; border-color:var(--b); }
.gen-footer { padding:16px 28px 24px; display:flex; gap:8px; border-top:1px solid var(--bd); }
.gen-back {
  padding:9px 16px; border-radius:var(--rad-s);
  border:1.5px solid var(--bd); background:transparent;
  font-size:13px; font-weight:600; color:var(--t2);
  cursor:pointer; font-family:'Plus Jakarta Sans',sans-serif;
}
.gen-next {
  flex:1; padding:9px 16px; border-radius:var(--rad-s);
  background:var(--b); color:#fff; border:none;
  font-size:13px; font-weight:700; cursor:pointer;
  font-family:'Plus Jakarta Sans',sans-serif;
  transition:background .15s;
}
.gen-next:hover { background:#1d4ed8; }
.gen-next:disabled { background:var(--bd2); cursor:not-allowed; }

/* ═══════════════════════════════════════
   ── ONBOARDING ──  (v9 card visual, v10 logic)
═══════════════════════════════════════ */
#onboard {
  min-height:100vh; background:var(--bg);
  display:flex; align-items:center; justify-content:center;
  padding:40px 20px;
}
/* v9-style card container */
.onboard-box {
  background:var(--sur); border:1px solid var(--bd);
  border-radius:20px; padding:48px 52px;
  max-width:520px; width:100%;
  box-shadow:var(--sh-md);
  animation:fadeUp .3s ease both;
}
/* Logo inside card */
.ob-logo { font-weight:800; font-size:18px; letter-spacing:-.03em; color:var(--t1); margin-bottom:6px; }
.ob-logo span { color:var(--g); }
/* Step indicator */
.ob-step-lbl { font-size:11px; font-family:'DM Mono',monospace; color:var(--t4); margin-bottom:32px; }
/* Progress bar */
.ob-progress { display:flex; gap:5px; margin-bottom:24px; }
.ob-prog-dot { height:3px; border-radius:2px; flex:1; background:var(--bd); transition:background .2s; }
.ob-prog-dot.done { background:var(--g); }
.ob-prog-dot.active { background:var(--t3); }
/* Question */
.ob-q { font-size:22px; font-weight:800; letter-spacing:-.02em; color:var(--t1); margin-bottom:8px; font-family:'Plus Jakarta Sans',sans-serif; }
.ob-sub { font-size:14px; color:var(--t2); margin-bottom:28px; line-height:1.6; }
/* Options (v9 style) */
.ob-options { display:flex; flex-direction:column; gap:10px; margin-bottom:28px; }
.ob-opt {
  display:flex; align-items:center; gap:14px;
  padding:16px 18px; background:var(--sur3);
  border:1px solid var(--bd); border-radius:12px;
  cursor:pointer; transition:all .15s;
}
.ob-opt:hover { border-color:var(--bd2); background:var(--sur); box-shadow:var(--sh); }
.ob-opt.selected { border-color:var(--g); background:var(--g1); }
.ob-opt-icon {
  width:40px; height:40px; border-radius:10px;
  display:flex; align-items:center; justify-content:center;
  font-size:20px; flex-shrink:0;
  background:var(--sur); border:1px solid var(--bd);
}
.ob-opt.selected .ob-opt-icon { background:var(--g2); border-color:var(--g2); }
.ob-opt-title { font-size:14px; font-weight:700; }
.ob-opt-desc { font-size:12px; color:var(--t3); margin-top:2px; }
/* Sport grid in card */
.ob-sport-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-bottom:28px; }
.ob-sport-card {
  padding:14px 16px; border-radius:var(--rad-s);
  border:1px solid var(--bd); cursor:pointer;
  transition:all .15s; background:var(--sur3);
  display:flex; align-items:center; gap:10px;
}
.ob-sport-card:hover { border-color:var(--bd2); background:var(--sur); box-shadow:var(--sh); }
.ob-sport-card.selected { border-color:var(--g); background:var(--g1); }
.ob-sport-icon { font-size:22px; }
.ob-sport-label { font-weight:700; font-size:14px; }
/* Name input */
.ob-input {
  width:100%; padding:12px 16px; border-radius:var(--rad-s);
  border:1px solid var(--bd); background:var(--sur3);
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:15px; color:var(--t1); margin-bottom:16px;
  transition:border-color .15s;
}
.ob-input:focus { outline:none; border-color:var(--g); }
/* Buttons */
.ob-btn {
  width:100%; padding:13px; border-radius:var(--rad-s);
  background:var(--t1); color:#fff; border:none;
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:15px; font-weight:700;
  cursor:pointer; transition:background .15s;
  display:flex; align-items:center; justify-content:center; gap:8px;
}
.ob-btn:hover { background:#2d2a25; }
.ob-btn:disabled { opacity:.4; cursor:not-allowed; }
.ob-footer { display:flex; justify-content:flex-end; gap:10px; }
/* Back link */
.ob-back {
  background:none; border:none; color:var(--t3);
  font-family:'Plus Jakarta Sans',sans-serif;
  font-size:13px; cursor:pointer; margin-bottom:16px;
  display:flex; align-items:center; gap:4px; padding:0;
}
.ob-back:hover { color:var(--t1); }
/* Athlete type options (full-width variant) */
.ob-athlete-type-row { display:flex; flex-direction:column; gap:8px; margin-bottom:28px; }
.ob-ath-opt {
  display:flex; align-items:flex-start; gap:14px;
  padding:14px 18px; background:var(--sur3);
  border:1px solid var(--bd); border-radius:12px;
  cursor:pointer; transition:all .15s;
}
.ob-ath-opt:hover { border-color:var(--bd2); background:var(--sur); box-shadow:var(--sh); }
.ob-ath-opt.selected { border-color:var(--g); background:var(--g1); }
.ob-ath-opt-ic { font-size:20px; flex-shrink:0; margin-top:1px; }
.ob-ath-opt-label { font-weight:700; font-size:14px; }
.ob-ath-opt-desc { font-size:12px; color:var(--t3); margin-top:3px; line-height:1.4; }
/* Steps container — hidden/shown */
.ob-step { display:none; }
.ob-step.active { display:block; animation:fadeUp .24s ease both; }
/* Team code input */
.ob-team-code { margin-top:12px; }
.ob-code-input {
  width:100%; background:var(--sur3); border:1px solid var(--bd);
  border-radius:8px; padding:13px 16px;
  font-family:'DM Mono',monospace; font-size:16px;
  color:var(--t1); outline:none; text-align:center; letter-spacing:.12em;
  transition:border-color .15s;
}
.ob-code-input:focus { border-color:var(--g); }

/* ═══════════════════════════════════════
   ── SCHEDULE CALENDAR (v9 style) ──
═══════════════════════════════════════ */
.coach-gen-signal { background:#111; border-radius:var(--rad); padding:10px 16px; margin-bottom:12px; display:flex; align-items:center; gap:10px; }
.cgs-text { flex:1; font-size:12px; color:rgba(255,255,255,.45); line-height:1.5; }
.cgs-text strong { color:#fff; display:block; margin-bottom:2px; }
.cgs-cta { background:var(--b); color:#fff; border:none; border-radius:var(--rad-s); padding:7px 13px; font-size:11px; font-weight:700; cursor:pointer; font-family:'Plus Jakarta Sans',sans-serif; white-space:nowrap; }
.coach-ath-filter-row { display:flex; gap:5px; flex-wrap:wrap; margin-bottom:12px; }
.caf-pill { display:flex; align-items:center; gap:5px; padding:4px 11px; border-radius:20px; border:1.5px solid var(--bd); background:var(--sur); cursor:pointer; font-size:11px; font-weight:600; color:var(--t2); transition:all .15s; }
.caf-pill:hover,.caf-pill.active { border-color:var(--b); color:var(--b); background:var(--b1); }
.caf-dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
.cal-day-head { background:var(--sur2); padding:8px; text-align:center; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--t4); }
.cal-wo { font-size:10px; padding:2px 6px; border-radius:4px; margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%; box-sizing:border-box; display:block; }
.cal-wo.run { background:var(--g1); color:var(--g); }
.cal-wo.bike { background:var(--b1); color:var(--b); }
.cal-wo.swim { background:#f3f0ff; color:#7c3aed; }
.cal-wo.rest { background:var(--sur3); color:var(--t3); }
.cdn { font-size:12px; font-weight:600; color:var(--t1); margin-bottom:4px; display:block; }

/* ═══════════════════════════════════════
   ── PROGRAM BUILDER (v9 drag-drop) ──
═══════════════════════════════════════ */
.library-layout { display:flex; height:calc(100vh - var(--topbar) - 170px); margin:0 -24px -24px -24px; overflow:hidden; border-top:1px solid var(--bd); }
.lib-sidebar { width:288px; flex-shrink:0; background:var(--sur); border-right:1px solid var(--bd); display:flex; flex-direction:column; overflow:hidden; }
.lib-header { padding:14px 16px 11px; border-bottom:1px solid var(--bd); flex-shrink:0; }
.lib-title { font-size:13px; font-weight:800; margin-bottom:8px; display:flex; align-items:center; justify-content:space-between; }
.lib-search { width:100%; background:var(--sur3); border:1px solid var(--bd); border-radius:var(--rad-s); padding:6px 11px; font-family:'Plus Jakarta Sans',sans-serif; font-size:12px; color:var(--t1); outline:none; box-sizing:border-box; }
.lib-filters { display:flex; gap:4px; margin-top:7px; flex-wrap:wrap; }
.lib-filter { padding:3px 9px; border-radius:20px; font-size:11px; font-weight:500; border:1px solid var(--bd); background:var(--sur); color:var(--t3); cursor:pointer; font-family:'Plus Jakarta Sans',sans-serif; transition:all .1s; }
.lib-filter.active { background:var(--b); color:#fff; border-color:var(--b); }
.lib-body { flex:1; overflow-y:auto; padding:8px; }
.lib-section-lbl { font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:.12em; color:var(--t4); padding:8px 4px 4px; display:block; }
.lib-add-btn { margin:4px; padding:8px; border-radius:var(--rad-s); border:1.5px dashed var(--bd2); background:none; color:var(--t3); font-family:'Plus Jakarta Sans',sans-serif; font-size:12px; font-weight:500; cursor:pointer; width:calc(100% - 8px); transition:all .15s; display:flex; align-items:center; justify-content:center; gap:5px; box-sizing:border-box; }
.lib-add-btn:hover { background:var(--b1); color:var(--b); border-color:var(--b2); }
.wo-card-top { display:flex; align-items:center; gap:7px; margin-bottom:4px; pointer-events:none; }
/* Re-enable pointer events just for the edit button */
.wo-card-top .wca-btn { pointer-events:auto; }
.wo-intervals { pointer-events:none; }
.wo-tags { pointer-events:none; }
.wo-type-dot { width:6px; height:6px; border-radius:50%; flex-shrink:0; }
.run-dot { background:var(--g); } .bike-dot { background:var(--b); } .swim-dot { background:#7c3aed; } .str-dot { background:var(--a); }
.wo-name { font-size:12px; font-weight:700; flex:1; }
.wo-duration { font-family:'DM Mono',monospace; font-size:10px; color:var(--t4); }
.wo-intervals { display:flex; gap:2px; align-items:flex-end; height:14px; margin-bottom:4px; }
.wi { border-radius:2px 2px 0 0; }
.wi-warmup { background:var(--g1); border:1px solid var(--g2); } .wi-work { background:var(--b2); border:1px solid var(--b); }
.wi-rest { background:var(--bd); border:1px solid var(--bd2); } .wi-cool { background:var(--g1); border:1px solid var(--g2); } .wi-high { background:var(--r2); border:1px solid var(--r); }
.wo-tags { display:flex; gap:3px; flex-wrap:wrap; }
.wo-tag { font-size:9px; font-family:'DM Mono',monospace; font-weight:500; padding:2px 5px; border-radius:4px; }
.tag-z2{background:var(--g1);color:var(--g)} .tag-threshold{background:var(--a1);color:var(--a)} .tag-vo2{background:var(--r1);color:var(--r)}
.tag-recovery{background:var(--sur3);color:var(--t3)} .tag-race{background:var(--gold1);color:var(--gold)} .tag-long{background:var(--b1);color:var(--b)}
.wo-card-actions { position:absolute; top:6px; right:6px; display:none; gap:2px; }
.wo-card:hover .wo-card-actions { display:flex; }
.wca-btn { width:18px; height:18px; border-radius:4px; background:var(--sur3); border:1px solid var(--bd); display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:9px; color:var(--t2); }
.wca-btn:hover { background:var(--t1); color:#fff; }
.plan-canvas-area { flex:1; display:flex; flex-direction:column; overflow:hidden; background:var(--bg); min-width:0; }
.canvas-header { padding:13px 20px 11px; border-bottom:1px solid var(--bd); background:var(--sur); display:flex; align-items:center; gap:12px; flex-shrink:0; }
.plan-name-input { font-size:16px; font-weight:800; letter-spacing:-.02em; background:none; border:none; outline:none; color:var(--t1); font-family:'Plus Jakarta Sans',sans-serif; flex:1; }
.plan-meta-row { font-size:11px; font-family:'DM Mono',monospace; color:var(--t3); margin-top:1px; }
.canvas-toolbar { padding:8px 20px; border-bottom:1px solid var(--bd); background:var(--sur); display:flex; align-items:center; gap:6px; flex-shrink:0; flex-wrap:wrap; }
.tb-btn { padding:5px 11px; border-radius:var(--rad-s); font-size:12px; font-weight:500; border:1px solid var(--bd); background:var(--sur); color:var(--t2); cursor:pointer; font-family:'Plus Jakarta Sans',sans-serif; transition:all .1s; display:flex; align-items:center; gap:5px; }
.tb-btn:hover { background:var(--sur3); color:var(--t1); }
.tb-primary { background:var(--b) !important; color:#fff !important; border-color:var(--b) !important; }
.phase-legend { display:flex; align-items:center; gap:8px; margin-left:auto; }
.ph-leg { display:flex; align-items:center; gap:4px; font-size:10px; color:var(--t3); }
.ph-leg-dot { width:8px; height:8px; border-radius:2px; }
.weeks-container { flex:1; overflow-y:auto; padding:14px 20px 60px; }
.week-block { margin-bottom:18px; }
.week-header { display:flex; align-items:center; gap:10px; padding:0 2px 7px 0; border-bottom:1px solid var(--bd); }
.wk-stripe { width:3px; height:15px; border-radius:2px; flex-shrink:0; }
.phase-base .wk-stripe{background:var(--g)} .phase-build .wk-stripe{background:var(--b)} .phase-peak .wk-stripe{background:var(--a)} .phase-taper .wk-stripe{background:#7c3aed}
.wk-num { font-family:'DM Mono',monospace; font-size:10px; font-weight:500; color:var(--t4); }
.wk-phase { font-size:11px; font-weight:700; }
.phase-base .wk-phase{color:var(--g)} .phase-build .wk-phase{color:var(--b)} .phase-peak .wk-phase{color:var(--a)} .phase-taper .wk-phase{color:#7c3aed}
.wk-load { font-family:'DM Mono',monospace; font-size:10px; color:var(--t4); }
.wk-vol-bar { flex:1; max-width:80px; height:2px; background:var(--bd); border-radius:2px; overflow:hidden; }
.wk-vol-fill { height:100%; border-radius:2px; }
.phase-base .wk-vol-fill{background:var(--g)} .phase-build .wk-vol-fill{background:var(--b)} .phase-peak .wk-vol-fill{background:var(--a)} .phase-taper .wk-vol-fill{background:#7c3aed}
.wk-actions { display:none; gap:4px; margin-left:auto; }
.week-block:hover .wk-actions { display:flex; }
.wk-note-tag { font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:.1em; padding:2px 8px; border-radius:10px; background:var(--sur3); color:var(--t3); border:1px solid var(--bd); }
.wk-act { padding:3px 7px; border-radius:var(--rad-s); font-size:10px; font-weight:500; border:1px solid var(--bd); background:var(--sur); color:var(--t2); cursor:pointer; font-family:'Plus Jakarta Sans',sans-serif; }
.wk-act:hover { background:var(--t1); color:#fff; border-color:var(--t1); }
.week-days { display:grid; grid-template-columns:repeat(7,1fr); background:var(--sur); border:1px solid var(--bd); border-radius:10px; overflow:hidden; margin-top:7px; }
.day-head { font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--t4); padding:6px 0 5px; text-align:center; border-bottom:1px solid var(--bd); border-right:1px solid var(--bd); }
.day-head:last-child { border-right:none; }
.day-cell { min-height:78px; border-right:1px solid var(--bd); padding:5px; position:relative; transition:background .1s; }
.day-cell:last-child { border-right:none; }
.day-cell.drop-target { background:var(--b1); outline:2px dashed var(--b2); outline-offset:-2px; }
.day-cell:hover { background:rgba(37,99,235,0.02); }
.placed-wo { display:flex; border-radius:5px; overflow:hidden; margin-bottom:3px; cursor:grab; position:relative; }
.placed-wo-stripe { width:3px; flex-shrink:0; pointer-events:none; }
.placed-wo-body { flex:1; padding:4px 6px; min-width:0; pointer-events:none; }
.placed-wo-name { font-weight:700; font-size:10px; color:var(--t1); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.placed-wo-meta { font-family:'DM Mono',monospace; font-size:9px; color:var(--t3); }
.placed-wo-del { position:absolute; top:2px; right:2px; width:12px; height:12px; border-radius:3px; background:rgba(220,53,69,.1); display:none; align-items:center; justify-content:center; font-size:8px; color:var(--r); cursor:pointer; }
.placed-wo:hover .placed-wo-del { display:flex; }
.placed-run .placed-wo-stripe{background:var(--g)} .placed-run .placed-wo-body{background:rgba(26,158,110,0.06)}
.placed-bike .placed-wo-stripe{background:var(--b)} .placed-bike .placed-wo-body{background:rgba(37,99,235,0.06)}
.placed-swim .placed-wo-stripe{background:#7c3aed} .placed-swim .placed-wo-body{background:rgba(124,58,237,0.06)}
.placed-strength .placed-wo-stripe{background:var(--a)} .placed-strength .placed-wo-body{background:rgba(217,119,6,0.06)}
.empty-drop { text-align:center; padding-top:18px; font-size:11px; color:var(--t4); cursor:pointer; pointer-events:none; }
.builder-overlay { position:fixed; inset:0; background:rgba(26,24,20,.4); backdrop-filter:blur(5px); z-index:600; display:none; align-items:flex-end; justify-content:flex-end; padding-top:var(--topbar); }
.builder-overlay.open { display:flex; }
.builder-panel { width:460px; height:100%; background:var(--sur); border-left:1px solid var(--bd); display:flex; flex-direction:column; overflow:hidden; box-shadow:0 8px 32px rgba(26,24,20,.14); }
.bp-header { padding:16px 18px 13px; border-bottom:1px solid var(--bd); display:flex; align-items:center; justify-content:space-between; flex-shrink:0; }
.bp-title { font-size:14px; font-weight:800; }
.bp-close { width:24px; height:24px; border-radius:6px; background:var(--sur3); border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; color:var(--t2); font-size:14px; }
.bp-close:hover { background:var(--t1); color:#fff; }
.bp-body { flex:1; overflow-y:auto; padding:14px 18px; }
.bp-section { margin-bottom:14px; }
.bp-label { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.12em; color:var(--t4); margin-bottom:5px; }
.bp-input { width:100%; background:var(--sur3); border:1px solid var(--bd); border-radius:var(--rad-s); padding:7px 11px; font-family:'Plus Jakarta Sans',sans-serif; font-size:13px; color:var(--t1); outline:none; box-sizing:border-box; }
.bp-input:focus { border-color:var(--b); background:var(--sur); }
.bp-row { display:grid; grid-template-columns:1fr 1fr; gap:9px; }
.sport-select { display:grid; grid-template-columns:repeat(4,1fr); gap:5px; }
.sport-opt { padding:7px 4px; border-radius:var(--rad-s); border:1.5px solid var(--bd); background:var(--sur3); text-align:center; cursor:pointer; transition:all .12s; }
.sport-opt.selected { border-color:var(--b); background:var(--b1); }
.sport-opt-icon { font-size:15px; margin-bottom:2px; }
.sport-opt-lbl { font-size:10px; font-weight:600; color:var(--t2); }
.sport-opt.selected .sport-opt-lbl { color:var(--b); }
.interval-canvas { background:var(--sur3); border:1px solid var(--bd); border-radius:var(--rad-s); padding:10px; }
.interval-track { display:flex; align-items:flex-end; gap:2px; height:40px; margin-bottom:7px; }
.int-block { border-radius:3px 3px 0 0; cursor:pointer; transition:all .1s; }
.int-block.selected { outline:2px solid var(--t1); outline-offset:1px; }
.int-warmup{background:linear-gradient(to top,var(--g2),var(--g1));border:1px solid var(--g)} .int-work{background:linear-gradient(to top,rgba(37,99,235,.25),var(--b2));border:1px solid var(--b)}
.int-rest{background:var(--bd);border:1px solid var(--bd2)} .int-hard{background:linear-gradient(to top,var(--r2),var(--r1));border:1px solid var(--r)} .int-cool{background:linear-gradient(to top,var(--g2),var(--g1));border:1px solid var(--g)}
.int-add-bar { display:flex; gap:4px; flex-wrap:wrap; margin-top:7px; }
.int-add-btn { padding:3px 8px; border-radius:var(--rad-s); font-size:10px; font-weight:600; border:1px solid var(--bd); background:var(--sur); color:var(--t2); cursor:pointer; font-family:'Plus Jakarta Sans',sans-serif; }
.int-add-btn:hover { background:var(--t1); color:#fff; border-color:var(--t1); }
.int-detail { background:var(--sur); border:1px solid var(--bd); border-radius:var(--rad-s); padding:9px 11px; margin-top:7px; display:none; }
.int-detail.show { display:block; }
.target-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; }
.target-box { background:var(--sur3); border:1px solid var(--bd); border-radius:6px; padding:6px 8px; }
.tgt-lbl { font-size:9px; text-transform:uppercase; letter-spacing:.1em; color:var(--t4); margin-bottom:2px; }
.tgt-input { background:none; border:none; font-family:'DM Mono',monospace; font-size:12px; font-weight:500; color:var(--t1); outline:none; width:100%; }
.int-summary { display:flex; gap:10px; padding:7px 0 0; border-top:1px solid var(--bd); margin-top:7px; font-size:11px; font-family:'DM Mono',monospace; color:var(--t3); }
.bp-footer { padding:12px 18px; border-top:1px solid var(--bd); display:flex; gap:8px; justify-content:flex-end; flex-shrink:0; }

/* ═══════════════════════════════════════
   ── BUSINESS / BILLING ──
═══════════════════════════════════════ */
.biz-hero { background:var(--sur); border:1px solid var(--bd); border-radius:20px; padding:32px 36px; margin-bottom:14px; box-shadow:var(--sh-md); display:grid; grid-template-columns:1fr auto; gap:32px; align-items:center; }
.biz-plan-badge { display:inline-flex; align-items:center; gap:7px; background:var(--g1); color:var(--g); border:1px solid var(--g2); border-radius:20px; padding:5px 14px; font-size:12px; font-weight:700; margin-bottom:10px; }
.biz-plan-name { font-size:26px; font-weight:800; letter-spacing:-.03em; margin-bottom:4px; }
.biz-plan-sub { font-size:14px; color:var(--t2); }
.biz-plan-price { text-align:right; }
.biz-price-amt { font-size:40px; font-weight:800; letter-spacing:-.03em; color:var(--t1); }
.biz-price-per { font-size:14px; color:var(--t3); }
.biz-metrics { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:14px; }
.biz-m { background:var(--sur); border:1px solid var(--bd); border-radius:var(--rad); padding:16px 18px; box-shadow:var(--sh); }
.biz-m-l { font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:.1em; color:var(--t4); margin-bottom:7px; }
.biz-m-v { font-size:24px; font-weight:800; letter-spacing:-.02em; margin-bottom:3px; }
.biz-m-s { font-size:11px; font-family:'DM Mono',monospace; }
.billing-table { background:var(--sur); border:1px solid var(--bd); border-radius:var(--rad); overflow:hidden; box-shadow:var(--sh); margin-bottom:14px; }
.bt-head { display:grid; grid-template-columns:1fr 95px 85px 90px 75px 80px; padding:10px 18px; background:var(--sur2); border-bottom:1px solid var(--bd); }
.bth { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--t4); }
.bt-row { display:grid; grid-template-columns:1fr 95px 85px 90px 75px 80px; padding:13px 18px; border-bottom:1px solid var(--bd); font-size:13px; align-items:center; }
.bt-row:hover { background:var(--sur2); }
/* ── COACH PROFILE EDIT ── */
.profile-form { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.pf-field { display:flex; flex-direction:column; gap:5px; }
.pf-field.full { grid-column:span 2; }
.pf-label { font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:.1em; color:var(--t4); }
.pf-input,.pf-ta { background:var(--sur); border:1px solid var(--bd); border-radius:var(--rad-s); padding:9px 13px; font-family:'Plus Jakarta Sans',sans-serif; font-size:13px; color:var(--t1); outline:none; transition:border-color .15s; width:100%; box-sizing:border-box; }
.pf-input:focus,.pf-ta:focus { border-color:var(--bd2); }
.pf-ta { resize:none; line-height:1.6; }
.btn-gold { background:var(--gold); color:#fff; }
.muted { color:var(--t3); } .mono { font-family:'DM Mono',monospace; } .up { color:var(--g); } .risk { color:var(--r); } .warn { color:var(--a); }

</style>
</head>
<body>

<!-- ═══════════════════════════════════════
     ONBOARDING
═══════════════════════════════════════ -->
<div id="onboard">
  <div class="onboard-box">
    <!-- Logo -->
    <div class="ob-logo">Coreformance<span>.</span></div>

    <!-- Step 1: Role -->
    <div class="ob-step active" id="ob-s1">
      <div class="ob-step-lbl" id="ob-step-lbl">Step 1 of 3</div>
      <div class="ob-progress">
        <div class="ob-prog-dot active"></div>
        <div class="ob-prog-dot"></div>
        <div class="ob-prog-dot"></div>
      </div>
      <div class="ob-q">How will you use Coreformance?</div>
      <div class="ob-sub">This determines your starting environment. You can switch modes anytime.</div>
      <div class="ob-options">
        <div class="ob-opt" onclick="obSelectRole('athlete',this)">
          <div class="ob-opt-icon">🏃</div>
          <div>
            <div class="ob-opt-title">I'm an Athlete</div>
            <div class="ob-opt-desc">Track your training, execute a plan, build toward your race.</div>
          </div>
        </div>
        <div class="ob-opt" onclick="obSelectRole('coach',this)">
          <div class="ob-opt-icon">📋</div>
          <div>
            <div class="ob-opt-title">I'm a Coach</div>
            <div class="ob-opt-desc">Manage athletes, assign programs, monitor execution at scale.</div>
          </div>
        </div>
      </div>
      <button class="ob-btn" id="ob-btn-1" disabled onclick="obNext(1)">Continue →</button>
    </div>

    <!-- Step 2a: Athlete setup -->
    <div class="ob-step" id="ob-s2-athlete">
      <div class="ob-step-lbl">Step 2 of 3</div>
      <div class="ob-progress">
        <div class="ob-prog-dot done"></div>
        <div class="ob-prog-dot active"></div>
        <div class="ob-prog-dot"></div>
      </div>
      <button class="ob-back" onclick="obBack(2)">← Back</button>
      <div class="ob-q">Are you on a team or school program?</div>
      <div class="ob-sub">Everyone starts self-coached by default — your coach relationship layers in naturally whenever you're ready.</div>
      <div class="ob-athlete-type-row">
        <div class="ob-ath-opt" onclick="obSelAthType('self',this)">
          <div class="ob-ath-opt-ic">⚡</div>
          <div>
            <div class="ob-ath-opt-label">Self-coached</div>
            <div class="ob-ath-opt-desc">I build and manage my own training. Give me both athlete and planning views.</div>
          </div>
        </div>
        <div class="ob-ath-opt" onclick="obSelAthType('key',this)">
          <div class="ob-ath-opt-ic">🔑</div>
          <div>
            <div class="ob-ath-opt-label">I have a coach activation key</div>
            <div class="ob-ath-opt-desc">My coach sent me a key. I'll enter it after setup and follow their plan.</div>
          </div>
        </div>
        <div class="ob-ath-opt" onclick="obSelAthType('team',this)">
          <div class="ob-ath-opt-ic">🏫</div>
          <div>
            <div class="ob-ath-opt-label">I'm on a team or school program</div>
            <div class="ob-ath-opt-desc">Enter your team invite code to connect to your assigned coach.</div>
          </div>
        </div>
      </div>
      <div id="ob-team-code" class="ob-team-code" style="display:none">
        <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.1em;color:var(--t4);margin-bottom:7px">Team Invite Code</div>
        <input class="ob-code-input" id="ob-team-input" placeholder="Paste your code here" oninput="obCheckTeamCode()">
        <div style="text-align:center;font-size:13px;color:var(--t3);cursor:pointer;text-decoration:underline;text-underline-offset:3px;margin-top:11px" onclick="obSelAthType('self',document.querySelector('#ob-s2-athlete .ob-ath-opt'))">Continue without a code →</div>
      </div>
      <div class="ob-footer" style="margin-top:8px">
        <button class="ob-btn" id="ob-btn-2a" disabled onclick="obNext('2a')" style="width:auto;flex:1">Continue →</button>
      </div>
    </div>

    <!-- Step 2b: Coach setup -->
    <div class="ob-step" id="ob-s2-coach">
      <div class="ob-step-lbl">Step 2 of 3</div>
      <div class="ob-progress">
        <div class="ob-prog-dot done"></div>
        <div class="ob-prog-dot active"></div>
        <div class="ob-prog-dot"></div>
      </div>
      <button class="ob-back" onclick="obBack(2)">← Back</button>
      <div class="ob-q">What sports do you coach?</div>
      <div class="ob-sub">Select all that apply — this shapes your default library and templates.</div>
      <div class="ob-sport-grid" id="ob-sport-grid">
        <div class="ob-sport-card" onclick="obToggleSport('cycling',this)"><span class="ob-sport-icon">🚴</span><span class="ob-sport-label">Cycling</span></div>
        <div class="ob-sport-card" onclick="obToggleSport('running',this)"><span class="ob-sport-icon">🏃</span><span class="ob-sport-label">Running</span></div>
        <div class="ob-sport-card" onclick="obToggleSport('swimming',this)"><span class="ob-sport-icon">🏊</span><span class="ob-sport-label">Swimming</span></div>
        <div class="ob-sport-card" onclick="obToggleSport('triathlon',this)"><span class="ob-sport-icon">🏆</span><span class="ob-sport-label">Triathlon</span></div>
      </div>
      <div class="ob-footer">
        <button class="ob-btn" id="ob-btn-2b" disabled onclick="obNext('2b')" style="width:auto;flex:1">Continue →</button>
      </div>
    </div>

    <!-- Step 3: Name -->
    <div class="ob-step" id="ob-s3">
      <div class="ob-step-lbl">Step 3 of 3</div>
      <div class="ob-progress">
        <div class="ob-prog-dot done"></div>
        <div class="ob-prog-dot done"></div>
        <div class="ob-prog-dot active"></div>
      </div>
      <button class="ob-back" onclick="obBack(3)">← Back</button>
      <div class="ob-q">What should we call you?</div>
      <div class="ob-sub">Just a first name is fine.</div>
      <input class="ob-input" id="ob-name-input" placeholder="Your first name" oninput="obCheckName()">
      <button class="ob-btn" id="ob-btn-3" disabled onclick="obFinish()">Enter Coreformance →</button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════
     TOPBAR
═══════════════════════════════════════ -->
<div class="topbar" id="topbar">
  <div class="tb-logo">
    <div class="tb-logo-mark">
      <svg viewBox="0 0 20 20"><path d="M10 2L12.5 7.5H18L13.5 11L15.5 17L10 13.5L4.5 17L6.5 11L2 7.5H7.5Z"/></svg>
    </div>
    <span class="tb-logo-name">Coreformance<span class="tb-logo-dot" id="tb-dot">.</span></span>
  </div>
  <div class="tb-center">
    <div class="tb-ws">
      <div class="tb-ws-name" id="tb-ws-name">Marcus Reid</div>
      <div class="tb-ws-sub" id="tb-ws-sub">Self-Coached · Ironman 70.3 · 47d</div>
    </div>
  </div>
  <div class="tb-right">
    <!-- Readiness pill — athlete mode only -->
    <div class="tb-readiness" id="tb-readiness">
      <div class="tb-ready-dot" id="tb-ready-dot"></div>
      <span class="tb-ready-label" id="tb-ready-label">Recovered · HRV +8%</span>
    </div>
    <div class="uavi a" id="uavi" title="Profile">MR</div>
  </div>
</div>

<!-- ═══════════════════════════════════════
     SIDEBAR
═══════════════════════════════════════ -->
<div class="sidebar" id="sidebar">
  <!-- Coach label (dedicated coaches only — replaces mode switch) -->
  <div class="sb-coach-label" id="sb-coach-label">
    <div class="sb-coach-label-name" id="sb-coach-label-name">Coach Dashboard</div>
    <div class="sb-coach-label-role">Coach View</div>
  </div>
  <!-- Mode switch (self-coached athletes only) -->
  <div class="sb-mode-switch" id="sb-mode-switch">
    <div class="sb-mode-row">
      <button class="sb-mode-btn active" id="sb-athlete-btn" onclick="setMode('athlete')">My Training</button>
      <button class="sb-mode-btn" id="sb-coach-btn" onclick="setMode('coach')">My Planning</button>
    </div>
    <div class="sb-mode-context" id="sb-mode-ctx">Self-Coached</div>
  </div>
  <!-- Nav -->
  <nav class="sb-nav" id="sb-nav"></nav>
  <!-- Bottom -->
  <div class="sb-bottom">
    <div class="sb-user-row">
      <div class="sb-user-av" id="sb-user-av">MR</div>
      <div>
        <div class="sb-user-name" id="sb-user-name">Marcus Reid</div>
        <div class="sb-user-role" id="sb-user-role">Athlete</div>
      </div>
    </div>
    <button class="sb-change-coach" id="sb-change-coach" onclick="go('discover')">Change coach →</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- STRAIN CARD (post-workout, dismissible) -->
<div class="strain-overlay" id="strain-overlay">
  <div class="strain-card">
    <div class="sc-sport" id="sc-sport">🚴</div>
    <div class="sc-label">Session Complete</div>
    <div class="sc-strain high" id="sc-strain">High</div>
    <div class="sc-interp" id="sc-interp">Hard session. Your aerobic system was pushed well above threshold. Prioritize recovery for the next 18 hours — easy movement, good sleep, and nutrition.</div>
    <div class="sc-meta" id="sc-meta">70 min · Tempo Intervals · ~74 TSS</div>
    <button class="sc-dismiss" onclick="dismissStrain()">Done ✓</button>
  </div>
</div>

<!-- ATHLETE PREVIEW MODAL (coach read-only view) -->
<div class="preview-overlay" id="preview-overlay">
  <div class="preview-box">
    <div class="preview-header">
      <div class="preview-info" style="flex:1">
        <div class="preview-header-name" id="preview-ath-name">Alex Chen</div>
        <div class="preview-header-sub" id="preview-ath-sub">Triathlon · Week 8 of 20 · Execution 82/100</div>
      </div>
      <span class="preview-ro">Read-only</span>
      <button class="preview-close" onclick="closePreview()">✕</button>
    </div>
    <div class="preview-body">
      <!-- Readiness -->
      <div class="preview-readiness">
        <div class="rs-dot"></div>
        <span class="rs-status">Recovered</span>
        <span class="rs-detail">HRV +5% · Sleep 8h 10m</span>
        <span class="rs-source">via WHOOP ↗</span>
      </div>
      <!-- Today's workout preview -->
      <div class="psc key-l" style="cursor:default;margin-bottom:12px">
        <div class="psc-top">
          <div class="psc-dot dot-tri">🏆</div>
          <div class="psc-body">
            <div class="psc-name">Long Run — 90 min</div>
            <div class="psc-meta">
              <span class="psc-dur">90 min · Zone 2</span>
              <span class="chip ca">⚡ KEY</span>
              <span class="chip cb">Today</span>
            </div>
          </div>
        </div>
      </div>
      <div class="week-dots-strip" style="margin-bottom:0">
        <div class="wd-dot"><div class="wd-d">Mon</div><div class="wd-ind wd-done"></div></div>
        <div class="wd-dot"><div class="wd-d">Tue</div><div class="wd-ind wd-done"></div></div>
        <div class="wd-dot"><div class="wd-d">Wed</div><div class="wd-ind wd-rest"></div></div>
        <div class="wd-dot today-dot selected"><div class="wd-d">Thu</div><div class="wd-ind wd-today"></div></div>
        <div class="wd-dot"><div class="wd-d">Fri</div><div class="wd-ind wd-key"></div></div>
        <div class="wd-dot"><div class="wd-d">Sat</div><div class="wd-ind wd-key"></div></div>
        <div class="wd-dot"><div class="wd-d">Sun</div><div class="wd-ind wd-rest"></div></div>
      </div>
      <div style="text-align:center;margin-top:16px">
        <button class="btn btn-ghost btn-sm" onclick="closePreview()">Close preview</button>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════
     MAIN APP
═══════════════════════════════════════ -->
<div class="app" id="main-app" style="display:none">

<!-- ══════════════════════════════════════
     ATHLETE: TODAY
══════════════════════════════════════ -->
<div class="screen active" id="screen-today">
  <!-- Readiness ambient strip -->
  <div class="readiness-strip" id="readiness-strip">
    <div class="rs-dot" id="rs-dot"></div>
    <span class="rs-status" id="rs-status">Recovered</span>
    <span class="rs-detail">HRV +8% · Sleep 7h 40m · Ready for quality work</span>
    <span class="rs-source">via WHOOP ↗</span>
  </div>

  <div class="ph">
    <div class="ph-row">
      <div>
        <div class="ph-t" id="today-greeting">Good morning, Marcus.</div>
        <div class="ph-s">Thursday, February 26 · Here's what's on your plan today.</div>
      </div>
      <div class="ph-actions">
        <button class="btn btn-ghost btn-sm" onclick="openModal()">Enter coach key</button>
        <button class="btn btn-ghost btn-sm" onclick="go('discover')">Find a coach</button>
      </div>
    </div>
  </div>

  <!-- Today hero: workout card + exec score -->
  <div class="today-hero">
    <!-- Today's session — the hero card -->
    <div>
      <div class="psc key-l open" id="psc-today" onclick="togglePsc('today')" style="margin-bottom:0">
        <div class="psc-top">
          <div class="psc-dot dot-b">🚴</div>
          <div class="psc-body">
            <div class="psc-name">Tempo Intervals — 4×8min</div>
            <div class="psc-meta">
              <span class="psc-dur">70 min · 95% FTP</span>
              <span class="chip ca">⚡ KEY</span>
              <span class="chip cb">Today</span>
            </div>
          </div>
          <span class="psc-expand-hint">tap to collapse</span>
          <div class="psc-chev">▾</div>
        </div>
        <div class="psc-detail">
          <div class="psc-detail-inner">
            <!-- Intelligence strip -->
            <div class="intel-strip">
              <span class="intel-strip-icon">💡</span>
              <span class="intel-strip-text"><strong>Based on your readiness today</strong> — HRV elevated, fatigue low. This is a good day to push the full 4 reps at target intensity. Don't reduce early.</span>
            </div>
            <div class="intent-summary">
              <div>
                <div class="is-label">Build Threshold</div>
                <div class="is-sub">Sweet Spot · 4 × 8 min at 90–95% FTP</div>
              </div>
              <button class="struct-toggle hide" id="stbtn-today" onclick="toggleStruct(event,'today')">Hide structure</button>
            </div>
            <div class="struct-view show" id="struct-today">
              <div class="struct-canvas">
                <div class="struct-bars">
                  <div class="struct-blk sb-wu" style="width:26px;height:48%">WU</div>
                  <div class="struct-blk sb-z4" style="width:38px;height:88%">Z4</div>
                  <div class="struct-blk sb-rest" style="width:12px;height:34%">R</div>
                  <div class="struct-blk sb-z4" style="width:38px;height:88%">Z4</div>
                  <div class="struct-blk sb-rest" style="width:12px;height:34%">R</div>
                  <div class="struct-blk sb-z4" style="width:38px;height:88%">Z4</div>
                  <div class="struct-blk sb-rest" style="width:12px;height:34%">R</div>
                  <div class="struct-blk sb-z4" style="width:38px;height:88%">Z4</div>
                  <div class="struct-blk sb-cd" style="width:20px;height:36%">CD</div>
                </div>
              </div>
              <div class="struct-targets">
                <div class="st-row"><div class="st-swatch" style="background:#a78bfa"></div><span>Sweet Spot power</span><span class="st-val">245–258W (90–95% FTP)</span></div>
                <div class="st-row"><div class="st-swatch" style="background:#f87171"></div><span>HR target</span><span class="st-val">158–168 bpm</span></div>
                <div class="st-row"><div class="st-swatch" style="background:#374151"></div><span>Recovery</span><span class="st-val">4 min between reps</span></div>
              </div>
              <div class="struct-adj">
                <button class="struct-adj-btn" onclick="showDivergence(event)">Can't do this today →</button>
                <button class="struct-adj-btn">Drop to 3 reps</button>
                <button class="struct-adj-btn">Reduce to 88% FTP</button>
              </div>
            </div>
          </div>
          <div class="psc-footer">
            <button class="btn-done" onclick="markDone()">✓ Mark Done</button>
            <button class="btn-skip-sess" onclick="showDivergence(event)">Skip / Modified</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Execution score card -->
    <div class="exec-score-card">
      <div>
        <div class="esc-label">This week's execution score</div>
        <div class="esc-number">74<span>/100</span></div>
        <div class="esc-trend">↑ +6 from last week</div>
        <div class="esc-bars">
          <div class="esc-bar" style="height:60%"></div>
          <div class="esc-bar" style="height:45%"></div>
          <div class="esc-bar" style="height:80%"></div>
          <div class="esc-bar" style="height:72%"></div>
          <div class="esc-bar active" style="height:74%"></div>
          <div class="esc-bar" style="height:30%;opacity:.3"></div>
          <div class="esc-bar" style="height:30%;opacity:.3"></div>
        </div>
      </div>
      <div class="esc-meta">
        <div class="esc-m">
          <div class="esc-m-v">3/5</div>
          <div class="esc-m-l">Done this week</div>
        </div>
        <div class="esc-m">
          <div class="esc-m-v">88%</div>
          <div class="esc-m-l">Intensity accuracy</div>
        </div>
        <div class="esc-m">
          <div class="esc-m-v">11</div>
          <div class="esc-m-l">Day streak</div>
        </div>
        <div class="esc-m">
          <div class="esc-m-v">3/4</div>
          <div class="esc-m-l">Key sessions</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Week preview strip -->
  <div style="margin-top:16px">
    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--t4);font-family:'DM Mono',monospace;margin-bottom:8px;">This week — Feb 24 – Mar 1</div>
    <div class="week-dots-strip">
      <div class="wd-dot" onclick="go('week')"><div class="wd-d">Mon</div><div class="wd-ind wd-done"></div></div>
      <div class="wd-dot" onclick="go('week')"><div class="wd-d">Tue</div><div class="wd-ind wd-done"></div></div>
      <div class="wd-dot" onclick="go('week')"><div class="wd-d">Wed</div><div class="wd-ind wd-rest"></div></div>
      <div class="wd-dot today-dot selected" onclick="go('week')"><div class="wd-d">Thu</div><div class="wd-ind wd-today"></div></div>
      <div class="wd-dot" onclick="go('week')"><div class="wd-d">Fri</div><div class="wd-ind wd-key"></div><div class="wd-key-lbl">KEY</div></div>
      <div class="wd-dot" onclick="go('week')"><div class="wd-d">Sat</div><div class="wd-ind wd-key"></div><div class="wd-key-lbl">KEY</div></div>
      <div class="wd-dot" onclick="go('week')"><div class="wd-d">Sun</div><div class="wd-ind wd-rest"></div></div>
    </div>
    <div style="text-align:right;margin-top:6px">
      <button class="btn btn-ghost btn-sm" onclick="go('week')">View full week →</button>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════
     ATHLETE: WEEK
══════════════════════════════════════ -->
<div class="screen" id="screen-week">
  <div class="ph">
    <div class="ph-row">
      <div>
        <div class="ph-t">My Week</div>
        <div class="ph-s">Week 9 of 20 · IM 70.3 Build · Feb 24 – Mar 1</div>
      </div>
    </div>
  </div>

  <!-- Execution score banner -->
  <div class="week-exec-banner">
    <div>
      <div class="web-label">Execution Score</div>
      <div class="web-score">
        <div class="web-score-num">74</div>
        <div class="web-score-of">/100</div>
      </div>
      <div class="web-trend">↑ +6 from last week</div>
    </div>
    <div class="web-div"></div>
    <div class="web-stat">
      <div class="web-stat-v">3/5</div>
      <div class="web-stat-l">Completed</div>
    </div>
    <div class="web-div"></div>
    <div class="web-stat">
      <div class="web-stat-v" style="color:var(--a)">2</div>
      <div class="web-stat-l">Key Left</div>
    </div>
    <div class="web-div"></div>
    <div class="web-stat">
      <div class="web-stat-v">88%</div>
      <div class="web-stat-l">Intensity Hit</div>
    </div>
    <div class="web-intent" style="margin-left:auto;max-width:200px">
      <div class="web-intent-lbl">Week Intent</div>
      <div class="web-intent-val">Build Threshold</div>
      <div class="web-intent-sub">4 quality sessions · Maintain aerobic base</div>
    </div>
  </div>

  <!-- Rolling next-week signal -->
  <div class="rolling-signal">
    <div class="rs-icon-lg">⟳</div>
    <div>
      <div class="rs-headline">Week 10 auto-building · 9.8h total · +8% load step · 2 key sessions</div>
      <div class="rs-detail-txt">Auto-generated Sunday based on your completion rate and current readiness trend.</div>
    </div>
    <button class="rs-cta-btn" onclick="openWeekReview()">Review next week →</button>
  </div>

  <!-- Day dots -->
  <div class="week-dots-strip" style="margin-bottom:16px">
    <div class="wd-dot" onclick="expandDay('mon')"><div class="wd-d">Mon</div><div class="wd-ind wd-done"></div></div>
    <div class="wd-dot" onclick="expandDay('tue')"><div class="wd-d">Tue</div><div class="wd-ind wd-done"></div></div>
    <div class="wd-dot" onclick="expandDay('wed')"><div class="wd-d">Wed</div><div class="wd-ind wd-rest"></div></div>
    <div class="wd-dot today-dot selected" id="wd-thu" onclick="expandDay('thu')"><div class="wd-d">Thu</div><div class="wd-ind wd-today"></div></div>
    <div class="wd-dot" onclick="expandDay('fri')"><div class="wd-d">Fri</div><div class="wd-ind wd-key"></div></div>
    <div class="wd-dot" onclick="expandDay('sat')"><div class="wd-d">Sat</div><div class="wd-ind wd-key"></div></div>
    <div class="wd-dot" onclick="expandDay('sun')"><div class="wd-d">Sun</div><div class="wd-ind wd-rest"></div></div>
  </div>

  <!-- Session cards -->
  <div class="plan-sessions">
    <!-- MON done -->
    <div class="psc done-l" id="psc-mon" onclick="togglePsc('mon')">
      <div class="psc-top">
        <div class="psc-day">Mon</div>
        <div class="psc-dot dot-s">🏊</div>
        <div class="psc-body">
          <div class="psc-name">Easy Swim</div>
          <div class="psc-meta"><span class="psc-dur">45 min · 2,400m</span><span class="chip cn">Easy / Recover</span><span class="chip cg">✓ Done</span></div>
        </div>
        <div class="psc-chev">▾</div>
      </div>
      <div class="psc-detail">
        <div class="psc-detail-inner">
          <div class="intent-summary">
            <div><div class="is-label">Easy / Recover</div><div class="is-sub">Zone 2 aerobic · Flush fatigue</div></div>
            <button class="struct-toggle" onclick="toggleStruct(event,'mon')">Show structure</button>
          </div>
          <div class="g-block g-wu"><div class="gb-lbl">Warmup</div><div class="gb-text">400m easy, mixing strokes</div><div class="gb-dur">8 min</div></div>
          <div class="g-block g-main"><div class="gb-lbl">Main</div><div class="gb-text">1,600m aerobic. Long, smooth strokes — no huffing.</div><div class="gb-dur">29 min</div></div>
          <div class="g-block g-cd"><div class="gb-lbl">Cooldown</div><div class="gb-text">400m easy backstroke or pull</div><div class="gb-dur">8 min</div></div>
          <div class="struct-view" id="struct-mon">
            <div class="struct-canvas"><div class="struct-bars">
              <div class="struct-blk sb-wu" style="width:38px;height:55%">WU</div>
              <div class="struct-blk sb-z2" style="width:120px;height:68%">Z2</div>
              <div class="struct-blk sb-cd" style="width:38px;height:38%">CD</div>
            </div></div>
            <div class="struct-targets">
              <div class="st-row"><div class="st-swatch" style="background:#60a5fa"></div><span>Zone 2 pace</span><span class="st-val">1:55–2:05/100m</span></div>
              <div class="st-row"><div class="st-swatch" style="background:#f87171"></div><span>HR target</span><span class="st-val">130–142 bpm</span></div>
            </div>
          </div>
        </div>
        <div class="psc-footer">
          <button class="btn-done">✓ Mark Done</button>
        </div>
      </div>
    </div>

    <!-- TUE key done -->
    <div class="psc key-l done-l" id="psc-tue" onclick="togglePsc('tue')">
      <div class="psc-top">
        <div class="psc-day">Tue</div>
        <div class="psc-dot dot-r">🏃</div>
        <div class="psc-body">
          <div class="psc-name">Threshold Run — 3×15min</div>
          <div class="psc-meta"><span class="psc-dur">65 min</span><span class="chip ca">⚡ KEY</span><span class="chip cg">✓ Done</span></div>
        </div>
        <div class="psc-chev">▾</div>
      </div>
      <div class="psc-detail">
        <div class="psc-detail-inner">
          <div class="intent-summary">
            <div><div class="is-label">Build Threshold</div><div class="is-sub">3 × 15 min at lactate threshold</div></div>
            <button class="struct-toggle hide" id="stbtn-tue" onclick="toggleStruct(event,'tue')">Hide structure</button>
          </div>
          <div class="struct-view show" id="struct-tue">
            <div class="struct-canvas"><div class="struct-bars">
              <div class="struct-blk sb-wu" style="width:28px;height:48%">WU</div>
              <div class="struct-blk sb-z4" style="width:44px;height:90%">Z4</div>
              <div class="struct-blk sb-rest" style="width:14px;height:32%">R</div>
              <div class="struct-blk sb-z4" style="width:44px;height:90%">Z4</div>
              <div class="struct-blk sb-rest" style="width:14px;height:32%">R</div>
              <div class="struct-blk sb-z4" style="width:44px;height:90%">Z4</div>
              <div class="struct-blk sb-cd" style="width:22px;height:38%">CD</div>
            </div></div>
            <div class="struct-targets">
              <div class="st-row"><div class="st-swatch" style="background:#f87171"></div><span>Zone 4 pace</span><span class="st-val">6:38–6:48/mi</span></div>
              <div class="st-row"><div class="st-swatch" style="background:#60a5fa"></div><span>HR target</span><span class="st-val">162–170 bpm</span></div>
              <div class="st-row"><div class="st-swatch" style="background:#374151"></div><span>Recovery jog</span><span class="st-val">3 min between</span></div>
            </div>
          </div>
        </div>
        <div class="psc-footer"><button class="btn-done">✓ Mark Done</button></div>
      </div>
    </div>

    <!-- WED rest -->
    <div class="rest-day-card">
      <div class="rdc-day">Wed</div>
      <div class="rdc-dot">—</div>
      <div><div class="rdc-lbl">Rest</div><div class="rdc-sub">Scheduled recovery</div></div>
    </div>

    <!-- THU TODAY key -->
    <div class="psc key-l open" id="psc-thu" onclick="togglePsc('thu')">
      <div class="psc-top">
        <div class="psc-day">Thu</div>
        <div class="psc-dot dot-b">🚴</div>
        <div class="psc-body">
          <div class="psc-name">Tempo Intervals — 4×8min</div>
          <div class="psc-meta"><span class="psc-dur">70 min · 95% FTP</span><span class="chip ca">⚡ KEY</span><span class="chip cb">Today</span></div>
        </div>
        <span class="psc-expand-hint">tap to collapse</span>
        <div class="psc-chev">▾</div>
      </div>
      <div class="psc-detail">
        <div class="psc-detail-inner">
          <div class="intent-summary">
            <div><div class="is-label">Build Threshold</div><div class="is-sub">Sweet Spot · 4 × 8 min at 90–95% FTP</div></div>
            <button class="struct-toggle hide" id="stbtn-thu" onclick="toggleStruct(event,'thu')">Hide structure</button>
          </div>
          <div class="struct-view show" id="struct-thu">
            <div class="struct-canvas"><div class="struct-bars">
              <div class="struct-blk sb-wu" style="width:26px;height:48%">WU</div>
              <div class="struct-blk sb-z4" style="width:38px;height:88%">Z4</div>
              <div class="struct-blk sb-rest" style="width:12px;height:34%">R</div>
              <div class="struct-blk sb-z4" style="width:38px;height:88%">Z4</div>
              <div class="struct-blk sb-rest" style="width:12px;height:34%">R</div>
              <div class="struct-blk sb-z4" style="width:38px;height:88%">Z4</div>
              <div class="struct-blk sb-rest" style="width:12px;height:34%">R</div>
              <div class="struct-blk sb-z4" style="width:38px;height:88%">Z4</div>
              <div class="struct-blk sb-cd" style="width:20px;height:36%">CD</div>
            </div></div>
            <div class="struct-targets">
              <div class="st-row"><div class="st-swatch" style="background:#a78bfa"></div><span>Sweet Spot power</span><span class="st-val">245–258W (90–95% FTP)</span></div>
              <div class="st-row"><div class="st-swatch" style="background:#f87171"></div><span>HR target</span><span class="st-val">158–168 bpm</span></div>
              <div class="st-row"><div class="st-swatch" style="background:#374151"></div><span>Recovery</span><span class="st-val">4 min between reps</span></div>
            </div>
            <div class="struct-adj">
              <button class="struct-adj-btn" onclick="showDivergence(event)">Can't do this today →</button>
              <button class="struct-adj-btn">Drop to 3 reps</button>
              <button class="struct-adj-btn">Reduce to 88% FTP</button>
            </div>
          </div>
        </div>
        <div class="psc-footer">
          <button class="btn-done">✓ Mark Done</button>
          <button class="btn-skip-sess" onclick="showDivergence(event)">Skip / Modified</button>
        </div>
      </div>
    </div>

    <!-- FRI key upcoming -->
    <div class="psc key-l" id="psc-fri" onclick="togglePsc('fri')">
      <div class="psc-top">
        <div class="psc-day">Fri</div>
        <div class="psc-dot dot-r">🏃</div>
        <div class="psc-body">
          <div class="psc-name">Long Run — Easy Effort</div>
          <div class="psc-meta"><span class="psc-dur">90 min · HR &lt;148</span><span class="chip ca">⚡ KEY</span></div>
        </div>
        <span class="psc-expand-hint">tap to expand</span>
        <div class="psc-chev">▾</div>
      </div>
      <div class="psc-detail">
        <div class="psc-detail-inner">
          <div class="intent-summary">
            <div><div class="is-label">Aerobic Base</div><div class="is-sub">Zone 2 long run · Conversational effort</div></div>
            <button class="struct-toggle" onclick="toggleStruct(event,'fri')">Show structure</button>
          </div>
          <div class="struct-view" id="struct-fri">
            <div class="struct-canvas"><div class="struct-bars">
              <div class="struct-blk sb-wu" style="width:20px;height:40%">WU</div>
              <div class="struct-blk sb-z2" style="width:160px;height:72%">Z2</div>
              <div class="struct-blk sb-cd" style="width:20px;height:35%">CD</div>
            </div></div>
            <div class="struct-targets">
              <div class="st-row"><div class="st-swatch" style="background:#60a5fa"></div><span>Zone 2 pace</span><span class="st-val">9:15–9:45/mi</span></div>
              <div class="st-row"><div class="st-swatch" style="background:#f87171"></div><span>HR ceiling</span><span class="st-val">&lt;148 bpm</span></div>
            </div>
          </div>
        </div>
        <div class="psc-footer">
          <button class="btn-done">✓ Mark Done</button>
          <button class="btn-skip-sess" onclick="showDivergence(event)">Skip / Modified</button>
        </div>
      </div>
    </div>

    <!-- SAT key upcoming -->
    <div class="psc key-l" id="psc-sat" onclick="togglePsc('sat')">
      <div class="psc-top">
        <div class="psc-day">Sat</div>
        <div class="psc-dot dot-b">🚴</div>
        <div class="psc-body">
          <div class="psc-name">Long Ride — Base Endurance</div>
          <div class="psc-meta"><span class="psc-dur">3h · 65–75% FTP</span><span class="chip ca">⚡ KEY</span></div>
        </div>
        <span class="psc-expand-hint">tap to expand</span>
        <div class="psc-chev">▾</div>
      </div>
      <div class="psc-detail">
        <div class="psc-detail-inner">
          <div class="intent-summary">
            <div><div class="is-label">Aerobic Base</div><div class="is-sub">3h steady state · Zone 2 power</div></div>
            <button class="struct-toggle" onclick="toggleStruct(event,'sat')">Show structure</button>
          </div>
          <div class="struct-view" id="struct-sat">
            <div class="struct-canvas"><div class="struct-bars">
              <div class="struct-blk sb-wu" style="width:18px;height:40%">WU</div>
              <div class="struct-blk sb-z2" style="width:200px;height:70%">Z2</div>
              <div class="struct-blk sb-cd" style="width:18px;height:35%">CD</div>
            </div></div>
            <div class="struct-targets">
              <div class="st-row"><div class="st-swatch" style="background:#60a5fa"></div><span>Zone 2 power</span><span class="st-val">175–195W (65–72% FTP)</span></div>
              <div class="st-row"><div class="st-swatch" style="background:#f87171"></div><span>HR range</span><span class="st-val">138–150 bpm</span></div>
            </div>
          </div>
        </div>
        <div class="psc-footer">
          <button class="btn-done">✓ Mark Done</button>
          <button class="btn-skip-sess" onclick="showDivergence(event)">Skip / Modified</button>
        </div>
      </div>
    </div>

    <!-- SUN rest -->
    <div class="rest-day-card">
      <div class="rdc-day">Sun</div>
      <div class="rdc-dot">—</div>
      <div><div class="rdc-lbl">Rest</div><div class="rdc-sub">Recovery · Prep for next week</div></div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════
     ATHLETE: PROGRESS
══════════════════════════════════════ -->
<div class="screen" id="screen-progress">
  <div class="ph">
    <div class="ph-row">
      <div><div class="ph-t">Progress</div><div class="ph-s">Did you execute the athlete you planned to be?</div></div>
      <div class="ph-actions">
        <div style="font-size:11px;color:var(--t4);font-family:'DM Mono',monospace">Last 28 days</div>
      </div>
    </div>
  </div>

  <!-- Execution score hero -->
  <div class="exec-score-hero">
    <div class="esh-number">74</div>
    <div>
      <div class="esh-label">Execution Score</div>
      <div class="esh-verdict">Consistently Building</div>
      <div class="esh-sub">You're completing key sessions and hitting target intensity. Streak is your strongest signal.</div>
    </div>
    <div class="esh-div"></div>
    <div class="esh-stat">
      <div class="esh-stat-v">↑</div>
      <div class="esh-stat-l">Trend</div>
      <div class="esh-trend-val">+6 vs prev</div>
    </div>
    <div class="esh-div"></div>
    <div class="esh-stat">
      <div class="esh-stat-v">4</div>
      <div class="esh-stat-l">Weeks scored</div>
    </div>
  </div>

  <!-- Five execution metrics -->
  <div class="exec-metrics">
    <div class="em-card">
      <div class="em-label">Completion Rate</div>
      <div class="em-value">87<span class="em-unit">%</span></div>
      <div class="em-sub em-trend-up">↑ +4% from last month</div>
      <div class="em-bar-wrap"><div class="em-bar" style="width:87%"></div></div>
    </div>
    <div class="em-card">
      <div class="em-label">Intensity Accuracy</div>
      <div class="em-value">88<span class="em-unit">%</span></div>
      <div class="em-sub em-trend-up">↑ Target zone hit rate</div>
      <div class="em-bar-wrap"><div class="em-bar" style="width:88%;background:var(--b)"></div></div>
    </div>
    <div class="em-card">
      <div class="em-label">Current Streak</div>
      <div class="em-value">11<span class="em-unit"> days</span></div>
      <div class="em-sub em-trend-up">↑ Personal best: 18 days</div>
      <div class="em-bar-wrap"><div class="em-bar" style="width:61%;background:var(--a)"></div></div>
    </div>
    <div class="em-card">
      <div class="em-label">Key Session Rate</div>
      <div class="em-value">3/4<span class="em-unit"> this week</span></div>
      <div class="em-sub em-trend-up">↑ 78% over 4 weeks</div>
      <div class="em-bar-wrap"><div class="em-bar" style="width:78%"></div></div>
    </div>
    <div class="em-card">
      <div class="em-label">Plan Adherence</div>
      <div class="em-value">3/4<span class="em-unit"> weeks</span></div>
      <div class="em-sub">All key sessions completed</div>
      <div class="em-bar-wrap"><div class="em-bar" style="width:75%;background:var(--gold)"></div></div>
    </div>
    <div class="em-card" style="display:flex;flex-direction:column;justify-content:center;align-items:center;background:var(--bg);border-style:dashed">
      <div style="font-size:24px;margin-bottom:6px">📊</div>
      <div style="font-size:12px;font-weight:600;color:var(--t3)">More metrics</div>
      <div style="font-size:11px;color:var(--t4);margin-top:2px">After 8 weeks</div>
    </div>
  </div>

  <!-- Weekly history -->
  <div class="exec-history">
    <div class="eh-header">
      <div class="eh-title">Weekly execution history</div>
      <div style="font-size:11px;color:var(--t3)">Last 4 weeks</div>
    </div>
    <div class="eh-row">
      <div class="eh-week">Feb 24 – Mar 1</div>
      <div class="eh-score-pill pill-md">74</div>
      <div class="eh-bars">
        <div class="eh-b done"></div><div class="eh-b done"></div><div class="eh-b rest"></div>
        <div class="eh-b key" style="opacity:.5"></div><div class="eh-b key" style="opacity:.3"></div><div class="eh-b key" style="opacity:.3"></div><div class="eh-b rest"></div>
      </div>
      <div class="eh-detail">3/5 · 2 key left</div>
    </div>
    <div class="eh-row">
      <div class="eh-week">Feb 17–23</div>
      <div class="eh-score-pill pill-hi">81</div>
      <div class="eh-bars">
        <div class="eh-b done"></div><div class="eh-b key"></div><div class="eh-b rest"></div>
        <div class="eh-b done"></div><div class="eh-b key"></div><div class="eh-b done"></div><div class="eh-b rest"></div>
      </div>
      <div class="eh-detail">5/6 · all key ✓</div>
    </div>
    <div class="eh-row">
      <div class="eh-week">Feb 10–16</div>
      <div class="eh-score-pill pill-hi">79</div>
      <div class="eh-bars">
        <div class="eh-b done"></div><div class="eh-b key"></div><div class="eh-b miss"></div>
        <div class="eh-b done"></div><div class="eh-b key"></div><div class="eh-b done"></div><div class="eh-b rest"></div>
      </div>
      <div class="eh-detail">5/6 · 1 miss</div>
    </div>
    <div class="eh-row">
      <div class="eh-week">Feb 3–9</div>
      <div class="eh-score-pill pill-md">68</div>
      <div class="eh-bars">
        <div class="eh-b done"></div><div class="eh-b miss"></div><div class="eh-b rest"></div>
        <div class="eh-b done"></div><div class="eh-b miss"></div><div class="eh-b done"></div><div class="eh-b rest"></div>
      </div>
      <div class="eh-detail">4/6 · 2 missed</div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════
     ATHLETE: DISCOVER
══════════════════════════════════════ -->
<div class="screen" id="screen-discover">
  <div class="ph"><div class="ph-t">Discover</div><div class="ph-s">Find your coach. Browse Coreformance verified programs.</div></div>

  <!-- Cady Core hero -->
  <div class="cady-hero">
    <div>
      <div class="ch-badge"><div class="cady-badge"><span class="cady-badge-icon">✦</span> Cady Core</div></div>
      <div class="ch-title">Coaches you can trust.</div>
      <div class="ch-sub">Cady Core is Coreformance's verification program. Every coach here has been vetted, credentialed, and approved. Not a marketplace — a curated directory of the best endurance coaches on the platform.</div>
    </div>
    <div class="ch-stats">
      <div class="ch-stat"><div class="ch-stat-val">47</div><div class="ch-stat-lbl">Verified coaches</div></div>
      <div class="ch-stat"><div class="ch-stat-val">12</div><div class="ch-stat-lbl">Sports covered</div></div>
      <div class="ch-stat"><div class="ch-stat-val">2,400+</div><div class="ch-stat-lbl">Active athletes</div></div>
    </div>
  </div>

  <!-- Filters -->
  <div class="discover-filters">
    <span class="df-lbl">Filter by:</span>
    <button class="fbtn active" onclick="dfFilter(this)">All Sports</button>
    <button class="fbtn" onclick="dfFilter(this)">🏊 Triathlon</button>
    <button class="fbtn" onclick="dfFilter(this)">🏃 Running</button>
    <button class="fbtn" onclick="dfFilter(this)">🚴 Cycling</button>
    <button class="fbtn active" style="margin-left:8px" onclick="dfFilter(this)">✦ Cady Core Only</button>
  </div>

  <!-- Coach grid -->
  <div class="coach-grid">
    <div class="coach-card" onclick="go('coach-profile')">
      <div class="coach-card-top">
        <div class="coach-avi-lg" style="background:var(--g1);color:var(--g);border-color:var(--g2)">JT</div>
        <div class="cady-verified"><span>✦</span> Cady Core</div>
      </div>
      <div class="coach-name">Jordan Taylor</div>
      <div class="coach-spec">Triathlon · Ironman Specialist · 12 years</div>
      <div class="coach-bio">"I coach working professionals who want to finish strong — not just finish. My athletes average 23% performance improvement in their first season."</div>
      <div class="coach-stats">
        <div class="cst"><div class="cst-val">34</div><div class="cst-lbl">Athletes</div></div>
        <div class="cst"><div class="cst-val">94%</div><div class="cst-lbl">Completion</div></div>
        <div class="cst"><div class="cst-val">4.9★</div><div class="cst-lbl">Rating</div></div>
      </div>
      <div><span class="prog-pill">20-wk IM 70.3</span><span class="prog-pill">16-wk Olympic</span><span class="prog-pill">Base Building</span></div>
    </div>

    <div class="coach-card">
      <div class="coach-card-top">
        <div class="coach-avi-lg" style="background:var(--b1);color:var(--b);border-color:var(--b2)">SR</div>
        <div class="cady-verified"><span>✦</span> Cady Core</div>
      </div>
      <div class="coach-name">Sam Rivera</div>
      <div class="coach-spec">Marathon · Boston Qualifier · 8 years</div>
      <div class="coach-bio">"Former D1 coach now working with age-groupers. I specialize in athletes who've plateaued and need to break through to the next level."</div>
      <div class="coach-stats">
        <div class="cst"><div class="cst-val">28</div><div class="cst-lbl">Athletes</div></div>
        <div class="cst"><div class="cst-val">91%</div><div class="cst-lbl">Completion</div></div>
        <div class="cst"><div class="cst-val">4.8★</div><div class="cst-lbl">Rating</div></div>
      </div>
      <div><span class="prog-pill">18-wk Marathon</span><span class="prog-pill">BQ Training</span><span class="prog-pill">Speed Block</span></div>
    </div>

    <div class="coach-card">
      <div class="coach-card-top">
        <div class="coach-avi-lg" style="background:var(--a1);color:var(--a);border-color:var(--a2)">DK</div>
        <div class="cady-verified"><span>✦</span> Cady Core</div>
      </div>
      <div class="coach-name">Dana Kim</div>
      <div class="coach-spec">Cycling · Gravel · FTP Development</div>
      <div class="coach-bio">"Power-based coaching for cyclists who want real numbers to train against. I turn data into decisions so you don't have to."</div>
      <div class="coach-stats">
        <div class="cst"><div class="cst-val">19</div><div class="cst-lbl">Athletes</div></div>
        <div class="cst"><div class="cst-val">96%</div><div class="cst-lbl">Completion</div></div>
        <div class="cst"><div class="cst-val">5.0★</div><div class="cst-lbl">Rating</div></div>
      </div>
      <div><span class="prog-pill">12-wk FTP Build</span><span class="prog-pill">Gravel Prep</span></div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════
     COACH PROFILE (Cady Core)
══════════════════════════════════════ -->
<div class="screen" id="screen-coach-profile">
  <div class="ph"><div class="ph-row">
    <div>
      <button class="btn btn-ghost btn-sm" style="margin-bottom:12px" onclick="go('discover')">← Back to Discover</button>
      <div class="ph-t">Jordan Taylor</div>
      <div class="ph-s">Cady Core Verified Coach</div>
    </div>
    <button class="btn btn-g" style="align-self:flex-start;margin-top:40px" onclick="openModal()">Enroll with Jordan</button>
  </div></div>
  <div class="verified-profile">
    <div class="vp-banner"><div style="position:absolute;top:14px;right:24px"><div class="cady-badge"><span class="cady-badge-icon">✦</span> Cady Core Verified</div></div></div>
    <div class="vp-avi">JT</div>
    <div class="vp-body">
      <div class="vp-name">Jordan Taylor</div>
      <div class="vp-creds"><div class="cady-verified"><span>✦</span> Cady Core</div><span class="chip cn">Triathlon</span><span class="chip cn">Ironman</span><span class="chip cn">12 years coaching</span></div>
      <div class="vp-bio">I coach working professionals who want to compete seriously without burning out. My methodology is rooted in aerobic base development, progressive overload, and intelligent recovery. My athletes finish races — and come back next year stronger.</div>
      <div class="g3" style="margin-bottom:18px">
        <div class="kpi"><div class="kpi-l">Athletes Coached</div><div class="kpi-v">34</div><div class="kpi-d">active this season</div></div>
        <div class="kpi"><div class="kpi-l">Avg Improvement</div><div class="kpi-v" style="color:var(--g)">+23%</div><div class="kpi-d" style="color:var(--g)">first season</div></div>
        <div class="kpi"><div class="kpi-l">Completion Rate</div><div class="kpi-v" style="color:var(--g)">94%</div><div class="kpi-d">of prescribed sessions</div></div>
      </div>
      <div class="sdiv">Programs</div>
      <div class="prog-grid">
        <div class="prog-card">
          <div class="prog-card-top"><div class="prog-icon" style="background:var(--b1)">🏊</div><span class="chip cg" style="font-size:10px">Open Enrollment</span></div>
          <div class="prog-name">20-Week Ironman 70.3</div>
          <div class="prog-meta">20 WEEKS · 6 SESSIONS/WK · INTERMEDIATE</div>
          <div class="prog-desc">Full periodized build from base to peak. Designed for athletes targeting 4:30–5:30 finish times with 8–12 hrs/week available.</div>
          <div class="prog-stats"><div><div class="pst-val">47</div><div class="pst-lbl">Enrolled</div></div><div><div class="pst-val" style="color:var(--g)">4.9★</div><div class="pst-lbl">Rating</div></div></div>
        </div>
        <div class="prog-card">
          <div class="prog-card-top"><div class="prog-icon" style="background:var(--g1)">🏃</div><span class="chip cg" style="font-size:10px">Open Enrollment</span></div>
          <div class="prog-name">16-Week Olympic Tri</div>
          <div class="prog-meta">16 WEEKS · 5 SESSIONS/WK · ALL LEVELS</div>
          <div class="prog-desc">Sprint to Olympic distance. Emphasis on pacing strategy and race-day execution. Good for first-timers and improvement-seekers.</div>
          <div class="prog-stats"><div><div class="pst-val">31</div><div class="pst-lbl">Enrolled</div></div><div><div class="pst-val" style="color:var(--g)">4.8★</div><div class="pst-lbl">Rating</div></div></div>
        </div>
        <div class="prog-card">
          <div class="prog-card-top"><div class="prog-icon" style="background:var(--a1)">⚡</div><span class="chip cn" style="font-size:10px">Waitlist</span></div>
          <div class="prog-name">Aerobic Base Build</div>
          <div class="prog-meta">12 WEEKS · 4 SESSIONS/WK · BEGINNER</div>
          <div class="prog-desc">For athletes returning from injury or building from scratch. Low intensity, high consistency. The foundation everything else is built on.</div>
          <div class="prog-stats"><div><div class="pst-val">22</div><div class="pst-lbl">Enrolled</div></div><div><div class="pst-val" style="color:var(--g)">5.0★</div><div class="pst-lbl">Rating</div></div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════
     COACH: ROSTER
══════════════════════════════════════ -->
<div class="screen" id="screen-roster">
  <div class="ph">
    <div class="ph-row">
      <div><div class="ph-t">Roster</div><div class="ph-s">12 athletes · Week 9 execution overview</div></div>
      <div class="ph-actions">
        <button class="btn btn-ghost btn-sm" onclick="go('invite')">+ Invite athlete</button>
      </div>
    </div>
  </div>

  <!-- Summary stats -->
  <div class="roster-summary-strip">
    <div class="rss-card"><div class="rss-v">12</div><div class="rss-l">Total Athletes</div></div>
    <div class="rss-card"><div class="rss-v" style="color:var(--g)">9</div><div class="rss-l">On Track</div></div>
    <div class="rss-card"><div class="rss-v" style="color:var(--a)">2</div><div class="rss-l">Need Attention</div></div>
    <div class="rss-card"><div class="rss-v" style="color:var(--r)">1</div><div class="rss-l">Off Track</div></div>
  </div>

  <!-- Flags -->
  <div class="flag-section">
    <div class="flag-section-title">🚩 Flags requiring attention</div>
    <div class="flag-card">
      <div class="flag-av">👤</div>
      <div>
        <div class="flag-name">Alex Chen</div>
        <div class="flag-detail">Missed 3 sessions this week · 0 key workouts completed · Last active 5d ago</div>
      </div>
      <button class="flag-action" onclick="showToast('Opening Alex Chen's plan')">View plan →</button>
    </div>
    <div class="flag-card flag-amber">
      <div class="flag-av">👤</div>
      <div>
        <div class="flag-name">Sam Torres</div>
        <div class="flag-detail">Execution score dropped 18 pts week-over-week · Intensity consistently below target</div>
      </div>
      <button class="flag-action" onclick="showToast('Opening Sam Torres')">View plan →</button>
    </div>
    <div class="flag-card flag-info">
      <div class="flag-av">👤</div>
      <div>
        <div class="flag-name">Maya Patel</div>
        <div class="flag-detail">Ahead of plan · Execution score 96 · Consider adding volume for next week</div>
      </div>
      <button class="flag-action" onclick="showToast('Opening Maya Patel')">Adjust plan →</button>
    </div>
  </div>

  <!-- Athlete grid -->
  <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--t4);font-family:'DM Mono',monospace;margin-bottom:10px">All athletes</div>
  <div class="athlete-grid">
    <div class="ath-card" onclick="openPreview('Marcus Reid','TRIATHLON · Self-coached · Exec 74/100')">
      <div class="ath-top"><div class="ath-av">🏃</div><div><div class="ath-name">Marcus Reid</div><div class="ath-sport">TRIATHLON · Self-coached</div></div></div>
      <div class="ath-exec">
        <div><div class="ath-exec-score">74</div><div class="ath-exec-label">Exec score</div></div>
        <div class="ath-dots"><div class="ath-dot ad-done"></div><div class="ath-dot ad-done"></div><div class="ath-dot ad-rest"></div><div class="ath-dot ad-key"></div><div class="ath-dot ad-key"></div><div class="ath-dot ad-rest"></div></div>
      </div>
    </div>
    <div class="ath-card" onclick="openPreview('Jordan Reynolds','CYCLING · 20-wk IM 70.3 · Exec 88/100')">
      <div class="ath-top"><div class="ath-av">🚴</div><div><div class="ath-name">Jordan Reynolds</div><div class="ath-sport">CYCLING · 20-wk IM 70.3</div></div></div>
      <div class="ath-exec">
        <div><div class="ath-exec-score">88</div><div class="ath-exec-label">Exec score</div></div>
        <div class="ath-dots"><div class="ath-dot ad-done"></div><div class="ath-dot ad-key"></div><div class="ath-dot ad-rest"></div><div class="ath-dot ad-done"></div><div class="ath-dot ad-key"></div><div class="ath-dot ad-done"></div></div>
      </div>
    </div>
    <div class="ath-card" onclick="openPreview('Maya Patel','TRIATHLON · 16-wk build · Exec 96/100')">
      <div class="ath-top"><div class="ath-av">🏊</div><div><div class="ath-name">Maya Patel</div><div class="ath-sport">TRIATHLON · 16-wk build</div></div></div>
      <div class="ath-exec">
        <div><div class="ath-exec-score" style="color:var(--g)">96</div><div class="ath-exec-label">Exec score</div></div>
        <div class="ath-dots"><div class="ath-dot ad-done"></div><div class="ath-dot ad-key"></div><div class="ath-dot ad-done"></div><div class="ath-dot ad-done"></div><div class="ath-dot ad-key"></div><div class="ath-dot ad-done"></div></div>
      </div>
    </div>
    <div class="ath-card" onclick="openPreview('Sam Torres','RUNNING · Marathon prep · Exec 61/100')">
      <div class="ath-top"><div class="ath-av">🏃</div><div><div class="ath-name">Sam Torres</div><div class="ath-sport">RUNNING · Marathon prep</div></div></div>
      <div class="ath-exec">
        <div><div class="ath-exec-score" style="color:var(--a)">61</div><div class="ath-exec-label">Exec score</div></div>
        <div class="ath-dots"><div class="ath-dot ad-done"></div><div class="ath-dot ad-miss"></div><div class="ath-dot ad-rest"></div><div class="ath-dot ad-done"></div><div class="ath-dot ad-miss"></div><div class="ath-dot ad-done"></div></div>
      </div>
    </div>
    <div class="ath-card" onclick="openPreview('Alex Chen','CYCLING · Base build · Exec 34/100')">
      <div class="ath-top"><div class="ath-av">🚴</div><div><div class="ath-name">Alex Chen</div><div class="ath-sport">CYCLING · Base build</div></div></div>
      <div class="ath-exec">
        <div><div class="ath-exec-score" style="color:var(--r)">34</div><div class="ath-exec-label">Exec score</div></div>
        <div class="ath-dots"><div class="ath-dot ad-miss"></div><div class="ath-dot ad-miss"></div><div class="ath-dot ad-miss"></div><div class="ath-dot ad-miss"></div><div class="ath-dot ad-miss"></div><div class="ath-dot ad-miss"></div></div>
      </div>
    </div>
    <div class="ath-card" style="border-style:dashed;background:var(--sur3);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;cursor:pointer" onclick="go('invite')">
      <div style="font-size:22px">＋</div>
      <div style="font-size:12px;font-weight:600;color:var(--t3)">Invite athlete</div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════
     COACH: INVITE
══════════════════════════════════════ -->
<div class="screen" id="screen-invite">
  <div class="ph">
    <div class="ph-row">
      <div><div class="ph-t">Invite &amp; Keys</div><div class="ph-s">Generate activation keys for new athletes.</div></div>
    </div>
  </div>
  <div class="g2" style="max-width:700px">
    <div class="card">
      <div style="font-size:13px;font-weight:700;margin-bottom:4px">Generate a new key</div>
      <div style="font-size:12px;color:var(--t3);margin-bottom:16px">Each key is single-use and links the athlete to your roster and their assigned program.</div>
      <div style="margin-bottom:12px">
        <label style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--t4);font-family:'DM Mono',monospace;display:block;margin-bottom:6px">Assign program (optional)</label>
        <select style="width:100%;padding:9px 12px;border-radius:var(--rad-s);border:1.5px solid var(--bd);background:var(--sur3);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--t1)">
          <option>No program — athlete chooses later</option>
          <option>20-Week IM 70.3 Base to Race</option>
          <option>16-Week Marathon Block</option>
          <option>12-Week Cycling FTP Builder</option>
        </select>
      </div>
      <button class="btn btn-dark btn-sm" onclick="showToast('Key generated: CF—A7K2—XM9P')">Generate Key</button>
      <div style="margin-top:14px;padding:12px 16px;background:var(--bg2);border-radius:var(--rad-s);font-family:'DM Mono',monospace;font-size:18px;letter-spacing:.15em;color:var(--t1);text-align:center" id="gen-key-display">CF—A7K2—XM9P</div>
    </div>
    <div class="card">
      <div style="font-size:13px;font-weight:700;margin-bottom:16px">Recent keys</div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--bd)">
          <div style="font-family:'DM Mono',monospace;font-size:13px;letter-spacing:.08em;flex:1">CF—R3J8—WX4L</div>
          <span class="chip cg">Used</span>
          <div style="font-size:11px;color:var(--t4)">Jordan R.</div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--bd)">
          <div style="font-family:'DM Mono',monospace;font-size:13px;letter-spacing:.08em;flex:1">CF—M9P2—KV7Q</div>
          <span class="chip cg">Used</span>
          <div style="font-size:11px;color:var(--t4)">Maya P.</div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;padding:8px 0">
          <div style="font-family:'DM Mono',monospace;font-size:13px;letter-spacing:.08em;flex:1">CF—A7K2—XM9P</div>
          <span class="chip cb">Active</span>
          <div style="font-size:11px;color:var(--t4)">Unused</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════
     COACH: SCHEDULE
══════════════════════════════════════ -->
<div class="screen" id="screen-schedule">
  <div class="ph"><div class="ph-row">
    <div><div class="ph-t">Schedule</div><div class="ph-s">Assign workouts across your roster. Click any day to edit.</div></div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn btn-ghost btn-sm" onclick="schedChangeMonth(-1)" id="sched-prev">← Jan</button>
      <div id="sched-month-lbl" style="font-size:15px;font-weight:700;padding:0 8px">February 2026</div>
      <button class="btn btn-ghost btn-sm" onclick="schedChangeMonth(1)" id="sched-next">Mar →</button>
      <button class="btn btn-b btn-sm" style="margin-left:8px" onclick="openWeekReview()">✦ Generate Plan</button>
    </div>
  </div></div>

  <!-- AI generation signal -->
  <div class="coach-gen-signal">
    <div style="font-size:18px;color:rgba(255,255,255,.5)">⟳</div>
    <div class="cgs-text"><strong>4 athletes · Next week auto-builds Sunday night</strong>Weekly review ready: +8% load step · 2 compliance flags · Approve or adjust in 30 seconds</div>
    <button class="cgs-cta" onclick="openWeekReview()">Review Now →</button>
  </div>

  <!-- Athlete filter row -->
  <div class="coach-ath-filter-row">
    <div class="caf-pill active" onclick="schedFilterAth(this,'Marcus Reid')"><div class="caf-dot" style="background:var(--g)"></div>Marcus Reid</div>
    <div class="caf-pill" onclick="schedFilterAth(this,'Sarah Chen')"><div class="caf-dot" style="background:var(--r)"></div>Sarah Chen <span class="chip cr" style="font-size:8px;margin-left:4px">⚠</span></div>
    <div class="caf-pill" onclick="schedFilterAth(this,'Derek Osei')"><div class="caf-dot" style="background:var(--a)"></div>Derek Osei</div>
    <div class="caf-pill" onclick="schedFilterAth(this,'Aisha Lawson')"><div class="caf-dot" style="background:var(--b)"></div>Aisha Lawson</div>
    <div class="caf-pill" style="margin-left:auto;color:var(--t4);border-style:dashed" onclick="schedFilterAth(this,'all')">All Athletes</div>
  </div>

  <!-- Calendar + detail layout -->
  <div style="display:flex;gap:14px;align-items:flex-start">
  <div style="flex:1;min-width:0">
  <!-- Calendar grid -->
  <div class="cal-grid">
    <div class="cal-day-head">Sun</div><div class="cal-day-head">Mon</div><div class="cal-day-head">Tue</div><div class="cal-day-head">Wed</div><div class="cal-day-head">Thu</div><div class="cal-day-head">Fri</div><div class="cal-day-head">Sat</div>
    <!-- Row 1: prev month overflow -->
    <div class="cal-day other-month"><div class="cdn">26</div></div>
    <div class="cal-day other-month"><div class="cdn">27</div></div>
    <div class="cal-day other-month"><div class="cdn">28</div></div>
    <div class="cal-day other-month"><div class="cdn">29</div></div>
    <div class="cal-day other-month"><div class="cdn">30</div></div>
    <div class="cal-day other-month"><div class="cdn">31</div></div>
    <div class="cal-day" onclick="schedCalDayClick(this,'Feb 1')"><div class="cdn">1</div><div class="cal-wo run">MR · Z2 Run</div></div>
    <!-- Row 2 -->
    <div class="cal-day"><div class="cdn">2</div><div class="cal-wo run">MR · Z2 Run</div><div class="cal-wo bike">AL · Bike</div></div>
    <div class="cal-day"><div class="cdn">3</div><div class="cal-wo bike">MR · Tempo</div></div>
    <div class="cal-day"><div class="cdn">4</div><div class="cal-wo run">SC · Easy Run</div></div>
    <div class="cal-day"><div class="cdn">5</div><div class="cal-wo swim">AL · Swim</div></div>
    <div class="cal-day"><div class="cdn">6</div><div class="cal-wo bike">DO · Threshold</div></div>
    <div class="cal-day"><div class="cdn">7</div><div class="cal-wo run">MR · Long Run</div><div class="cal-wo bike">AL · Long Ride</div></div>
    <div class="cal-day rest"><div class="cdn">8</div><div class="cal-wo rest">Rest Day</div></div>
    <!-- Row 3 -->
    <div class="cal-day"><div class="cdn">9</div><div class="cal-wo run">MR · Intervals</div></div>
    <div class="cal-day"><div class="cdn">10</div><div class="cal-wo bike">AL · Z2 Ride</div></div>
    <div class="cal-day"><div class="cdn">11</div><div class="cal-wo run">SC · Tempo</div></div>
    <div class="cal-day"><div class="cdn">12</div><div class="cal-wo swim">MR · OWS Drill</div></div>
    <div class="cal-day"><div class="cdn">13</div><div class="cal-wo bike">DO · Aerobic</div></div>
    <div class="cal-day"><div class="cdn">14</div><div class="cal-wo run">MR · Long Run</div></div>
    <div class="cal-day rest"><div class="cdn">15</div><div class="cal-wo rest">Rest Day</div></div>
    <!-- Row 4 -->
    <div class="cal-day"><div class="cdn">16</div><div class="cal-wo bike">MR · Sweet Spot</div></div>
    <div class="cal-day today"><div class="cdn">17</div><div class="cal-wo run">AL · Recovery</div></div>
    <div class="cal-day cal-selected" onclick="schedCalDayClick(this,'Feb 18')"><div class="cdn">18</div><div class="cal-wo run">MR · Threshold</div><div class="cal-wo bike">SC · Bike</div></div>
    <div class="cal-day"><div class="cdn">19</div><div class="cal-wo swim">AL · Swim</div></div>
    <div class="cal-day"><div class="cdn">20</div><div class="cal-wo bike">MR · FTP</div></div>
    <div class="cal-day"><div class="cdn">21</div><div class="cal-wo run">MR · Long Run</div></div>
    <div class="cal-day rest"><div class="cdn">22</div><div class="cal-wo rest">Rest Day</div></div>
    <!-- Row 5 -->
    <div class="cal-day"><div class="cdn">23</div><div class="cal-wo run">MR · Z2</div></div>
    <div class="cal-day"><div class="cdn">24</div><div class="cal-wo bike">DO · Endurance</div></div>
    <div class="cal-day"><div class="cdn">25</div><div class="cal-wo run">SC · Interval</div></div>
    <div class="cal-day"><div class="cdn">26</div><div class="cal-wo swim">MR · Swim</div></div>
    <div class="cal-day"><div class="cdn">27</div><div class="cal-wo bike">AL · Threshold</div></div>
    <div class="cal-day"><div class="cdn">28</div><div class="cal-wo run">MR · Long Run</div></div>
    <div class="cal-day other-month"><div class="cdn">1</div></div>
    <!-- Row 6 -->
    <div class="cal-day other-month"><div class="cdn">2</div></div>
    <div class="cal-day other-month"><div class="cdn">3</div></div>
    <div class="cal-day other-month"><div class="cdn">4</div></div>
    <div class="cal-day other-month"><div class="cdn">5</div></div>
    <div class="cal-day other-month"><div class="cdn">6</div></div>
    <div class="cal-day other-month"><div class="cdn">7</div></div>
    <div class="cal-day other-month"><div class="cdn">8</div></div>
  </div><!-- /cal-grid -->
  </div><!-- /cal-flex-left -->

  <!-- Day detail panel (right side) -->
  <div id="sched-day-panel" style="width:260px;flex-shrink:0;background:var(--sur);border:1px solid var(--bd);border-radius:var(--rad);padding:16px;box-shadow:var(--sh);display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
      <div id="sdp-date" style="font-size:13px;font-weight:800;color:var(--t1)">Feb 18</div>
      <button onclick="document.getElementById('sched-day-panel').style.display='none'" style="background:none;border:none;font-size:16px;color:var(--t3);cursor:pointer">✕</button>
    </div>
    <div id="sdp-workouts" style="display:flex;flex-direction:column;gap:6px;margin-bottom:14px"></div>
    <button class="btn btn-ghost btn-sm" style="width:100%;justify-content:center" onclick="openBuilder()">+ Add Workout</button>
    <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--bd)">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--t4);margin-bottom:6px">Quick assign</div>
      <select style="width:100%;padding:6px 10px;border-radius:var(--rad-s);border:1px solid var(--bd);background:var(--sur3);font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;color:var(--t1)">
        <option>Zone 2 Aerobic Run</option>
        <option>Tempo 3×15min</option>
        <option>Sweet Spot Intervals</option>
        <option>Long Run</option>
        <option>Rest Day</option>
      </select>
      <select style="width:100%;padding:6px 10px;border-radius:var(--rad-s);border:1px solid var(--bd);background:var(--sur3);font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;color:var(--t1);margin-top:5px">
        <option>Marcus Reid</option>
        <option>Sarah Chen</option>
        <option>Derek Osei</option>
        <option>Aisha Lawson</option>
        <option>All Athletes</option>
      </select>
      <button class="btn btn-b btn-sm" style="width:100%;justify-content:center;margin-top:8px" onclick="showToast('Workout assigned')">Assign</button>
    </div>
  </div>
  </div><!-- /cal-layout flex row -->
</div>
<!-- ══════════════════════════════════════
     COACH: PLAN ASSIGNMENT
══════════════════════════════════════ -->
<div class="screen" id="screen-plan-assign">
  <div class="ph">
    <div class="ph-row">
      <div><div class="ph-t">Plan Assignment</div><div class="ph-s">Assign programs to individual athletes or groups.</div></div>
      <div class="ph-actions">
        <button class="btn btn-ghost btn-sm" onclick="go('schedule')">← Back to Schedule</button>
      </div>
    </div>
  </div>
  <div class="g2">
    <div class="card">
      <div style="font-size:13px;font-weight:700;margin-bottom:12px">Assign a program</div>
      <div style="margin-bottom:12px">
        <label style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--t4);font-family:'DM Mono',monospace;display:block;margin-bottom:6px">Select athlete</label>
        <select style="width:100%;padding:9px 12px;border-radius:var(--rad-s);border:1.5px solid var(--bd);background:var(--sur3);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px">
          <option>Marcus Reid</option><option>Jordan Reynolds</option><option>Maya Patel</option><option>Sam Torres</option>
        </select>
      </div>
      <div style="margin-bottom:12px">
        <label style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--t4);font-family:'DM Mono',monospace;display:block;margin-bottom:6px">Select program</label>
        <select style="width:100%;padding:9px 12px;border-radius:var(--rad-s);border:1.5px solid var(--bd);background:var(--sur3);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px">
          <option>20-Week IM 70.3 Base to Race</option><option>16-Week Marathon Block</option><option>12-Week Cycling FTP Builder</option>
        </select>
      </div>
      <div style="margin-bottom:16px">
        <label style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--t4);font-family:'DM Mono',monospace;display:block;margin-bottom:6px">Start date</label>
        <input type="date" style="width:100%;padding:9px 12px;border-radius:var(--rad-s);border:1.5px solid var(--bd);background:var(--sur3);font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--t1)" value="2026-03-02">
      </div>
      <button class="btn btn-b btn-sm" onclick="showToast('Program assigned — athlete notified')">Assign Program</button>
    </div>
    <div class="card">
      <div style="font-size:13px;font-weight:700;margin-bottom:12px">Current assignments</div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <div style="padding:10px 12px;background:var(--sur3);border-radius:8px;border-left:3px solid var(--b)">
          <div style="font-weight:700;font-size:13px">Jordan Reynolds</div>
          <div style="font-size:11px;color:var(--t3);font-family:'DM Mono',monospace">20-Week IM 70.3 · Week 9 of 20 · Started Jan 5</div>
        </div>
        <div style="padding:10px 12px;background:var(--sur3);border-radius:8px;border-left:3px solid var(--g)">
          <div style="font-weight:700;font-size:13px">Maya Patel</div>
          <div style="font-size:11px;color:var(--t3);font-family:'DM Mono',monospace">16-Week Tri Build · Week 12 of 16 · Started Nov 18</div>
        </div>
        <div style="padding:10px 12px;background:var(--sur3);border-radius:8px;border-left:3px solid var(--a)">
          <div style="font-weight:700;font-size:13px">Sam Torres</div>
          <div style="font-size:11px;color:var(--t3);font-family:'DM Mono',monospace">16-Week Marathon · Week 6 of 16 · Started Jan 19</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════
     COACH: PROGRAMS
══════════════════════════════════════ -->
<div class="screen" id="screen-programs">
  <div class="ph"><div class="ph-row">
    <div><div class="ph-t">Programs</div><div class="ph-s">Your training plan library. Build, assign, and publish.</div></div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost btn-sm" onclick="showImportModal()">⬇ Import Plan</button>
      <button class="btn btn-b btn-sm" onclick="progTab('builder',document.querySelector('.prog-tab:nth-child(3)'));openBuilder()">+ New Program</button>
    </div>
  </div></div>

  <!-- Tabs -->
  <div class="prog-tabs">
    <button class="prog-tab active" onclick="progTab('library',this)">Workout Library</button>
    <button class="prog-tab" onclick="progTab('programs',this)">Programs</button>
    <button class="prog-tab" onclick="progTab('builder',this)">Program Builder</button>
  </div>

  <!-- ── TAB: WORKOUT LIBRARY ── -->
  <div id="prog-panel-library">
    <!-- Toolbar -->
    <div style="margin-bottom:14px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button class="btn btn-ghost btn-sm" onclick="openBuilder()">+ New Workout</button>
      <button class="btn btn-ghost btn-sm" onclick="showToast('Filter: Cycling')">🚴 Cycling</button>
      <button class="btn btn-ghost btn-sm" onclick="showToast('Filter: Running')">🏃 Running</button>
      <button class="btn btn-ghost btn-sm" onclick="showToast('Filter: Swimming')">🏊 Swimming</button>
      <button class="btn btn-ghost btn-sm" style="margin-left:auto" onclick="showImportModal()">⬇ Import from TrainingPeaks</button>
    </div>
    <!-- Workout list - v10 style -->
    <div class="wo-card">
      <div class="wo-top">
        <div class="wo-sport dot-b">🚴</div>
        <div><div class="wo-name">Tempo Intervals — 4×8min</div><div class="wo-meta">70 min · 95% FTP · Build Threshold</div></div>
        <div class="wo-actions">
          <span class="chip sport-cyc">Cycling</span>
          <button class="wo-btn" onclick="openBuilder()">Edit</button>
          <button class="wo-btn primary" onclick="showToast('Assigning workout')">Assign</button>
        </div>
      </div>
    </div>
    <div class="wo-card">
      <div class="wo-top">
        <div class="wo-sport dot-r">🏃</div>
        <div><div class="wo-name">Threshold Run — 3×15min</div><div class="wo-meta">65 min · Lactate threshold · Z4</div></div>
        <div class="wo-actions">
          <span class="chip sport-run">Running</span>
          <button class="wo-btn" onclick="openBuilder()">Edit</button>
          <button class="wo-btn primary" onclick="showToast('Assigning workout')">Assign</button>
        </div>
      </div>
    </div>
    <div class="wo-card">
      <div class="wo-top">
        <div class="wo-sport dot-s">🏊</div>
        <div><div class="wo-name">CSS Intervals — 10×100m</div><div class="wo-meta">50 min · CSS pace · Aerobic power</div></div>
        <div class="wo-actions">
          <span class="chip sport-swim">Swimming</span>
          <button class="wo-btn" onclick="openBuilder()">Edit</button>
          <button class="wo-btn primary" onclick="showToast('Assigning workout')">Assign</button>
        </div>
      </div>
    </div>
    <div class="wo-card">
      <div class="wo-top">
        <div class="wo-sport dot-b">🚴</div>
        <div><div class="wo-name">Long Ride — Base Endurance</div><div class="wo-meta">3h · 65–75% FTP · Zone 2</div></div>
        <div class="wo-actions">
          <span class="chip sport-cyc">Cycling</span>
          <button class="wo-btn" onclick="openBuilder()">Edit</button>
          <button class="wo-btn primary" onclick="showToast('Assigning workout')">Assign</button>
        </div>
      </div>
    </div>
    <div class="wo-card">
      <div class="wo-top">
        <div class="wo-sport dot-r">🏃</div>
        <div><div class="wo-name">Zone 2 Aerobic Run</div><div class="wo-meta">55 min · Z2 · Aerobic base</div></div>
        <div class="wo-actions">
          <span class="chip sport-run">Running</span>
          <button class="wo-btn" onclick="openBuilder()">Edit</button>
          <button class="wo-btn primary" onclick="showToast('Assigning workout')">Assign</button>
        </div>
      </div>
    </div>
    <div class="wo-card">
      <div class="wo-top">
        <div class="wo-sport dot-r">🏃</div>
        <div><div class="wo-name">Long Run</div><div class="wo-meta">90 min · Z2 · Weekly long effort</div></div>
        <div class="wo-actions">
          <span class="chip sport-run">Running</span>
          <button class="wo-btn" onclick="openBuilder()">Edit</button>
          <button class="wo-btn primary" onclick="showToast('Assigning workout')">Assign</button>
        </div>
      </div>
    </div>
    <div class="wo-card">
      <div class="wo-top">
        <div class="wo-sport dot-s">🏊</div>
        <div><div class="wo-name">Aerobic Endurance Swim</div><div class="wo-meta">45 min · CSS pace · Base fitness</div></div>
        <div class="wo-actions">
          <span class="chip sport-swim">Swimming</span>
          <button class="wo-btn" onclick="openBuilder()">Edit</button>
          <button class="wo-btn primary" onclick="showToast('Assigning workout')">Assign</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ── TAB: PROGRAMS ── -->
  <div id="prog-panel-programs" style="display:none">
    <div class="prog-grid">
      <div class="prog-card" onclick="progTab('builder',document.querySelector('.prog-tab:nth-child(3)'))">
        <div class="prog-card-top"><div class="prog-icon" style="background:var(--b1)">🏊</div><div class="cady-verified"><span>✦</span> Published</div></div>
        <div class="prog-name">20-Week Ironman 70.3</div>
        <div class="prog-meta">20 WEEKS · 6/WK · INTERMEDIATE · <span style="color:var(--g);font-weight:700">47 ENROLLED</span></div>
        <div class="prog-desc">Full periodized build. Swim, bike, run. Designed for athletes targeting 4:30–5:30 finish times.</div>
        <div class="prog-stats">
          <div><div class="pst-val" style="color:var(--g)">47</div><div class="pst-lbl">Enrolled</div></div>
          <div><div class="pst-val">6</div><div class="pst-lbl">My Athletes</div></div>
          <div><div class="pst-val" style="color:var(--g)">4.9★</div><div class="pst-lbl">Rating</div></div>
        </div>
      </div>
      <div class="prog-card">
        <div class="prog-card-top"><div class="prog-icon" style="background:var(--g1)">🏃</div><div class="chip cg" style="font-size:10px">Active</div></div>
        <div class="prog-name">16-Week Olympic Tri</div>
        <div class="prog-meta">16 WEEKS · 5/WK · ALL LEVELS · <span style="color:var(--g);font-weight:700">31 ENROLLED</span></div>
        <div class="prog-desc">Sprint to Olympic distance. Pacing strategy and race-day execution emphasis.</div>
        <div class="prog-stats">
          <div><div class="pst-val" style="color:var(--g)">31</div><div class="pst-lbl">Enrolled</div></div>
          <div><div class="pst-val">4</div><div class="pst-lbl">My Athletes</div></div>
          <div><div class="pst-val" style="color:var(--g)">4.8★</div><div class="pst-lbl">Rating</div></div>
        </div>
      </div>
      <div class="prog-card">
        <div class="prog-card-top"><div class="prog-icon" style="background:var(--a1)">⚡</div><div class="chip cn" style="font-size:10px">Draft</div></div>
        <div class="prog-name">12-Week Base Build</div>
        <div class="prog-meta">12 WEEKS · 4/WK · BEGINNER · IN PROGRESS</div>
        <div class="prog-desc">Foundation block. Low intensity, high consistency. For returning or new athletes.</div>
        <div class="prog-stats">
          <div><div class="pst-val muted">—</div><div class="pst-lbl">Enrolled</div></div>
          <div><div class="pst-val">2</div><div class="pst-lbl">My Athletes</div></div>
          <div><div class="pst-val muted">Draft</div><div class="pst-lbl">Status</div></div>
        </div>
      </div>
    </div>

    <!-- Import from TrainingPeaks CTA -->
    <div style="background:var(--b1);border:1px solid var(--b2);border-radius:var(--rad);padding:18px 22px;display:grid;grid-template-columns:1fr auto;gap:20px;align-items:center;margin-top:14px">
      <div>
        <div style="font-weight:700;font-size:15px;margin-bottom:4px">Migrating from TrainingPeaks?</div>
        <div style="font-size:13px;color:var(--t2);line-height:1.5">Import your existing plans and workout libraries. Athletes keep their training history. Programs are automatically converted to Coreformance format with full drag-and-drop editing.</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn btn-b btn-sm" onclick="showImportModal()">Import Programs</button>
        <button class="btn btn-ghost btn-sm" onclick="showImportModal()">Import Workouts</button>
      </div>
    </div>
  </div>

  <!-- ── TAB: PROGRAM BUILDER (v9 drag-drop canvas) ── -->
  <div id="prog-panel-builder" style="display:none">
    <div class="library-layout">
      <!-- Left sidebar: workout library -->
      <div class="lib-sidebar">
        <div class="lib-header">
          <div class="lib-title"><span>Workout Library</span><span style="font-family:'DM Mono',monospace;font-size:10px;color:var(--t4);font-weight:400">24 workouts</span></div>
          <input class="lib-search" placeholder="🔍  Search workouts…" oninput="filterLibSearch(this.value)">
          <div class="lib-filters">
            <button class="lib-filter active" onclick="filterLib(this,'all')">All</button>
            <button class="lib-filter" onclick="filterLib(this,'run')">🏃 Run</button>
            <button class="lib-filter" onclick="filterLib(this,'bike')">🚴 Bike</button>
            <button class="lib-filter" onclick="filterLib(this,'swim')">🏊 Swim</button>
          </div>
        </div>
        <div class="lib-body" id="lib-body">
          <div class="lib-section-lbl">Running</div>
          <div class="wo-card" draggable="true" data-type="run" data-id="r1" data-name="Zone 2 Aerobic Run" data-dur="55 min" ondragstart="libDragStart(event)" ondragend="libDragEnd(event)">
            <div class="wo-card-top"><div class="wo-type-dot run-dot"></div><div class="wo-name">Zone 2 Aerobic Run</div><div class="wo-duration">55 min</div><div class="wo-card-actions"><div class="wca-btn" onclick="openBuilder()">✎</div></div></div>
            <div class="wo-intervals"><div class="wi wi-warmup" style="width:18px;height:35%"></div><div class="wi wi-work" style="width:88px;height:68%"></div><div class="wi wi-cool" style="width:14px;height:28%"></div></div>
            <div class="wo-tags"><span class="wo-tag tag-z2">z2</span><span class="wo-tag tag-long">aerobic</span></div>
          </div>
          <div class="wo-card" draggable="true" data-type="run" data-id="r2" data-name="5K Race Pace" data-dur="50 min" ondragstart="libDragStart(event)" ondragend="libDragEnd(event)">
            <div class="wo-card-top"><div class="wo-type-dot run-dot"></div><div class="wo-name">5K Race Pace</div><div class="wo-duration">50 min</div><div class="wo-card-actions"><div class="wca-btn" onclick="openBuilder()">✎</div></div></div>
            <div class="wo-intervals"><div class="wi wi-warmup" style="width:12px;height:40%"></div><div class="wi wi-high" style="width:9px;height:100%"></div><div class="wi wi-rest" style="width:5px;height:28%"></div><div class="wi wi-high" style="width:9px;height:100%"></div><div class="wi wi-rest" style="width:5px;height:28%"></div><div class="wi wi-high" style="width:9px;height:100%"></div><div class="wi wi-cool" style="width:12px;height:32%"></div></div>
            <div class="wo-tags"><span class="wo-tag tag-vo2">vo2</span><span class="wo-tag tag-race">race-pace</span></div>
          </div>
          <div class="wo-card" draggable="true" data-type="run" data-id="r3" data-name="Long Run" data-dur="90 min" ondragstart="libDragStart(event)" ondragend="libDragEnd(event)">
            <div class="wo-card-top"><div class="wo-type-dot run-dot"></div><div class="wo-name">Long Run</div><div class="wo-duration">90 min</div><div class="wo-card-actions"><div class="wca-btn" onclick="openBuilder()">✎</div></div></div>
            <div class="wo-intervals"><div class="wi wi-warmup" style="width:12px;height:35%"></div><div class="wi wi-work" style="width:115px;height:60%"></div><div class="wi wi-cool" style="width:10px;height:28%"></div></div>
            <div class="wo-tags"><span class="wo-tag tag-z2">z2</span><span class="wo-tag tag-long">long</span></div>
          </div>
          <div class="wo-card" draggable="true" data-type="run" data-id="r4" data-name="Tempo 3×15min" data-dur="65 min" ondragstart="libDragStart(event)" ondragend="libDragEnd(event)">
            <div class="wo-card-top"><div class="wo-type-dot run-dot"></div><div class="wo-name">Tempo 3×15min</div><div class="wo-duration">65 min</div><div class="wo-card-actions"><div class="wca-btn" onclick="openBuilder()">✎</div></div></div>
            <div class="wo-intervals"><div class="wi wi-warmup" style="width:16px;height:40%"></div><div class="wi wi-work" style="width:26px;height:82%"></div><div class="wi wi-rest" style="width:7px;height:28%"></div><div class="wi wi-work" style="width:26px;height:82%"></div><div class="wi wi-rest" style="width:7px;height:28%"></div><div class="wi wi-work" style="width:26px;height:82%"></div><div class="wi wi-cool" style="width:14px;height:34%"></div></div>
            <div class="wo-tags"><span class="wo-tag tag-threshold">threshold</span></div>
          </div>
          <div class="lib-section-lbl">Cycling</div>
          <div class="wo-card" draggable="true" data-type="bike" data-id="b1" data-name="Sweet Spot" data-dur="75 min" ondragstart="libDragStart(event)" ondragend="libDragEnd(event)">
            <div class="wo-card-top"><div class="wo-type-dot bike-dot"></div><div class="wo-name">Sweet Spot</div><div class="wo-duration">75 min</div><div class="wo-card-actions"><div class="wca-btn" onclick="openBuilder()">✎</div></div></div>
            <div class="wo-intervals"><div class="wi wi-warmup" style="width:14px;height:35%"></div><div class="wi wi-work" style="width:32px;height:85%"></div><div class="wi wi-rest" style="width:8px;height:30%"></div><div class="wi wi-work" style="width:32px;height:85%"></div><div class="wi wi-cool" style="width:14px;height:30%"></div></div>
            <div class="wo-tags"><span class="wo-tag tag-threshold">threshold</span></div>
          </div>
          <div class="wo-card" draggable="true" data-type="bike" data-id="b2" data-name="FTP Test" data-dur="60 min" ondragstart="libDragStart(event)" ondragend="libDragEnd(event)">
            <div class="wo-card-top"><div class="wo-type-dot bike-dot"></div><div class="wo-name">FTP Test</div><div class="wo-duration">60 min</div><div class="wo-card-actions"><div class="wca-btn" onclick="openBuilder()">✎</div></div></div>
            <div class="wo-intervals"><div class="wi wi-warmup" style="width:14px;height:40%"></div><div class="wi wi-work" style="width:8px;height:55%"></div><div class="wi wi-rest" style="width:8px;height:25%"></div><div class="wi wi-high" style="width:80px;height:100%"></div><div class="wi wi-cool" style="width:12px;height:32%"></div></div>
            <div class="wo-tags"><span class="wo-tag tag-race">test</span><span class="wo-tag tag-threshold">ftp</span></div>
          </div>
          <div class="lib-section-lbl">Swimming</div>
          <div class="wo-card" draggable="true" data-type="swim" data-id="s1" data-name="Endurance Swim" data-dur="45 min" ondragstart="libDragStart(event)" ondragend="libDragEnd(event)">
            <div class="wo-card-top"><div class="wo-type-dot swim-dot"></div><div class="wo-name">Endurance Swim</div><div class="wo-duration">45 min</div><div class="wo-card-actions"><div class="wca-btn" onclick="openBuilder()">✎</div></div></div>
            <div class="wo-intervals"><div class="wi wi-warmup" style="width:12px;height:35%"></div><div class="wi wi-work" style="width:90px;height:65%"></div><div class="wi wi-cool" style="width:10px;height:28%"></div></div>
            <div class="wo-tags"><span class="wo-tag tag-z2">z2</span><span class="wo-tag tag-long">endurance</span></div>
          </div>
          <button class="lib-add-btn" onclick="openBuilder()">+ New Workout</button>
        </div>
      </div>

      <!-- Right canvas: week-by-week drag-drop grid -->
      <div class="plan-canvas-area">
        <div class="canvas-header">
          <div style="flex:1">
            <input class="plan-name-input" value="20-Week Ironman 70.3 — Full Build" id="plan-name-input">
            <div class="plan-meta-row">20 WEEKS · 6 SESSIONS/WK · INTERMEDIATE · <span style="color:var(--g);font-weight:700">47 enrolled</span></div>
          </div>
          <div style="display:flex;gap:6px">
            <button class="btn btn-ghost btn-sm">Preview</button>
            <button class="btn btn-b btn-sm" onclick="showToast('Program assigned to selected athletes')">Assign Program</button>
          </div>
        </div>
        <div class="canvas-toolbar">
          <button class="tb-btn tb-primary" onclick="openBuilder()">+ New Workout</button>
          <button class="tb-btn" onclick="addWeek()">+ Add Week</button>
          <button class="tb-btn">⚡ Auto-Progress</button>
          <button class="tb-btn">📌 Anchor Race</button>
          <button class="tb-btn">🏷 Set Phase</button>
          <div class="phase-legend">
            <div class="ph-leg"><div class="ph-leg-dot" style="background:var(--g)"></div>Base</div>
            <div class="ph-leg"><div class="ph-leg-dot" style="background:var(--b)"></div>Build</div>
            <div class="ph-leg"><div class="ph-leg-dot" style="background:var(--a)"></div>Peak</div>
            <div class="ph-leg"><div class="ph-leg-dot" style="background:#7c3aed"></div>Taper</div>
          </div>
        </div>
        <div class="weeks-container" id="weeks-container"></div>
      </div>
    </div>
  </div>
</div>

<!-- ══ IMPORT MODAL ══ -->
<div class="strain-overlay" id="import-modal" style="display:none">
  <div class="strain-card" style="max-width:480px;width:100%">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
      <div style="font-size:18px;font-weight:800">Import Training Plans</div>
      <button class="bp-close" onclick="document.getElementById('import-modal').style.display='none'">✕</button>
    </div>
    <div style="display:grid;gap:10px">
      <div style="background:var(--sur3);border:1px solid var(--bd);border-radius:var(--rad);padding:16px 20px;cursor:pointer;display:flex;align-items:center;gap:14px" onclick="showToast('Connecting to TrainingPeaks…')">
        <div style="font-size:28px">📊</div>
        <div><div style="font-weight:700;margin-bottom:2px">TrainingPeaks</div><div style="font-size:12px;color:var(--t2)">Import plans and workout libraries. Athletes keep full history.</div></div>
        <div style="margin-left:auto;font-size:12px;color:var(--b);font-weight:600">Connect →</div>
      </div>
      <div style="background:var(--sur3);border:1px solid var(--bd);border-radius:var(--rad);padding:16px 20px;cursor:pointer;display:flex;align-items:center;gap:14px" onclick="showToast('Uploading .tcx file…')">
        <div style="font-size:28px">📁</div>
        <div><div style="font-weight:700;margin-bottom:2px">Upload File</div><div style="font-size:12px;color:var(--t2)">.tcx, .fit, .csv — drag and drop or browse</div></div>
        <div style="margin-left:auto;font-size:12px;color:var(--b);font-weight:600">Upload →</div>
      </div>
      <div style="background:var(--sur3);border:1px solid var(--bd);border-radius:var(--rad);padding:16px 20px;cursor:pointer;display:flex;align-items:center;gap:14px" onclick="showToast('Generating from Garmin Connect…')">
        <div style="font-size:28px">⌚</div>
        <div><div style="font-weight:700;margin-bottom:2px">Garmin Connect</div><div style="font-size:12px;color:var(--t2)">Pull workouts and structured plans directly.</div></div>
        <div style="margin-left:auto;font-size:12px;color:var(--b);font-weight:600">Sync →</div>
      </div>
    </div>
  </div>
</div>
<!-- ══════════════════════════════════════
     COACH: SETTINGS
══════════════════════════════════════ -->
<div class="screen" id="screen-business">
  <div class="ph"><div class="ph-row"><div><div class="ph-t">Business</div><div class="ph-s">Subscriptions, billing, and your coach profile.</div></div></div></div>

  <!-- Plan hero -->
  <div class="biz-hero">
    <div>
      <div class="biz-plan-badge">✓ Active Plan</div>
      <div class="biz-plan-name">Coreformance Pro Coach</div>
      <div class="biz-plan-sub">Up to 25 athletes · Cady Core eligible · Full platform access</div>
    </div>
    <div class="biz-plan-price">
      <div class="biz-price-amt">$129</div>
      <div class="biz-price-per">/month · Billed annually</div>
      <button class="btn btn-ghost btn-sm" style="margin-top:10px">Manage Plan</button>
    </div>
  </div>

  <!-- Revenue metrics -->
  <div class="biz-metrics">
    <div class="biz-m"><div class="biz-m-l">Active Athletes</div><div class="biz-m-v up">12</div><div class="biz-m-s muted">of 25 seats used</div></div>
    <div class="biz-m"><div class="biz-m-l">MRR</div><div class="biz-m-v up">$960</div><div class="biz-m-s up">↑ +2 athletes vs last month</div></div>
    <div class="biz-m"><div class="biz-m-l">Avg / Athlete</div><div class="biz-m-v">$80</div><div class="biz-m-s muted">/month average</div></div>
    <div class="biz-m"><div class="biz-m-l">Renewal Rate</div><div class="biz-m-v up">91%</div><div class="biz-m-s up">Last 12 months</div></div>
  </div>

  <div class="sdiv">Athlete Subscriptions</div>
  <div class="billing-table">
    <div class="bt-head"><div class="bth">Athlete</div><div class="bth">State</div><div class="bth">Plan</div><div class="bth">Amount</div><div class="bth">Expires</div><div class="bth">Status</div></div>
    <div class="bt-row"><div style="font-weight:600">Marcus Reid</div><div><span class="chip cg" style="font-size:9px">ACTIVATED</span></div><div class="muted mono" style="font-size:12px">Monthly</div><div class="up mono" style="font-size:12px">$80/mo</div><div class="muted mono" style="font-size:11px">Apr 9</div><div><span class="chip cg">Active</span></div></div>
    <div class="bt-row"><div style="font-weight:600">Sarah Chen</div><div><span class="chip cb" style="font-size:9px">INVITED</span></div><div class="muted mono" style="font-size:12px">Monthly</div><div class="up mono" style="font-size:12px">$80/mo</div><div class="muted mono" style="font-size:11px">Apr 30</div><div><span class="chip cg">Active</span></div></div>
    <div class="bt-row"><div style="font-weight:600">Derek Osei</div><div><span class="chip cg" style="font-size:9px">ACTIVATED</span></div><div class="muted mono" style="font-size:12px">Monthly</div><div class="up mono" style="font-size:12px">$80/mo</div><div class="muted mono" style="font-size:11px">May 15</div><div><span class="chip ca">At Risk</span></div></div>
    <div class="bt-row"><div style="font-weight:600">Aisha Lawson</div><div><span class="chip cb" style="font-size:9px">INVITED</span></div><div class="muted mono" style="font-size:12px">Annual</div><div class="up mono" style="font-size:12px">$720/yr</div><div class="muted mono" style="font-size:11px">Jan 2027</div><div><span class="chip cg">Active</span></div></div>
    <div style="padding:10px 18px;background:var(--sur2);border-top:1px solid var(--bd);font-family:'DM Mono',monospace;font-size:11px;color:var(--t4)">Showing 4 of 12 · <span style="color:var(--b);cursor:pointer">View all →</span></div>
  </div>

  <div class="sdiv">Key Insights</div>
  <div class="g2" style="margin-bottom:14px">
    <div class="card card-p"><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.12em;color:var(--a);margin-bottom:6px">⏰ EXPIRING SOON</div><div style="font-size:15px;font-weight:700;margin-bottom:5px">2 activation terms expire this season</div><div style="font-size:13px;color:var(--t2);line-height:1.6">Marcus Reid's term expires Apr 9 (47d). Consider sending a renewal key before term ends to maintain the relationship without interruption.</div><div style="margin-top:10px"><button class="btn btn-ghost btn-sm" onclick="go('invite')">Generate Renewal Key</button></div></div>
    <div class="card card-p"><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.12em;color:var(--g);margin-bottom:6px">↑ ROSTER HEALTH</div><div style="font-size:15px;font-weight:700;margin-bottom:5px">Activation model working well</div><div style="font-size:13px;color:var(--t2);line-height:1.6">7 of 12 athletes came through activation keys this season. 91% renewal rate among athletes who completed a full program term.</div><div style="margin-top:10px"><button class="btn btn-ghost btn-sm" onclick="go('roster')">View Roster Insights</button></div></div>
  </div>

  <!-- Cady Core status bar -->
  <div style="background:var(--gold1);border:1px solid var(--gold2);border-radius:var(--rad);padding:16px 20px;display:flex;align-items:center;justify-content:space-between">
    <div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><div class="cady-badge" style="padding:3px 10px"><span>✦</span> Cady Core</div><span style="font-size:11px;font-weight:600;color:var(--gold)">Profile Live</span></div>
      <div style="font-size:13px;color:var(--t2)">Your Cady Core profile is visible to athletes in Discover. 34 active athletes. 94% completion rate.</div>
    </div>
    <button class="btn btn-gold btn-sm" onclick="go('my-profile')">Edit Profile →</button>
  </div>
</div>

<!-- ══════════════════════════════════════
     COACH: MY PROFILE (Cady Core edit)
══════════════════════════════════════ -->
<div class="screen" id="screen-my-profile">
  <div class="ph"><div class="ph-row">
    <div><div class="ph-t">Coach Profile</div><div class="ph-s">Your Cady Core profile — visible to athletes in Discover.</div></div>
    <div style="display:flex;gap:8px"><div class="cady-badge"><span class="cady-badge-icon">✦</span> Cady Core</div><button class="btn btn-gold btn-sm" onclick="showToast('Profile saved')">Save Changes</button></div>
  </div></div>

  <!-- Live status banner -->
  <div style="background:var(--gold1);border:1px solid var(--gold2);border-radius:var(--rad);padding:14px 18px;margin-bottom:18px;display:flex;align-items:center;gap:14px">
    <div style="font-size:20px">✦</div>
    <div style="flex:1"><div style="font-weight:700;color:var(--gold);font-size:13px;margin-bottom:2px">Profile is Live</div><div style="font-size:12px;color:var(--t2)">Athletes can discover and enroll in your programs through the Discover tab. Last updated Feb 18.</div></div>
    <button class="btn btn-ghost btn-sm" onclick="setMode('athlete');setTimeout(()=>go('discover'),100)">Preview as athlete →</button>
  </div>

  <div class="g2" style="margin-bottom:18px">
    <!-- Identity card -->
    <div class="card card-p">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--t4);margin-bottom:12px">Identity</div>
      <div class="profile-form">
        <div class="pf-field"><div class="pf-label">Full Name</div><input class="pf-input" value="Jordan Taylor"></div>
        <div class="pf-field"><div class="pf-label">Specialty</div><input class="pf-input" value="Triathlon · Ironman Specialist"></div>
        <div class="pf-field"><div class="pf-label">Years Coaching</div><input class="pf-input" value="12"></div>
        <div class="pf-field"><div class="pf-label">Certifications</div><input class="pf-input" value="USAT Level 2, USAC, TrainingPeaks Certified"></div>
        <div class="pf-field full"><div class="pf-label">Bio</div><textarea class="pf-ta" rows="4">I coach working professionals who want to compete seriously without burning out. My methodology is rooted in aerobic base development, progressive overload, and intelligent recovery.</textarea></div>
      </div>
    </div>
    <!-- Programs & stats -->
    <div class="card card-p">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--t4);margin-bottom:12px">Programs on Profile</div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px">
        <div style="background:var(--sur3);border:1px solid var(--bd);border-radius:var(--rad-s);padding:9px 12px;display:flex;align-items:center;justify-content:space-between"><div><div style="font-size:12px;font-weight:700">20-Wk Ironman 70.3</div><div style="font-size:11px;color:var(--t4);font-family:'DM Mono',monospace">47 enrolled · $149/mo</div></div><button class="btn btn-ghost btn-sm">Edit</button></div>
        <div style="background:var(--sur3);border:1px solid var(--bd);border-radius:var(--rad-s);padding:9px 12px;display:flex;align-items:center;justify-content:space-between"><div><div style="font-size:12px;font-weight:700">16-Wk Olympic Tri</div><div style="font-size:11px;color:var(--t4);font-family:'DM Mono',monospace">31 enrolled · $99/mo</div></div><button class="btn btn-ghost btn-sm">Edit</button></div>
      </div>
      <button class="btn btn-ghost btn-sm" style="width:100%;justify-content:center" onclick="go('programs')">+ Add Program from Library</button>

      <div style="margin-top:18px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--t4);margin-bottom:10px">Profile Stats</div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <div style="display:flex;justify-content:space-between;font-size:13px"><span style="color:var(--t2)">Profile views (30d)</span><span class="mono" style="font-weight:600">847</span></div>
        <div style="display:flex;justify-content:space-between;font-size:13px"><span style="color:var(--t2)">Enrollment rate</span><span class="mono up" style="font-weight:600">12%</span></div>
        <div style="display:flex;justify-content:space-between;font-size:13px"><span style="color:var(--t2)">Athlete completion rate</span><span class="mono up" style="font-weight:600">91%</span></div>
        <div style="display:flex;justify-content:space-between;font-size:13px"><span style="color:var(--t2)">Cady Core rank</span><span class="mono" style="font-weight:600">#3 Triathlon</span></div>
      </div>
    </div>
  </div>
</div>
<!-- ═══════════════════════════════════════
     ATHLETE: SETTINGS
═══════════════════════════════════════ -->
<div class="screen" id="screen-settings">
  <div class="ph"><div class="ph-row"><div><div class="ph-t">Settings</div><div class="ph-s">Manage your profile, devices, and account.</div></div></div></div>
  <div id="settings-body"></div>

</div>
</div>

<!-- ═══════════════════════════════════════
     MODALS
═══════════════════════════════════════ -->

<!-- Activation key modal -->
<div class="modal-overlay" id="key-modal" onclick="if(event.target===this)closeModal()">
  <div class="modal-box" style="position:relative">
    <button class="modal-close" onclick="closeModal()">×</button>
    <div class="modal-title">Enter your coach key</div>
    <div class="modal-sub">Your coach should have sent you a key. It looks like CF—XXXX—XXXX.</div>
    <div class="key-input-wrap">
      <input class="key-input" id="key-input" placeholder="CF—XXXX—XXXX" oninput="formatKey(this)" maxlength="14">
      <button class="btn btn-dark" onclick="activateKey()">Activate</button>
    </div>
    <div style="font-size:12px;color:var(--t3)">No key yet? <button style="background:none;border:none;color:var(--b);cursor:pointer;font-size:12px;font-weight:600;padding:0;font-family:'Plus Jakarta Sans',sans-serif" onclick="closeModal();go('discover')">Browse coaches on Discover →</button></div>
  </div>
</div>

<!-- Divergence modal -->
<div class="div-modal" id="divergence-modal" onclick="if(event.target===this)closeDivergence()">
  <div class="div-box">
    <button class="modal-close" onclick="closeDivergence()">×</button>
    <div class="div-title">What happened?</div>
    <div class="div-sub">Tell the system so your plan can adapt correctly.</div>
    <div class="div-types">
      <div class="div-type" id="dt-recovery" onclick="divSelect('recovery')">
        <div class="dt-name">Recovery / fatigue</div>
        <div class="dt-desc">I'm more tired than expected. Need an easier day.</div>
      </div>
      <div class="div-type" id="dt-life" onclick="divSelect('life')">
        <div class="dt-name">Life / schedule conflict</div>
        <div class="dt-desc">Work, family, or schedule got in the way. Fitness is fine.</div>
      </div>
      <div class="div-type" id="dt-injury" onclick="divSelect('injury')">
        <div class="dt-name">Injury / soreness</div>
        <div class="dt-desc">Something doesn't feel right. Being cautious.</div>
      </div>
      <div class="div-type" id="dt-weather" onclick="divSelect('weather')">
        <div class="dt-name">Conditions / weather</div>
        <div class="dt-desc">External reason. Plan is still right — this was a one-off.</div>
      </div>
    </div>
    <div class="div-adapt-box" id="div-adapt-box"></div>
    <div class="div-footer">
      <button class="div-cancel" onclick="closeDivergence()">Cancel</button>
      <button class="div-apply" onclick="applyDivergence()">Apply adaptation →</button>
    </div>
  </div>
</div>

<!-- Plan generator modal -->
<div class="gen-modal" id="gen-modal" onclick="if(event.target===this)closePlanGenerator()">
  <div class="gen-box">
    <div class="gen-header">
      <div class="gen-title">Generate a training plan</div>
      <div class="gen-sub" id="gen-sub-txt">Answer 4 questions. Get a structured program.</div>
    </div>
    <div class="gen-body">
      <div class="gen-progress-bar"><div class="gen-progress-fill" id="gen-progress-fill" style="width:25%"></div></div>
      <div class="gen-step-label" id="gen-step-label">STEP 1 OF 4</div>
      <div id="gen-steps">
        <!-- Steps injected by JS -->
      </div>
    </div>
    <div class="gen-footer">
      <button class="gen-back" onclick="genBack()" id="gen-back-btn" style="opacity:0;pointer-events:none">← Back</button>
      <button class="gen-next" onclick="genNext()" id="gen-next-btn" disabled>Continue →</button>
    </div>
  </div>
</div>

<!-- Week review modal -->
<div class="modal-overlay" id="week-review-modal" onclick="if(event.target===this)closeWeekReview()">
  <div class="modal-box" style="max-width:560px;position:relative">
    <button class="modal-close" onclick="closeWeekReview()">×</button>
    <div class="modal-title">Week 10 — Next week preview</div>
    <div class="modal-sub" style="margin-bottom:16px">Auto-generated · Mar 2–8 · 9.8 hours total</div>
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--sur3);border-radius:8px">
        <span>🏊</span><div><div style="font-weight:700;font-size:13px">Easy Swim</div><div style="font-size:11px;color:var(--t3)">Mon · 45 min · Zone 2</div></div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--a1);border:1px solid var(--a2);border-radius:8px">
        <span>🚴</span><div><div style="font-weight:700;font-size:13px">VO2max Intervals ⚡ KEY</div><div style="font-size:11px;color:var(--t3)">Tue · 75 min · 110–120% FTP</div></div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--sur3);border-radius:8px">
        <span>—</span><div><div style="font-weight:600;font-size:13px;color:var(--t3)">Rest · Wed</div></div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--sur3);border-radius:8px">
        <span>🏃</span><div><div style="font-weight:700;font-size:13px">Tempo Run</div><div style="font-size:11px;color:var(--t3)">Thu · 55 min · Zone 3–4</div></div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--a1);border:1px solid var(--a2);border-radius:8px">
        <span>🏃</span><div><div style="font-weight:700;font-size:13px">Long Run ⚡ KEY</div><div style="font-size:11px;color:var(--t3)">Sat · 95 min · Zone 2</div></div>
      </div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost btn-sm" onclick="showToast('Week adjusted');closeWeekReview()">Adjust →</button>
      <button class="btn btn-dark btn-sm" style="flex:1;justify-content:center" onclick="showToast('Week 10 confirmed');closeWeekReview()">Looks good — confirm week</button>
    </div>
  </div>
</div>

<script>
/* ═══════════════════════════════════════
   STATE
═══════════════════════════════════════ */
var userRole = null;
var currentMode = 'athlete';
var obSelRole = null;
var obAthType = null;
var obSports = [];
var userName = 'Marcus';
var REL_STATE = 'self'; // self | activated | assigned-open | assigned-partial | assigned-full
var selectedDivType = null;
var genStep = 1;
var genAnswers = {};

/* ═══════════════════════════════════════
   NAV CONFIG
═══════════════════════════════════════ */
var athleteNav = [
  {id:'today',    icon:'📍', label:'Today'},
  {id:'week',     icon:'🗓️', label:'My Week'},
  {id:'progress', icon:'📈', label:'Progress'},
  {id:'discover', icon:'🔍', label:'Discover'},
  {id:'settings', icon:'⚙️', label:'Settings'},
];

/* Coach nav — for dedicated coaches only */
var coachNav = [
  { label:'Athletes', items:[
    {id:'roster',   icon:'👥', label:'All Athletes'},
    {id:'invite',   icon:'🔑', label:'Invite & Keys'},
  ]},
  { label:'Planning', items:[
    {id:'schedule', icon:'📅', label:'Schedule'},
    {id:'programs', icon:'📚', label:'Programs'},
  ]},
  { label:'Business', items:[
    {id:'my-profile', icon:'✦', label:'Coach Profile'},
    {id:'business',   icon:'💳', label:'Business'},
  ]},
];

/* Self-coached My Planning nav — scoped to self, no roster, no athlete management */
var selfPlanningNav = [
  { label:'My Plan', items:[
    {id:'week',     icon:'🗓️', label:'My Schedule'},
    {id:'programs', icon:'📚', label:'Programs & Builder'},
  ]},
  { label:'Account', items:[
    {id:'settings', icon:'⚙️', label:'Settings'},
  ]},
];

/* ═══════════════════════════════════════
   ONBOARDING
═══════════════════════════════════════ */
function obSelectRole(role, el) {
  obSelRole = role;
  document.querySelectorAll('#ob-s1 .ob-opt').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('ob-btn-1').disabled = false;
}
function obToggleSport(sport, el) {
  el.classList.toggle('selected');
  if (obSports.includes(sport)) obSports = obSports.filter(s=>s!==sport);
  else obSports.push(sport);
  document.getElementById('ob-btn-2b').disabled = obSports.length === 0;
}
function obSelAthType(type, el) {
  obAthType = type;
  document.querySelectorAll('.ob-ath-opt').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('ob-btn-2a').disabled = false;
  // Show team code input if team selected
  var codeWrap = document.getElementById('ob-team-code');
  if (codeWrap) codeWrap.style.display = (type === 'team') ? 'block' : 'none';
}
function obCheckName() {
  var v = document.getElementById('ob-name-input').value.trim();
  document.getElementById('ob-btn-3').disabled = v.length < 2;
}
function obNext(step) {
  if (step === 1) {
    document.getElementById('ob-s1').classList.remove('active');
    if (obSelRole === 'coach') {
      userRole = 'coach';
      document.getElementById('ob-s2-coach').classList.add('active');
    } else {
      userRole = 'athlete';
      document.getElementById('ob-s2-athlete').classList.add('active');
    }
  } else if (step === '2a' || step === '2b') {
    var s = step === '2a' ? 'ob-s2-athlete' : 'ob-s2-coach';
    document.getElementById(s).classList.remove('active');
    document.getElementById('ob-s3').classList.add('active');
  }
}
function obBack(from) {
  if (from === 2) {
    document.getElementById('ob-s2-athlete').classList.remove('active');
    document.getElementById('ob-s2-coach').classList.remove('active');
    document.getElementById('ob-s1').classList.add('active');
  } else if (from === 3) {
    document.getElementById('ob-s3').classList.remove('active');
    if (userRole === 'coach') document.getElementById('ob-s2-coach').classList.add('active');
    else document.getElementById('ob-s2-athlete').classList.add('active');
  }
}
function obFinish() {
  userName = document.getElementById('ob-name-input').value.trim() || 'Marcus';
  document.getElementById('onboard').style.display = 'none';
  document.getElementById('topbar').style.display = 'flex';
  document.getElementById('main-app').style.display = 'block';
  document.getElementById('sidebar').classList.add('visible');
  // Set state
  if (userRole === 'coach') {
    REL_STATE = 'self';
    setMode('coach');
  } else {
    if (obAthType === 'self')  REL_STATE = 'self';
    if (obAthType === 'key')   REL_STATE = 'self'; // will become 'activated' after key entry
    if (obAthType === 'team')  REL_STATE = 'assigned-partial';
    setMode('athlete');
  }
  updatePersonalization();
}

/* ═══════════════════════════════════════
   PERSONALIZATION
═══════════════════════════════════════ */
function updatePersonalization() {
  // Topbar
  document.getElementById('tb-ws-name').textContent = userName + (userRole==='coach' ? ' — Coach' : ' Reid');
  document.getElementById('tb-ws-sub').textContent =
    currentMode === 'coach'
      ? 'Coach View · 12 athletes'
      : REL_STATE === 'self'      ? 'Self-Coached · IM 70.3 · 47 days out'
      : REL_STATE === 'activated' ? 'Coached by Jordan Taylor · Week 8 of 20'
      : 'Team Program · Partial Autonomy';
  // Topbar readiness — only in athlete mode
  document.getElementById('tb-readiness').style.display = currentMode === 'athlete' ? 'flex' : 'none';
  // Greeting on today
  var h = new Date().getHours();
  var greet = h < 12 ? 'Good morning' : h < 17 ? 'Good afternoon' : 'Good evening';
  var el = document.getElementById('today-greeting');
  if (el) el.textContent = greet + ', ' + userName + '.';
  // Sidebar user info
  document.getElementById('sb-user-name').textContent = userName + (userRole==='coach' ? ' — Coach' : '');
  document.getElementById('sb-user-role').textContent = currentMode === 'coach' ? 'Coach' : 'Athlete';
  document.getElementById('sb-user-av').textContent = userName.charAt(0).toUpperCase() + 'R';
  document.getElementById('uavi').textContent = userName.charAt(0).toUpperCase() + 'R';
  // Coach label name
  var clabel = document.getElementById('sb-coach-label-name');
  if (clabel) clabel.textContent = userName + "\u2019s Roster";
  // Discover visibility — state-aware
  // Hide Discover from athlete nav when in active coaching relationship
  updateAthleteNav();
  // Change-coach link — show when activated
  var cc = document.getElementById('sb-change-coach');
  if (cc) cc.style.display = (REL_STATE === 'activated' || REL_STATE === 'assigned-partial' || REL_STATE === 'assigned-full') ? 'block' : 'none';
  // Mode switch label
  if (userRole === 'coach') {
    // Dedicated coach: hide the toggle, show role label only
    document.getElementById('sb-mode-switch').style.display = 'none';
    document.getElementById('sb-coach-label').style.display = 'block';
  } else if (REL_STATE === 'self') {
    document.getElementById('sb-mode-switch').style.display = 'block';
    document.getElementById('sb-coach-label').style.display = 'none';
    document.getElementById('sb-athlete-btn').textContent = 'My Training';
    document.getElementById('sb-coach-btn').textContent = 'My Planning';
    document.getElementById('sb-mode-ctx').textContent = 'Self-Coached';
  } else {
    document.getElementById('sb-mode-switch').style.display = 'none'; // coached athletes don't get coach mode
    document.getElementById('sb-coach-label').style.display = 'none';
  }
}

/* ═══════════════════════════════════════
   MODE SWITCH — THE WALL
═══════════════════════════════════════ */
function setMode(mode) {
  currentMode = mode;
  var isCoach = mode === 'coach';
  document.body.classList.toggle('coach-mode', isCoach);
  document.getElementById('sb-athlete-btn').classList.toggle('active', !isCoach);
  document.getElementById('sb-coach-btn').classList.toggle('active', isCoach);
  document.getElementById('uavi').className = 'uavi ' + (isCoach ? 'c' : 'a');
  buildSidebar();
  // Default screen depends on role AND mode
  if (!isCoach) {
    go('today');
  } else if (userRole === 'coach') {
    go('roster'); // dedicated coach lands on roster
  } else {
    go('programs'); // self-coached in My Planning lands on Programs (their own plan)
  }
  updatePersonalization();
}

/* ═══════════════════════════════════════
   SIDEBAR
═══════════════════════════════════════ */
/* ═══════════════════════════════════════
   STATE-AWARE NAV
═══════════════════════════════════════ */
function updateAthleteNav() {
  // Rebuild athlete nav filtering Discover if in active coaching relationship
  var hasCoach = (REL_STATE === 'activated' || REL_STATE === 'assigned-partial' || REL_STATE === 'assigned-full');
  athleteNav = [
    {id:'today',    icon:'📍', label:'Today'},
    {id:'week',     icon:'🗓️', label:'My Week'},
    {id:'progress', icon:'📈', label:'Progress'},
  ];
  if (!hasCoach) athleteNav.push({id:'discover', icon:'🔍', label:'Discover'});
  // Rebuild sidebar if in athlete mode
  if (currentMode === 'athlete') buildSidebar();
}

function buildSidebar() {
  var nav = document.getElementById('sb-nav');
  nav.innerHTML = '';

  // Determine which nav to render
  var isSelfPlanning = (currentMode === 'coach' && userRole !== 'coach');
  var isCoachMode = (currentMode === 'coach' && userRole === 'coach');

  var navConfig = isCoachMode ? coachNav : (isSelfPlanning ? selfPlanningNav : null);

  if (navConfig) {
    navConfig.forEach(function(grp) {
      var grpEl = document.createElement('div');
      grpEl.className = 'sb-group';
      var html = '';
      if (grp.label) html += '<span class="sb-group-lbl">' + grp.label + '</span>';
      grp.items.forEach(function(item) {
        html += '<button class="sb-item" id="sb-' + item.id + '" data-sid="' + item.id + '" data-hassubs="0" data-nonav="0" onclick="sbItemClick(this)">';
        html += '<span class="sb-icon">' + item.icon + '</span>';
        html += '<span>' + item.label + '</span>';
        html += '</button>';
      });
      grpEl.innerHTML = html;
      nav.appendChild(grpEl);
    });
  } else {
    // Athlete nav
    var grpEl = document.createElement('div');
    grpEl.className = 'sb-group';
    var html = '';
    athleteNav.forEach(function(item) {
      html += '<button class="sb-item" id="sb-' + item.id + '" data-sid="' + item.id + '" data-hassubs="0" data-nonav="0" onclick="sbItemClick(this)">';
      html += '<span class="sb-icon">' + item.icon + '</span>';
      html += '<span>' + item.label + '</span>';
      html += '</button>';
    });
    grpEl.innerHTML = html;
    nav.appendChild(grpEl);
  }
}

function sbItemClick(el) {
  var id = el.dataset.sid;
  var hasSubs = el.dataset.hassubs === '1';
  if (hasSubs) {
    var grp = el.closest('.sb-group');
    var wasOpen = grp.classList.contains('open');
    document.querySelectorAll('#sb-nav .sb-group').forEach(g => g.classList.remove('open'));
    if (!wasOpen) grp.classList.add('open');
    return;
  }
  go(id);
}

function setSidebarActive(id) {
  document.querySelectorAll('.sb-item, .sb-sub-item').forEach(b => b.classList.remove('active'));
  var btn = document.getElementById('sb-' + id);
  if (btn) btn.classList.add('active');
}

/* ═══════════════════════════════════════
   NAVIGATION
═══════════════════════════════════════ */
function go(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  var el = document.getElementById('screen-' + id);
  if (el) el.classList.add('active');
  setSidebarActive(id);
  if (id === 'programs') {
    var builderPanel = document.getElementById('prog-panel-builder');
    if (builderPanel && builderPanel.style.display !== 'none') buildWeekGrid();
  }
  if (id === 'settings') renderSettings();
  window.scrollTo({top:0, behavior:'smooth'});
}

/* ═══════════════════════════════════════
   WORKOUT CARDS
═══════════════════════════════════════ */
function togglePsc(id) {
  var el = document.getElementById('psc-' + id);
  if (!el) return;
  var wasOpen = el.classList.contains('open');
  document.querySelectorAll('.psc').forEach(p => p.classList.remove('open'));
  if (!wasOpen) el.classList.add('open');
}

function toggleStruct(e, id) {
  e.stopPropagation();
  var sv = document.getElementById('struct-' + id);
  var btn = document.getElementById('stbtn-' + id);
  if (!sv) return;
  var isShow = sv.classList.contains('show');
  sv.classList.toggle('show');
  if (btn) {
    btn.textContent = isShow ? 'Show structure' : 'Hide structure';
    btn.classList.toggle('hide', !isShow);
  }
}

function expandDay(day) {
  // Scroll to the card and open it
  togglePsc(day);
  var el = document.getElementById('psc-' + day);
  if (el) setTimeout(function() { el.scrollIntoView({behavior:'smooth', block:'center'}); }, 50);
}

function markDone() {
  var psc = document.getElementById('psc-today');
  if (psc) { psc.classList.add('done-l'); psc.classList.remove('key-l'); }
  // Show post-workout strain card
  document.getElementById('strain-overlay').classList.add('open');
}
function dismissStrain() {
  document.getElementById('strain-overlay').classList.remove('open');
  showToast('✓ Session logged. Great work.');
}
function openPreview(name, sub) {
  document.getElementById('preview-ath-name').textContent = name;
  document.getElementById('preview-ath-sub').textContent = sub;
  document.getElementById('preview-overlay').classList.add('open');
}
function closePreview() {
  document.getElementById('preview-overlay').classList.remove('open');
}
function obCheckTeamCode() {
  var v = document.getElementById('ob-team-input').value.trim();
  document.getElementById('ob-btn-2a').disabled = v.length < 4;
}

/* ═══════════════════════════════════════
   DIVERGENCE
═══════════════════════════════════════ */
var divAdaptMessages = {
  recovery: 'Replacing today\'s key session with an easy recovery workout. Key session moved to Saturday.',
  life:     'Session moved to Friday. Plan integrity preserved — no load change.',
  injury:   'Today\'s session removed. Easy active recovery added. Flagging for coach review.',
  weather:  'Session moved to Saturday. No plan adjustment — one-off skip.',
};
function showDivergence(e) {
  e.stopPropagation();
  selectedDivType = null;
  document.querySelectorAll('.div-type').forEach(d => d.classList.remove('selected'));
  document.getElementById('div-adapt-box').classList.remove('show');
  document.getElementById('divergence-modal').classList.add('open');
}
function closeDivergence() {
  document.getElementById('divergence-modal').classList.remove('open');
}
function divSelect(type) {
  selectedDivType = type;
  document.querySelectorAll('.div-type').forEach(d => d.classList.remove('selected'));
  document.getElementById('dt-' + type).classList.add('selected');
  var box = document.getElementById('div-adapt-box');
  box.innerHTML = '<strong>What happens next:</strong> ' + divAdaptMessages[type];
  box.classList.add('show');
}
function applyDivergence() {
  if (!selectedDivType) { showToast('Select a reason first'); return; }
  closeDivergence();
  showToast('Got it — plan adapting to ' + selectedDivType + ' signal');
}

/* ═══════════════════════════════════════
   PLAN GENERATOR
═══════════════════════════════════════ */
var genStepData = [
  {
    label: 'STEP 1 OF 4',
    q: 'What sport are you training for?',
    type: 'options',
    key: 'sport',
    opts: [
      {icon:'🚴', label:'Cycling', sub:'Road, gravel, or time trial'},
      {icon:'🏃', label:'Running', sub:'5K to marathon'},
      {icon:'🏊', label:'Swimming', sub:'Open water or pool'},
      {icon:'🏆', label:'Triathlon', sub:'Sprint to full Ironman'},
    ]
  },
  {
    label: 'STEP 2 OF 4',
    q: 'What\'s your training goal?',
    type: 'options',
    key: 'goal',
    opts: [
      {icon:'🎯', label:'Race preparation', sub:'I have a specific event date'},
      {icon:'📈', label:'Build fitness', sub:'General improvement, no race yet'},
      {icon:'🔁', label:'Maintain base', sub:'Keep fitness through off-season'},
    ]
  },
  {
    label: 'STEP 3 OF 4',
    q: 'How many hours can you train per week?',
    type: 'options',
    key: 'volume',
    opts: [
      {icon:'⏱️', label:'4–6 hours', sub:'3–4 sessions per week'},
      {icon:'⏱️', label:'6–9 hours', sub:'4–5 sessions per week'},
      {icon:'⏱️', label:'9–12 hours', sub:'5–6 sessions per week'},
      {icon:'⏱️', label:'12+ hours', sub:'6–7 sessions per week'},
    ]
  },
  {
    label: 'STEP 4 OF 4',
    q: 'When do you want to start?',
    type: 'input',
    key: 'startDate',
    placeholder: 'Target start date (or leave blank for next Monday)',
  },
];

function openPlanGenerator() {
  genStep = 1;
  genAnswers = {};
  renderGenStep();
  document.getElementById('gen-modal').classList.add('open');
}
function closePlanGenerator() {
  document.getElementById('gen-modal').classList.remove('open');
}
function renderGenStep() {
  var data = genStepData[genStep - 1];
  document.getElementById('gen-step-label').textContent = data.label;
  document.getElementById('gen-progress-fill').style.width = (genStep / genStepData.length * 100) + '%';
  document.getElementById('gen-back-btn').style.opacity = genStep > 1 ? '1' : '0';
  document.getElementById('gen-back-btn').style.pointerEvents = genStep > 1 ? 'auto' : 'none';
  var nextBtn = document.getElementById('gen-next-btn');
  nextBtn.textContent = genStep === genStepData.length ? 'Generate Plan →' : 'Continue →';
  nextBtn.disabled = !genAnswers[data.key];
  var stepsEl = document.getElementById('gen-steps');
  stepsEl.innerHTML = '<div style="font-size:17px;font-weight:700;color:var(--t1);margin-bottom:16px">' + data.q + '</div>';
  if (data.type === 'options') {
    var html = '<div class="gen-options">';
    data.opts.forEach(function(opt) {
      var sel = genAnswers[data.key] === opt.label ? ' selected' : '';
      html += '<div class="gen-opt' + sel + '" onclick="genSelect(\'' + data.key + '\',\'' + opt.label + '\',this)">';
      html += '<div class="gen-opt-icon">' + opt.icon + '</div>';
      html += '<div><div class="gen-opt-label">' + opt.label + '</div><div class="gen-opt-sub">' + opt.sub + '</div></div>';
      html += '</div>';
    });
    html += '</div>';
    stepsEl.innerHTML += html;
  } else {
    stepsEl.innerHTML += '<input class="gen-input" placeholder="' + data.placeholder + '" value="' + (genAnswers[data.key]||'') + '" oninput="genAnswers[\'' + data.key + '\']=this.value;document.getElementById(\'gen-next-btn\').disabled=false">';
  }
}
function genSelect(key, value, el) {
  genAnswers[key] = value;
  el.closest('.gen-options').querySelectorAll('.gen-opt').forEach(o => o.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('gen-next-btn').disabled = false;
}
function genNext() {
  if (genStep < genStepData.length) {
    genStep++;
    renderGenStep();
  } else {
    closePlanGenerator();
    showToast('✦ Generating your ' + (genAnswers.sport||'') + ' plan…');
  }
}
function genBack() {
  if (genStep > 1) { genStep--; renderGenStep(); }
}

/* ═══════════════════════════════════════
   SCHEDULE CALENDAR
═══════════════════════════════════════ */
var calMonths = ['January','February','March','April','May','June','July','August','September','October','November','December'];
var calMonthIdx = 1; // February
var calYear = 2026;
function schedChangeMonth(dir) {
  calMonthIdx += dir;
  if (calMonthIdx < 0)  { calMonthIdx = 11; calYear--; }
  if (calMonthIdx > 11) { calMonthIdx = 0; calYear++; }
  document.getElementById('sched-month-lbl').textContent = calMonths[calMonthIdx] + ' ' + calYear;
  showToast(calMonths[calMonthIdx] + ' ' + calYear);
}

/* ═══════════════════════════════════════
   PROGRAMS TABS
═══════════════════════════════════════ */
function progTab(panel, el) {
  document.querySelectorAll('.prog-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('prog-panel-library').style.display  = panel==='library'  ? 'block' : 'none';
  document.getElementById('prog-panel-programs').style.display = panel==='programs' ? 'block' : 'none';
  document.getElementById('prog-panel-builder').style.display  = panel==='builder'  ? 'block' : 'none';
  if (panel === 'builder') buildWeekGrid();
}

/* ═══════════════════════════════════════
   MODALS
═══════════════════════════════════════ */
function openModal() {
  document.getElementById('key-modal').classList.add('open');
}
function closeModal() {
  document.getElementById('key-modal').classList.remove('open');
}
function dfFilter(el) {
  el.classList.toggle('active');
}

/* ── SCHEDULE ── */
function schedFilterAth(el, name) {
  document.querySelectorAll('.caf-pill').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  showToast('Viewing: ' + name);
}

/* Day detail data */
var schedDayData = {
  'Feb 1':  [{ath:'Marcus Reid', wo:'Z2 Run', dur:'55 min', type:'run'}],
  'Feb 2':  [{ath:'Marcus Reid', wo:'Z2 Run', dur:'55 min', type:'run'},{ath:'Aisha Lawson', wo:'Z2 Ride', dur:'60 min', type:'bike'}],
  'Feb 3':  [{ath:'Marcus Reid', wo:'Tempo Intervals', dur:'65 min', type:'bike'}],
  'Feb 4':  [{ath:'Sarah Chen', wo:'Easy Run', dur:'45 min', type:'run'}],
  'Feb 5':  [{ath:'Aisha Lawson', wo:'Endurance Swim', dur:'45 min', type:'swim'}],
  'Feb 6':  [{ath:'Derek Osei', wo:'Threshold Bike', dur:'75 min', type:'bike'}],
  'Feb 7':  [{ath:'Marcus Reid', wo:'Long Run', dur:'90 min', type:'run'},{ath:'Aisha Lawson', wo:'Long Ride', dur:'90 min', type:'bike'}],
  'Feb 18': [{ath:'Marcus Reid', wo:'Threshold Run', dur:'60 min', type:'run'},{ath:'Sarah Chen', wo:'Aerobic Bike', dur:'60 min', type:'bike'}],
};

function schedCalDayClick(el, date) {
  document.querySelectorAll('.cal-day').forEach(d => d.classList.remove('cal-selected'));
  el.classList.add('cal-selected');
  var panel = document.getElementById('sched-day-panel');
  var dateEl = document.getElementById('sdp-date');
  var wosEl = document.getElementById('sdp-workouts');
  dateEl.textContent = date;
  var data = schedDayData[date] || [];
  if (data.length === 0) {
    wosEl.innerHTML = '<div style="font-size:12px;color:var(--t3);text-align:center;padding:10px 0">No workouts scheduled</div>';
  } else {
    var typeColors = {run:'var(--g)',bike:'var(--b)',swim:'#7c3aed',str:'var(--a)'};
    wosEl.innerHTML = data.map(function(w) {
      var col = typeColors[w.type] || 'var(--t3)';
      return '<div style="display:flex;border-radius:6px;overflow:hidden">'
        + '<div style="width:3px;background:' + col + ';flex-shrink:0"></div>'
        + '<div style="flex:1;padding:6px 8px;background:' + col.replace(')',',0.06)').replace('var(','rgba(').replace('--g','26,158,110').replace('--b','37,99,235') + '">'
        + '<div style="font-size:11px;font-weight:700;color:var(--t1)">' + w.ath + '</div>'
        + '<div style="font-size:10px;color:var(--t3);font-family:\'DM Mono\',monospace">' + w.wo + ' · ' + w.dur + '</div>'
        + '</div></div>';
    }).join('');
  }
  panel.style.display = 'block';
}

/* ── PROGRAMS ── */
function showImportModal() {
  document.getElementById('import-modal').style.display = 'flex';
}

function filterLib(el, type) {
  el.closest('.lib-filters').querySelectorAll('.lib-filter').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('#lib-body .wo-card').forEach(function(card) {
    card.style.display = (type === 'all' || card.dataset.type === type) ? '' : 'none';
  });
  // Also show/hide section labels
  document.querySelectorAll('#lib-body .lib-section-lbl').forEach(function(lbl) {
    var next = lbl.nextElementSibling;
    var anyVisible = false;
    while (next && next.classList.contains('wo-card')) {
      if (next.style.display !== 'none') anyVisible = true;
      next = next.nextElementSibling;
    }
    lbl.style.display = anyVisible ? '' : 'none';
  });
}

function renderSettings() {
  var body = document.getElementById('settings-body');
  if (!body) return;

  var name = userName || 'Athlete';
  var isSelf     = REL_STATE === 'self';
  var isActivated = REL_STATE === 'activated';
  var isTeam     = REL_STATE.indexOf('assigned') === 0;

  function row(label, sub, rightHtml) {
    return '<div class="settings-row"><div><div class="sr-label">' + label + '</div>'
      + '<div class="sr-sub">' + sub + '</div></div>' + rightHtml + '</div>';
  }
  function editBtn(msg) {
    return '<button class="btn btn-ghost btn-sm" onclick="showToast(\'' + msg + '\')">Edit</button>';
  }
  function chip(txt, cls) {
    return '<span class="chip ' + cls + '">' + txt + '</span>';
  }
  function ghostBtn(label, action) {
    return '<button class="btn btn-ghost btn-sm" onclick="' + action + '">' + label + '</button>';
  }

  // Coach row — varies by REL_STATE
  var coachRow = '';
  if (isSelf) {
    coachRow = row('Coach', 'No coach &mdash; self-coached',
      ghostBtn('Find a coach &rarr;', "go('discover')"));
  } else if (isActivated) {
    coachRow = row('Coach', 'Jordan Taylor &middot; USAT Level 2',
      ghostBtn('Message', "showToast('Message sent')"));
  } else if (isTeam) {
    coachRow = row('Team', 'Westlake XC &middot; Team program', chip('Team', 'cb'));
    coachRow += row('Training autonomy', 'How much you can modify your assigned plan',
      ghostBtn('View', "showToast('Contact your coach to adjust autonomy')"));
  }

  // Coach messages notification — only when coached
  var coachMsgRow = isSelf ? '' :
    row('Coach messages', 'Notify when your coach leaves a note', chip('On', 'cg'));

  body.innerHTML =
    '<div style="max-width:680px">' +
    '<div class="settings-section"><div class="ss-title">My Profile</div><div class="card">'
    + row('Name', name, editBtn('Edit name'))
    + row('Primary sport', 'Triathlon &middot; Ironman 70.3', editBtn('Edit sport'))
    + row('Goal race', 'IM 70.3 Santa Cruz &middot; Jun 7, 2026', editBtn('Edit goal'))
    + coachRow
    + '</div></div>'

    + '<div class="settings-section"><div class="ss-title">Devices &amp; Integrations</div><div class="card">'
    + row('WHOOP', 'Connected &middot; HRV, sleep, and strain', chip('Connected', 'cg'))
    + row('Garmin', 'Connected &middot; Activity sync on', chip('Connected', 'cg'))
    + row('Strava', 'Not connected', ghostBtn('Connect', "showToast('Connect Strava')"))
    + row('TrainingPeaks', 'Import workout history', ghostBtn('Import', "showImportModal()"))
    + '</div></div>'

    + '<div class="settings-section"><div class="ss-title">Notifications</div><div class="card">'
    + row('Daily workout reminder', 'Push notification at 7:00 AM', chip('On', 'cg'))
    + row('Readiness alert', 'Notify when readiness drops below 40', chip('On', 'cg'))
    + coachMsgRow
    + row('Weekly summary', 'Sunday recap of execution and adherence', chip('On', 'cg'))
    + '</div></div>'

    + '<div class="settings-section"><div class="ss-title">Account</div><div class="card">'
    + row('Subscription', 'Coreformance Athlete &middot; $29/mo &middot; Renews Apr 9',
        ghostBtn('Manage', "showToast('Manage subscription')"))
    + row('Data &amp; privacy', 'Download or delete your data',
        ghostBtn('Manage', "showToast('Data settings')"))
    + row('Sign out', 'You will need to sign back in',
        ghostBtn('Sign out', "showToast('Signed out')"))
    + '</div></div>' +
    '</div>';
}


function filterLibSearch(val) {
  var q = val.toLowerCase().trim();
  document.querySelectorAll('#lib-body .wo-card').forEach(function(card) {
    var name = (card.dataset.name || '').toLowerCase();
    card.style.display = (!q || name.includes(q)) ? '' : 'none';
  });
}

/* ── PROGRAM BUILDER DRAG-DROP ── */
/* ── DRAG DATA ── */
var dragData = null;

function libDragStart(e) {
  var card = e.target.closest ? e.target.closest('.wo-card') : e.currentTarget;
  if (!card) return;
  dragData = {src:'lib', id:card.dataset.id, name:card.dataset.name, type:card.dataset.type};
  e.dataTransfer.effectAllowed = 'copy';
  e.dataTransfer.setData('text/plain', card.dataset.id); // required for Firefox
  card.classList.add('dragging');
}

function libDragEnd(e) {
  document.querySelectorAll('.wo-card').forEach(function(c){ c.classList.remove('dragging'); });
  document.querySelectorAll('.placed-wo').forEach(function(c){ c.classList.remove('dragging'); });
}

function placedDragStart(e, wi, di) {
  var woId = planWeeks[wi].days[di];
  dragData = {src:'placed', wi:wi, di:di, id:woId};
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', woId || 'placed'); // required for Firefox
  e.currentTarget.classList.add('dragging');
}

function cellDragOver(e) {
  e.preventDefault();
  e.currentTarget.classList.add('drop-target');
  e.dataTransfer.dropEffect = dragData && dragData.src === 'placed' ? 'move' : 'copy';
}

function cellDragLeave(e) {
  e.currentTarget.classList.remove('drop-target');
}

function cellDrop(e, wi, di) {
  e.preventDefault();
  e.currentTarget.classList.remove('drop-target');
  if (!dragData) return;
  if (dragData.src === 'lib') {
    planWeeks[wi].days[di] = dragData.id;
  } else if (dragData.src === 'placed') {
    var prev = planWeeks[wi].days[di];
    planWeeks[wi].days[di] = dragData.id;
    planWeeks[dragData.wi].days[dragData.di] = prev;
  }
  buildWeekGrid();
  dragData = null;
}

function removeWo(wi, di) {
  planWeeks[wi].days[di] = null;
  buildWeekGrid();
}

/* ── WORKOUT LIBRARY DATA ── */
var workoutLib = {
  r1:{name:'Zone 2 Run',    dur:'55 min', type:'run',  tss:55, tag:'z2'},
  r2:{name:'5K Race Pace',  dur:'50 min', type:'run',  tss:70, tag:'race'},
  r3:{name:'Long Run',      dur:'90 min', type:'run',  tss:90, tag:'long'},
  r4:{name:'Tempo 3×15',   dur:'65 min', type:'run',  tss:82, tag:'threshold'},
  b1:{name:'Threshold Bike',dur:'70 min', type:'bike', tss:85, tag:'threshold'},
  b2:{name:'VO2 6×3min',   dur:'55 min', type:'bike', tss:80, tag:'vo2'},
  b3:{name:'Z2 Endurance', dur:'120 min',type:'bike', tss:95, tag:'z2'},
  s1:{name:'Aerobic Swim',  dur:'40 min', type:'swim', tss:45, tag:'aerobic'},
  s2:{name:'CSS Intervals', dur:'50 min', type:'swim', tss:60, tag:'threshold'},
};

var DAYS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

/* ── WEEK BUILDER ── */
var planWeeks = [
  /* BASE PHASE — Weeks 1-6 */
  {num:1,  phase:'base',  days:['r1','b1',null,'s1',null,'r3',null]},
  {num:2,  phase:'base',  days:['r1','b1',null,'s1','r4','r3',null]},
  {num:3,  phase:'base',  days:[null,'b1','r1','s1',null,'r3',null]},
  {num:4,  phase:'base',  days:['r1','b2',null,'s1',null,'r1',null]},
  {num:5,  phase:'base',  days:['r4','b1',null,'s1','r2','r3',null]},
  {num:6,  phase:'base',  days:['r1',null,null,'s1',null,'r1',null], note:'Recovery'},
  /* BUILD PHASE — Weeks 7-13 */
  {num:7,  phase:'build', days:['r4','b1',null,'s1','r2','r3',null]},
  {num:8,  phase:'build', days:['r4','b1','r1','s1','r2','r3',null]},
  {num:9,  phase:'build', days:['r4','b2',null,'s1','r2','r3',null]},
  {num:10, phase:'build', days:['r4','b1','r1','s1',null,'r3',null]},
  {num:11, phase:'build', days:['r4','b2','r1','s1','r2','r3',null]},
  {num:12, phase:'build', days:['r4','b2','r1','s1','r2','r3','b3']},
  {num:13, phase:'build', days:['r1','b1',null,'s1',null,'r1',null], note:'Recovery'},
  /* PEAK PHASE — Weeks 14-17 */
  {num:14, phase:'peak',  days:['r4','b2','r1','s1','r2','r3',null]},
  {num:15, phase:'peak',  days:['r4','b2','r1','s2','r2','r3','b3']},
  {num:16, phase:'peak',  days:['r4','b2','r1','s2','r2','r3','b3']},
  {num:17, phase:'peak',  days:['r1',null,null,'s1',null,'r1',null], note:'Recovery'},
  /* TAPER PHASE — Weeks 18-20 */
  {num:18, phase:'taper', days:['r4','b1',null,'s1','r2','r3',null]},
  {num:19, phase:'taper', days:['r1','b1',null,'s1',null,'r1',null]},
  {num:20, phase:'taper', days:['r1',null,null,'s1',null,null,null], note:'Race Week'},
];
var weekCount = 20;

function buildWeekGrid() {
  var container = document.getElementById('weeks-container');
  if (!container) return;
  container.innerHTML = '';
  var maxTss = Math.max.apply(null, planWeeks.map(function(w) { return calcWeekTss(w); }));
  planWeeks.forEach(function(wk, wi) {
    var weekTss = calcWeekTss(wk);
    var volPct = maxTss > 0 ? Math.round((weekTss / maxTss) * 100) : 0;
    var phaseLabel = wk.phase.charAt(0).toUpperCase() + wk.phase.slice(1);
    var noteTag = wk.note ? '<span class="wk-note-tag">' + wk.note + '</span>' : '';
    var block = document.createElement('div');
    block.className = 'week-block phase-' + wk.phase;
    var hdr = '<div class="week-header">'
      + '<div class="wk-stripe"></div>'
      + '<span class="wk-num">WK ' + wk.num + '</span>'
      + '<span class="wk-phase">' + phaseLabel + '</span>'
      + noteTag
      + '<span class="wk-load">' + weekTss + ' TSS</span>'
      + '<div class="wk-vol-bar"><div class="wk-vol-fill" style="width:' + volPct + '%"></div></div>'
      + '<div class="wk-actions">'
        + '<button class="wk-act" onclick="duplicateWeek(' + wi + ')">Duplicate</button>'
        + '<button class="wk-act" onclick="clearWeek(' + wi + ')">Clear</button>'
      + '</div>'
      + '</div>';
    var dayHeads = DAYS.map(function(d){ return '<div class="day-head">' + d + '</div>'; }).join('');
    var dayCells = DAYS.map(function(d, di) {
      var woId = wk.days[di];
      var cell = '<div class="day-cell" ondragover="cellDragOver(event)" ondragleave="cellDragLeave(event)" ondrop="cellDrop(event,' + wi + ',' + di + ')">';
      if (woId && workoutLib[woId]) {
        var wo = workoutLib[woId];
        cell += '<div class="placed-wo placed-' + wo.type + '" draggable="true"'
          + ' ondragstart="placedDragStart(event,' + wi + ',' + di + ')"'
          + ' ondragend="libDragEnd(event)">'
          + '<div class="placed-wo-stripe" style="pointer-events:none"></div>'
          + '<div class="placed-wo-body" style="pointer-events:none">'
            + '<div class="placed-wo-name">' + wo.name + '</div>'
            + '<div class="placed-wo-meta">' + wo.dur + '</div>'
          + '</div>'
          + '<div class="placed-wo-del" onclick="event.stopPropagation();removeWo(' + wi + ',' + di + ')">✕</div>'
          + '</div>';
      } else {
        cell += '<div class="empty-drop" style="pointer-events:none">—</div>';
      }
      cell += '</div>';
      return cell;
    }).join('');
    block.innerHTML = hdr + '<div class="week-days">' + dayHeads + dayCells + '</div>';
    container.appendChild(block);
  });
}

function calcWeekTss(wk) {
  return wk.days.reduce(function(sum, id) {
    return sum + (id && workoutLib[id] ? workoutLib[id].tss : 0);
  }, 0);
}


function addWeek() {
  var phases = ['base','base','base','build','build','build','build','peak','peak','taper'];
  var phase = phases[Math.min(planWeeks.length, phases.length-1)];
  planWeeks.push({num: planWeeks.length + 1, phase: phase, days:[null,null,null,null,null,null,null]});
  weekCount = planWeeks.length;
  buildWeekGrid();
}

function duplicateWeek(wi) {
  var copy = JSON.parse(JSON.stringify(planWeeks[wi]));
  copy.num = planWeeks.length + 1;
  delete copy.note;
  planWeeks.splice(wi + 1, 0, copy);
  planWeeks.forEach(function(w, i){ w.num = i + 1; });
  weekCount = planWeeks.length;
  buildWeekGrid();
}

function clearWeek(wi) {
  planWeeks[wi].days = [null,null,null,null,null,null,null];
  buildWeekGrid();
}

function openBuilder() {
  document.getElementById('builder-overlay').classList.add('open');
  initIntervalTrack();
}

function closeBuilder() {
  document.getElementById('builder-overlay').classList.remove('open');
}

function saveWorkout() {
  showToast('Workout saved to library');
  closeBuilder();
}

var selectedBlock = null;
var intervalBlocks = [
  {type:'warmup', dur:10, h:35},
  {type:'work', dur:20, h:75},
  {type:'rest', dur:5, h:28},
  {type:'work', dur:20, h:75},
  {type:'cool', dur:10, h:30}
];

function initIntervalTrack() {
  renderIntervalTrack();
}

function renderIntervalTrack() {
  var track = document.getElementById('int-track');
  if (!track) return;
  track.innerHTML = '';
  intervalBlocks.forEach(function(blk, i) {
    var el = document.createElement('div');
    el.className = 'int-block int-' + blk.type + (selectedBlock === i ? ' selected' : '');
    el.style.width = (blk.dur * 2 + 8) + 'px';
    el.style.height = blk.h + '%';
    el.onclick = (function(idx){ return function(){ selectBlock(idx); }; })(i);
    track.appendChild(el);
  });
  var sum = document.getElementById('int-summary');
  if (sum) {
    var total = intervalBlocks.reduce(function(a,b){ return a + b.dur; }, 0);
    sum.innerHTML = '<strong>' + total + ' min total</strong> &nbsp; ' + intervalBlocks.length + ' blocks';
  }
}

function selectBlock(i) {
  selectedBlock = i;
  var blk = intervalBlocks[i];
  var det = document.getElementById('int-detail');
  if (det) {
    det.classList.add('show');
    var lbl = document.getElementById('int-det-lbl');
    if (lbl) lbl.textContent = blk.type.charAt(0).toUpperCase() + blk.type.slice(1);
    var durInput = document.getElementById('tgt-dur');
    if (durInput) durInput.value = blk.dur;
  }
  renderIntervalTrack();
}

function addBlock(type) {
  var defaults = {warmup:{dur:10,h:35}, work:{dur:20,h:75}, rest:{dur:5,h:28}, hard:{dur:8,h:100}, cool:{dur:10,h:30}};
  intervalBlocks.push(Object.assign({type:type}, defaults[type] || {dur:10,h:50}));
  renderIntervalTrack();
}

function removeSelectedBlock() {
  if (selectedBlock !== null) {
    intervalBlocks.splice(selectedBlock, 1);
    selectedBlock = null;
    document.getElementById('int-detail').classList.remove('show');
    renderIntervalTrack();
  }
}

function selectSportOpt(el) {
  document.querySelectorAll('.sport-opt').forEach(o => o.classList.remove('selected'));
  el.classList.add('selected');
}

function toggleTag(el) {
  el.style.opacity = el.style.opacity === '1' || el.style.opacity === '' ? '0.4' : '1';
}

function openWeekReview() {
  document.getElementById('week-review-modal').classList.add('open');
}
function closeWeekReview() {
  document.getElementById('week-review-modal').classList.remove('open');
}

/* ═══════════════════════════════════════
   KEY INPUT
═══════════════════════════════════════ */
function formatKey(el) {
  var v = el.value.replace(/[^A-Za-z0-9]/g,'').toUpperCase().slice(0,8);
  var out = 'CF—';
  if (v.length > 4) out += v.slice(0,4) + '—' + v.slice(4);
  else out += v;
  el.value = out;
}
function activateKey() {
  var val = document.getElementById('key-input').value;
  if (val.length < 8) { showToast('Enter a full key — CF—XXXX—XXXX'); return; }
  REL_STATE = 'activated';
  closeModal();
  updatePersonalization();
  showToast('Key activated — Jordan Taylor · 20-Week IM 70.3');
}

/* ═══════════════════════════════════════
   TOAST
═══════════════════════════════════════ */
function showToast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2800);
}

/* ═══════════════════════════════════════
   INIT
═══════════════════════════════════════ */
// Keyboard shortcut: Escape closes modals
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeModal(); closeDivergence(); closePlanGenerator(); closeWeekReview(); closeBuilder();
  }
});
setTimeout(buildWeekGrid, 200);

</script>

<!-- ══════════════════════════════════════
     WORKOUT BUILDER OVERLAY (right panel)
══════════════════════════════════════ -->
<div class="builder-overlay" id="builder-overlay">
  <div class="builder-panel">
    <div class="bp-header">
      <div class="bp-title">New Workout</div>
      <button class="bp-close" onclick="closeBuilder()">✕</button>
    </div>
    <div class="bp-body">
      <div class="bp-section">
        <div class="bp-label">Workout Name</div>
        <input class="bp-input" id="bp-name" placeholder="e.g. 3×12 Threshold Bike" style="font-weight:700;font-size:14px">
      </div>
      <div class="bp-section">
        <div class="bp-label">Sport</div>
        <div class="sport-select" id="sport-select">
          <div class="sport-opt selected" onclick="selectSportOpt(this)"><div class="sport-opt-icon">🏃</div><div class="sport-opt-lbl">Run</div></div>
          <div class="sport-opt" onclick="selectSportOpt(this)"><div class="sport-opt-icon">🚴</div><div class="sport-opt-lbl">Bike</div></div>
          <div class="sport-opt" onclick="selectSportOpt(this)"><div class="sport-opt-icon">🏊</div><div class="sport-opt-lbl">Swim</div></div>
          <div class="sport-opt" onclick="selectSportOpt(this)"><div class="sport-opt-icon">💪</div><div class="sport-opt-lbl">Strength</div></div>
        </div>
      </div>
      <div class="bp-section">
        <div class="bp-row">
          <div><div class="bp-label">Total Duration</div><input class="bp-input" placeholder="60 min" value="60"></div>
          <div><div class="bp-label">Primary Zone</div>
            <select class="bp-input"><option>Zone 1 — Recovery</option><option>Zone 2 — Aerobic</option><option selected>Zone 3 — Tempo</option><option>Zone 4 — Threshold</option><option>Zone 5 — VO2</option></select>
          </div>
        </div>
      </div>
      <div class="bp-section">
        <div class="bp-label" style="display:flex;justify-content:space-between"><span>Interval Structure</span><span style="font-size:9px;color:var(--t4);font-weight:400;text-transform:none;letter-spacing:0">Click block to edit</span></div>
        <div class="interval-canvas">
          <div class="interval-track" id="int-track"></div>
          <div class="int-add-bar">
            <button class="int-add-btn" onclick="addBlock('warmup')">+ Warmup</button>
            <button class="int-add-btn" onclick="addBlock('work')">+ Work</button>
            <button class="int-add-btn" onclick="addBlock('rest')">+ Rest</button>
            <button class="int-add-btn" onclick="addBlock('hard')">+ Hard</button>
            <button class="int-add-btn" onclick="addBlock('cool')">+ Cooldown</button>
          </div>
          <div class="int-detail" id="int-detail">
            <div class="bp-label" id="int-det-lbl">Warmup</div>
            <div class="target-grid">
              <div class="target-box"><div class="tgt-lbl">Power</div><input class="tgt-input" id="tgt-power" placeholder="—" value="55-75%"></div>
              <div class="target-box"><div class="tgt-lbl">HR Zone</div><input class="tgt-input" id="tgt-hr" placeholder="—" value="Z1-Z2"></div>
              <div class="target-box"><div class="tgt-lbl">Pace</div><input class="tgt-input" id="tgt-pace" placeholder="—" value="Easy"></div>
            </div>
            <div style="margin-top:7px;display:flex;align-items:center;gap:8px">
              <div><div class="bp-label" style="margin-bottom:4px">Duration (min)</div><input class="bp-input" id="tgt-dur" value="10" style="width:68px"></div>
              <button class="int-add-btn" style="color:var(--r);border-color:var(--r2);margin-top:18px" onclick="removeSelectedBlock()">Remove</button>
            </div>
          </div>
          <div class="int-summary" id="int-summary"></div>
        </div>
      </div>
      <div class="bp-section">
        <div class="bp-label">Coach Notes</div>
        <textarea class="bp-input" rows="2" placeholder="Key instructions or context for this workout…" style="resize:none;line-height:1.6"></textarea>
      </div>
      <div class="bp-section">
        <div class="bp-label">Tags</div>
        <div style="display:flex;gap:4px;flex-wrap:wrap">
          <span class="wo-tag tag-threshold" style="padding:3px 9px;cursor:pointer;border-radius:20px;font-size:10px" onclick="toggleTag(this)">threshold ✓</span>
          <span class="wo-tag tag-z2" style="padding:3px 9px;cursor:pointer;border-radius:20px;font-size:10px;opacity:.4" onclick="toggleTag(this)">z2</span>
          <span class="wo-tag tag-vo2" style="padding:3px 9px;cursor:pointer;border-radius:20px;font-size:10px;opacity:.4" onclick="toggleTag(this)">vo2</span>
          <span class="wo-tag tag-long" style="padding:3px 9px;cursor:pointer;border-radius:20px;font-size:10px;opacity:.4" onclick="toggleTag(this)">long</span>
          <span class="wo-tag tag-race" style="padding:3px 9px;cursor:pointer;border-radius:20px;font-size:10px;opacity:.4" onclick="toggleTag(this)">race-pace</span>
        </div>
      </div>
    </div>
    <div class="bp-footer">
      <button class="btn btn-ghost btn-sm" onclick="closeBuilder()">Cancel</button>
      <button class="btn btn-b btn-sm" onclick="saveWorkout()">Save to Library →</button>
    </div>
  </div>
</div>
</body>
</html>
